var GAL=function(config){config=config||{};GAL.superclass.constructor.call(this,config);};Ext.extend(GAL,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},view:{}});Ext.reg('gallery',GAL);GAL=new GAL();GAL.window.CreateAlbum=function(config){config=config||{};this.ident=config.ident||'gcalb'+Ext.id();Ext.applyIf(config,{title:_('gallery.album_create'),id:this.ident,width:600,url:GAL.config.connector_url,action:'mgr/album/create',fields:[{xtype:'hidden',name:'parent'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:config.record['parent']==0?'hidden':'statictextfield',fieldLabel:_('gallery.parent'),name:'parent_name',id:this.ident+'-parent-name',anchor:'100%'},{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'}]},{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('gallery.year'),name:'year',anchor:'100%',allowBlank:true},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.active_desc'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.prominent'),description:MODx.expandHelp?'':_('gallery.prominent_desc'),name:'prominent',id:this.ident+'-prominent',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-prominent',text:_('gallery.prominent_desc'),cls:'desc-under'}]}]}]});GAL.window.CreateAlbum.superclass.constructor.call(this,config);};Ext.extend(GAL.window.CreateAlbum,MODx.Window);Ext.reg('gal-window-album-create',GAL.window.CreateAlbum);GAL.window.UpdateItem=function(config){config=config||{};this.ident=config.ident||'gupdit'+Ext.id();Ext.applyIf(config,{title:_('gallery.item_update'),id:this.ident,closeAction:'close',width:600,url:GAL.config.connector_url,action:'mgr/item/update',fileUpload:true,fields:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'},{xtype:'textfield',fieldLabel:_('gallery.item_url'),description:MODx.expandHelp?'':_('gallery.item_url_desc'),name:'url',id:this.ident+'-item-url',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-item-url',text:_('gallery.item_url_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'hidden',name:'thumbnail'},{xtype:'hidden',name:'image'},{html:'',id:this.ident+'-preview'},{xtype:'statictextfield',name:'id',fieldLabel:_('id'),submitValue:true,anchor:'100%'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]}]});GAL.window.UpdateItem.superclass.constructor.call(this,config);this.on('activate',function(w,e){if(typeof Tiny!='undefined'){MODx.loadRTE(this.ident+'-description');}
var d=this.fp.getForm().getValues();if(d&&d.image){var p=Ext.getCmp(this.ident+'-preview');var u=d.image+'&h=200&w=200&zc=1&q=100&f=png';p.update('<div class="gal-item-update-preview"><img src="'+u+'" alt="" onclick="Ext.getCmp(\'gal-album-items-view\').showScreenshot(\''+d.id+'\'); return false;" /></div>');}},this);};Ext.extend(GAL.window.UpdateItem,MODx.Window);Ext.reg('gal-window-item-update',GAL.window.UpdateItem);GAL.window.UploadItem=function(config){config=config||{};this.ident=config.ident||'gupit'+Ext.id();Ext.applyIf(config,{title:_('gallery.item_upload'),id:this.ident,width:600,url:GAL.config.connector_url,action:'mgr/item/upload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,cls:(MODx.config.connector_url)?'':'main-wrapper',labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'},{xtype:'textfield',fieldLabel:_('gallery.item_url'),description:_('gallery.item_url_desc'),name:'url',id:this.ident+'-item-url',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-item-url',text:_('gallery.item_url_desc'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.file'),description:MODx.expandHelp?'':_('gallery.item_upload_file_desc'),name:'file',id:this.ident+'-file',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-file',text:_('gallery.item_upload_file_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),name:'active',description:'',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]}]});GAL.window.UploadItem.superclass.constructor.call(this,config);this.on('activate',function(){if(typeof Tiny!='undefined'){MODx.loadRTE(this.ident+'-description');}});};Ext.extend(GAL.window.UploadItem,MODx.Window);Ext.reg('gal-window-item-upload',GAL.window.UploadItem);GAL.window.UploadCover=function(config){config=config||{};this.ident=config.ident||'gupit'+Ext.id();Ext.applyIf(config,{title:_('gallery.cover_upload'),id:this.ident,height:300,saveBtnText:_('gallery.upload_cover'),url:GAL.config.connector_url,action:'mgr/album/uploadcover',fileUpload:true,fields:[{xtype:'hidden',name:'albumid'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',border:false,cls:(MODx.config.connector_url)?'':'main-wrapper',labelSeparator:''},items:[{columnWidth:1,items:[{xtype:'hidden',name:'id'},{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.file'),description:MODx.expandHelp?'':_('gallery.item_upload_file_desc'),name:'file',id:this.ident+'-file',anchor:'100%'},{xtype:'panel',fieldLabel:_('gallery.current_cover'),html:'',id:this.ident+'-preview'}]}]}]});GAL.window.UploadCover.superclass.constructor.call(this,config);};Ext.extend(GAL.window.UploadCover,MODx.Window);Ext.reg('gal-window-cover-update',GAL.window.UploadCover);GAL.window.UploadMultiItems=function(config){config=config||{};this.ident=config.ident||'gupmuit'+Ext.id();Ext.applyIf(config,{title:_('gallery.multi_item_upload'),id:this.ident,height:350,fields:[{xtype:'hidden',name:'album'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'checkbox',boxLabel:_('gallery.active'),hideLabel:true,name:'active',description:'',id:this.ident+'-active',checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]},{html:'<div id="file-upload" />'+_('gallery.loading_ellipsis')+'</div>',id:'file-upload-field',xtype:'panel'}],buttons:[{text:_('done'),scope:this,handler:function(){this.hide();}}],keys:[]});GAL.window.UploadMultiItems.superclass.constructor.call(this,config);this.on('show',this.setup,this)};Ext.extend(GAL.window.UploadMultiItems,MODx.Window,{setup:function(){if(typeof GAL.uploader=='undefined'){GAL.uploader=new qq.FileUploader({element:document.getElementById('file-upload'),action:GAL.config.connector_url,params:{action:'mgr/item/ajaxupload',album:this.config.album,HTTP_MODAUTH:MODx.siteId},onComplete:function(){GAL.uploader.win.fireEvent('success');},onSubmit:function(){var f=GAL.uploader.win.fp.getForm();var data={active:f.findField('active').getValue()?1:0,tags:f.findField('tags').getValue()};var p=this.params;Ext.apply(p,data);GAL.uploader.setParams(p);}});GAL.uploader.win=this;}}});Ext.reg('gal-window-multi-item-upload',GAL.window.UploadMultiItems);GAL.window.BatchUpload=function(config){config=config||{};this.ident=config.ident||'gupbu'+Ext.id();Ext.applyIf(config,{title:_('gallery.batch_upload'),id:this.ident,url:GAL.config.connector_url,action:'mgr/item/batchupload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{xtype:'textfield',fieldLabel:_('gallery.directory'),description:MODx.expandHelp?'':_('gallery.batch_upload_intro'),name:'directory',id:this.ident+'-directory',anchor:'100%',value:MODx.config['gallery.default_batch_upload_path']||'{assets_path}images/'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-directory',text:_('gallery.batch_upload_intro'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.batch_upload_tags'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.batch_upload_tags'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]});GAL.window.BatchUpload.superclass.constructor.call(this,config);};Ext.extend(GAL.window.BatchUpload,MODx.Window);Ext.reg('gal-window-batch-upload',GAL.window.BatchUpload);GAL.window.ZipUpload=function(config){config=config||{};this.ident=config.ident||'gupbu'+Ext.id();Ext.applyIf(config,{title:_('gallery.zip_upload'),id:this.ident,url:GAL.config.connector_url,action:'mgr/item/zipupload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.zip_file'),description:MODx.expandHelp?'':_('gallery.zip_upload_intro'),name:'zip',id:this.ident+'-zip',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-zip',text:_('gallery.zip_upload_intro'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.batch_upload_tags'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.batch_upload_tags'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]});GAL.window.ZipUpload.superclass.constructor.call(this,config);};Ext.extend(GAL.window.ZipUpload,MODx.Window);Ext.reg('gal-window-zip-upload',GAL.window.ZipUpload);;var galTreeHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gal-tree-handler'});galTreeHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galTreeHandlerClass,Ext.Component,{tree:null,data:{},windows:{},getMenu:function(t,node,e){this.tree=t;this.data=node.attributes&&node.attributes.data?node.attributes.data:{};var m=[];switch(node.attributes.type){case'root':m=this.getRootMenu(node,e);break;case'gallery-album':m=this.getAlbumMenu(node,e);break;case'gallery-item':m=this.getItemMenu(node,e);break;}
return m;},getItemMenu:function(node,e){return[{text:_('gallery.item_update'),handler:this.updateItem,scope:this},'-',{text:_('gallery.item_remove'),handler:this.removeItem,scope:this}];},getAlbumMenu:function(node,e){return[{text:_('gallery.album_create'),handler:this.createAlbum,scope:this},'-',{text:_('gallery.album_update'),handler:this.updateAlbum,scope:this},{text:_('gallery.upload'),menu:{items:[{text:_('gallery.item_upload'),handler:this.uploadItem,scope:this},{text:_('gallery.multi_item_upload'),handler:this.uploadMultiItems,scope:this},{text:_('gallery.batch_upload'),handler:this.batchUpload,scope:this},{text:_('gallery.zip_upload'),handler:this.zipUpload,scope:this}]}},'-',{text:_('gallery.album_remove'),handler:this.removeAlbum,scope:this}];},getRootMenu:function(node,e){return[{text:_('gallery.album_create'),handler:this.createAlbum,scope:this}];},createAlbum:function(btn,e){var r;if(this.data.id){var n=this.tree.cm.activeNode.attributes.data;r={'parent':n.id,parent_name:n.name};}else{r={'parent':0,parent_name:_('none')};}
if(!this.windows.createAlbum){this.windows.createAlbum=MODx.load({xtype:'gal-window-album-create',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.createAlbum.fp.getForm().reset();this.windows.createAlbum.setValues(r);this.windows.createAlbum.show(e.target);},updateAlbum:function(btn,e){var id=this.data.id?this.data.id:0;location.href='?a='+MODx.action['gallery:index']+'&album='+id+'&action=album/update';},removeAlbum:function(btn,e){MODx.msg.confirm({text:_('gallery.album_remove_confirm'),url:GAL.config.connector_url,params:{action:'mgr/album/remove',id:this.tree.cm.activeNode.attributes.data.id},listeners:{'success':{fn:function(r){this.tree.refreshParentNode();},scope:this}}});},updateItem:function(btn,e){this.windows.updateItem=MODx.load({xtype:'gal-window-item-update',listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});this.windows.updateItem.setValues(this.data);this.windows.updateItem.show(e.target);},removeItem:function(btn,e){MODx.msg.confirm({text:_('gallery.item_delete_confirm'),url:GAL.config.connector_url,params:{action:'mgr/item/remove',id:this.data.id},listeners:{'success':{fn:function(r){this.tree.refreshParentNode();},scope:this}}});},uploadMultiItems:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.uploadMultiItems){this.windows.uploadMultiItems=MODx.load({xtype:'gal-window-multi-item-upload',album:this.data.id,record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.uploadMultiItems.fp.getForm().reset();this.windows.uploadMultiItems.setValues(r);this.windows.uploadMultiItems.show(e.target);},uploadItem:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.uploadItem){this.windows.uploadItem=MODx.load({xtype:'gal-window-item-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.uploadItem.fp.getForm().reset();this.windows.uploadItem.setValues(r);this.windows.uploadItem.show(e.target);},batchUpload:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.batchUpload){this.windows.batchUpload=MODx.load({xtype:'gal-window-batch-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}else{this.windows.batchUpload.fp.getForm().reset();}
this.windows.batchUpload.setValues(r);this.windows.batchUpload.show(e.target);},zipUpload:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.zipUpload){this.windows.zipUpload=MODx.load({xtype:'gal-window-zip-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}else{this.windows.zipUpload.fp.getForm().reset();}
this.windows.zipUpload.setValues(r);this.windows.zipUpload.show(e.target);},handleDrop:function(t,dropEvent){this.tree=t;var dropNode=dropEvent.dropNode;var target=dropEvent.target;if(!target.attributes.type)return false;if(target.attributes.type=='gallery-album'&&dropNode.attributes.type=='gallery-item'&&dropEvent.point!='append')return false;if(dropNode.attributes.type=='gallery-album'&&target.attributes.type=='gallery-item')return false;return true;}});Ext.reg('gal-tree-handler',galTreeHandlerClass);var galTreeHandler=new galTreeHandlerClass();var galItemDropHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gallery-item-drop-handler'});galItemDropHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galItemDropHandlerClass,Ext.Component,{handle:function(target,opt){var na=target.node.attributes;var cfg={ddTargetEl:opt.ddTargetEl,cfg:opt.cfg,iframe:opt.cfg.iframe,iframeEl:opt.cfg.iframeEl,onInsert:opt.cfg.onInsert,panel:opt.cfg.panel,classKey:'modSnippet',pk:GAL.snippetGalleryItem,name:'GalleryItem'};GAL.elProps={id:na.data.id};MODx.loadInsertElement(cfg);setTimeout("galTreeWorkaround(GAL.elProps);",600);return true;}});var galItemDropHandler=new galItemDropHandlerClass();var galAlbumDropHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gallery-album-drop-handler'});galAlbumDropHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galAlbumDropHandlerClass,Ext.Component,{handle:function(target,opt){var na=target.node.attributes;var cfg={ddTargetEl:opt.ddTargetEl,cfg:opt.cfg,iframe:opt.cfg.iframe,iframeEl:opt.cfg.iframeEl,onInsert:opt.cfg.onInsert,panel:opt.cfg.panel,classKey:'modSnippet',pk:GAL.snippetGallery,name:'Gallery'};GAL.elProps={album:na.data.id};MODx.loadInsertElement(cfg);setTimeout("galTreeWorkaround(GAL.elProps);",600);return true;}});var galAlbumDropHandler=new galAlbumDropHandlerClass();function galTreeWorkaround(props){var w=Ext.getCmp('modx-window-insert-element');w.modps=[];if(w){for(var k in props){var fld=Ext.getCmp('modx-iprop-'+k);if(fld){fld.setValue(props[k]);w.changeProp(k);}}}};setTimeout('galleryFixLeafDrag();',1200);function galleryFixLeafDrag(){var t=Ext.getCmp('modx-file-tree');if(t){t.on('startdrag',function(t,n,e){if(n.attributes.type=='gallery-album'){n.attributes.leaf=true;}},this);}};MODx.grid.AccessContext=function(config){config=config||{};Ext.applyIf(config,{id:'modx-grid-access-context',url:MODx.config.connector_url,baseParams:{action:'security/access/getList',type:config.type||'modAccessContext',target:config.context_key},fields:['id','target','target_name','principal_class','principal','principal_name','authority','policy','policy_name','cls'],type:'modAccessContext',paging:true,columns:[{header:_('context'),dataIndex:'target_name',width:100},{header:_('user_group'),dataIndex:'principal_name',width:120},{header:_('authority'),dataIndex:'authority',width:50},{header:_('policy'),dataIndex:'policy_name',width:175}],tbar:[{text:_('acl_add'),cls:'primary-button',scope:this,handler:this.createAcl}]});MODx.grid.AccessContext.superclass.constructor.call(this,config);};Ext.extend(MODx.grid.AccessContext,MODx.grid.Grid,{combos:{},windows:{},getMenu:function(){var r=this.getSelectionModel().getSelected();var p=r.data.cls;var m=[];if(this.getSelectionModel().getCount()>1){}else{if(p.indexOf('pedit')!=-1){m.push({text:_('edit'),handler:this.editAcl});}
if(p.indexOf('premove')!=-1){if(m.length>0){m.push('-');}
m.push({text:_('remove'),handler:this.removeAcl});}}
if(m.length>0){this.addContextMenuItem(m);}},createAcl:function(itm,e){var r={target:this.config.context_key,principal_class:'modUserGroup'};if(!this.windows.create_acl){this.windows.create_acl=MODx.load({xtype:'modx-window-access-context-create',record:r,listeners:{'success':{fn:function(o){this.refresh();},scope:this}}});}
this.windows.create_acl.fp.getForm().reset();this.windows.create_acl.setValues(r);this.windows.create_acl.show(e.target);},editAcl:function(itm,e){var r=this.menu.record;Ext.applyIf(r,{context:r.target,user_group:r.principal});if(!this.windows.update_acl){this.windows.update_acl=MODx.load({xtype:'modx-window-access-context-update',acl:r.id,record:r,listeners:{'success':{fn:this.refresh,scope:this}}});}
this.windows.update_acl.setValues(r);this.windows.update_acl.show(e.target);},removeAcl:function(itm,e){MODx.msg.confirm({title:_('ugc_remove'),text:_('access_confirm_remove'),url:this.config.url,params:{action:'security/access/removeAcl',id:this.menu.record.id,type:this.config.type||'modAccessContext'},listeners:{'success':{fn:this.refresh,scope:this}}});}});Ext.reg('modx-grid-access-context',MODx.grid.AccessContext);MODx.window.CreateAccessContext=function(config){config=config||{};var r=config.record;Ext.applyIf(config,{title:_('ugc_mutate'),url:MODx.config.connector_url,baseParams:{action:'security/access/addAcl',type:config.type||'modAccessContext'},type:'modAccessContext',acl:0,fields:[{xtype:'hidden',name:'id',value:r.id||''},{xtype:'hidden',name:'target',value:r.context||''},{xtype:'hidden',name:'principal_class',value:'modUserGroup'},{xtype:'modx-combo-usergroup',fieldLabel:_('user_group'),name:'principal',hiddenName:'principal',anchor:'100%',value:r.principal||'',baseParams:{action:'security/group/getList',combo:true}},{xtype:'modx-combo-policy',fieldLabel:_('policy'),name:'policy',hiddenName:'policy',value:r.policy||'',anchor:'100%'},{xtype:'textfield',fieldLabel:_('authority'),name:'authority',anchor:'100%',value:r.authority||''}]});MODx.window.CreateAccessContext.superclass.constructor.call(this,config);};Ext.extend(MODx.window.CreateAccessContext,MODx.Window);Ext.reg('modx-window-access-context-create',MODx.window.CreateAccessContext);MODx.window.UpdateAccessContext=function(config){config=config||{};var r=config.record;this.ident=config.ident||'uactx'+Ext.id();Ext.applyIf(config,{title:_('ugc_mutate'),baseParams:{action:'security/access/updateAcl',type:config.type||'modAccessContext'}});MODx.window.UpdateAccessContext.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateAccessContext,MODx.window.CreateAccessContext);Ext.reg('modx-window-access-context-update',MODx.window.UpdateAccessContext);;MODx.grid.SettingsGrid=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="desc">{description_trans}</p>')});if(!config.tbar){config.tbar=[{text:_('setting_create'),scope:this,cls:'primary-button',handler:{xtype:'modx-window-setting-create',url:config.url||MODx.config.connector_url,blankValues:true}}];}
config.tbar.push('->',{xtype:'modx-combo-namespace',name:'namespace',id:'modx-filter-namespace',emptyText:_('namespace_filter'),value:MODx.request['ns']?MODx.request['ns']:'core',allowBlank:true,editable:true,typeAhead:true,forceSelection:true,queryParam:'search',width:150,listeners:{'select':{fn:this.filterByNamespace,scope:this}}},{xtype:'modx-combo-area',name:'area',id:'modx-filter-area',emptyText:_('area_filter'),value:MODx.request['area'],baseParams:{action:'system/settings/getAreas',namespace:MODx.request['ns']?MODx.request['ns']:'core'},width:250,allowBlank:true,editable:true,typeAhead:true,forceSelection:true,listeners:{'select':{fn:this.filterByArea,scope:this}}},{xtype:'textfield',name:'filter_key',id:'modx-filter-key',cls:'x-form-filter',emptyText:_('search_by_key')+'...',listeners:{'change':{fn:this.filterByKey,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:this.blur,scope:cmp});},scope:this}}},{xtype:'button',id:'modx-filter-clear',cls:'x-form-filter-clear',text:_('filter_clear'),listeners:{'click':{fn:this.clearFilter,scope:this}}});this.cm=new Ext.grid.ColumnModel({columns:[this.exp,{header:_('name'),dataIndex:'name_trans',sortable:true,editable:false,width:175},{header:_('key'),dataIndex:'key',sortable:true,editable:false,width:150},{header:_('value'),dataIndex:'value',sortable:true,editable:true,renderer:this.renderDynField.createDelegate(this,[this],true),width:260},{header:_('last_modified'),dataIndex:'editedon',sortable:true,editable:false,renderer:this.renderLastModDate.createDelegate(this,[this],true),width:100},{header:_('area'),dataIndex:'area_text',sortable:true,hidden:true,editable:false}],getCellEditor:function(colIndex,rowIndex){var field=this.getDataIndex(colIndex);if(field=='value'){var rec=config.store.getAt(rowIndex);var xt={xtype:'textfield'};if(rec){xt.xtype=rec.get('xtype');if(xt=='text-password'){xt.xtype='textfield';xt.inputType='password';}}
var o=MODx.load(xt);return new Ext.grid.GridEditor(o);}
return Ext.grid.ColumnModel.prototype.getCellEditor.call(this,colIndex,rowIndex);}});Ext.applyIf(config,{cm:this.cm,fields:['key','name','value','description','xtype','namespace','area','area_text','editedon','oldkey','menu','name_trans','description_trans'],url:MODx.config.connector_url,baseParams:{action:'system/settings/getList',namespace:MODx.request['ns']?MODx.request['ns']:'core',area:MODx.request['area']},clicksToEdit:2,grouping:true,groupBy:'area_text',singleText:_('setting'),pluralText:_('settings'),sortBy:'key',plugins:this.exp,primaryKey:'key',autosave:true,save_action:'system/settings/updatefromgrid',pageSize:MODx.config.default_per_page>30?MODx.config.default_per_page:30,paging:true,collapseFirst:false,tools:[{id:'plus',qtip:_('expand_all'),handler:this.expandAll,scope:this},{id:'minus',hidden:true,qtip:_('collapse_all'),handler:this.collapseAll,scope:this}]});this.view=new Ext.grid.GroupingView({emptyText:config.emptyText||_('ext_emptymsg'),forceFit:true,autoFill:true,showPreview:true,enableRowBody:true,scrollOffset:0});MODx.grid.SettingsGrid.superclass.constructor.call(this,config);};Ext.extend(MODx.grid.SettingsGrid,MODx.grid.Grid,{_addEnterKeyHandler:function(){this.getEl().addKeyListener(Ext.EventObject.ENTER,function(){this.fireEvent('change');},this);},_showMenu:function(g,ri,e){e.stopEvent();e.preventDefault();this.menu.record=this.getStore().getAt(ri).data;if(!this.getSelectionModel().isSelected(ri)){this.getSelectionModel().selectRow(ri);}
this.menu.removeAll();var m=[];if(this.menu.record.menu){m=this.menu.record.menu;}else{m.push({text:_('setting_update'),handler:this.updateSetting},'-',{text:_('setting_remove'),handler:this.removeSetting});}
if(m.length>0){this.addContextMenuItem(m);this.menu.showAt(e.xy);}},removeSetting:function(){return this.remove('setting_remove_confirm','system/settings/remove');},updateSetting:function(btn,e){var r=this.menu.record;r.fk=Ext.isDefined(this.config.fk)?this.config.fk:0;var uss=MODx.load({xtype:'modx-window-setting-update',record:r,grid:this,listeners:{'success':{fn:function(r){this.refresh();},scope:this}}});uss.reset();uss.setValues(r);uss.show(e.target);},clearFilter:function(){var ns=MODx.request['ns']?MODx.request['ns']:'core';var area=MODx.request['area']?MODx.request['area']:'';this.getStore().baseParams=this.initialConfig.baseParams;var acb=Ext.getCmp('modx-filter-area');if(acb){acb.store.baseParams['namespace']=ns;acb.store.load();acb.reset();}
Ext.getCmp('modx-filter-namespace').reset();Ext.getCmp('modx-filter-key').reset();this.getStore().baseParams.namespace=ns;this.getStore().baseParams.area=area;this.getStore().baseParams.key='';this.getBottomToolbar().changePage(1);this.refresh();},filterByKey:function(tf,newValue,oldValue){this.getStore().baseParams.key=newValue;this.getStore().baseParams.namespace='';this.getBottomToolbar().changePage(1);this.refresh();return true;},filterByNamespace:function(cb,rec,ri){this.getStore().baseParams['namespace']=rec.data['name'];this.getStore().baseParams['area']='';this.getBottomToolbar().changePage(1);this.refresh();var acb=Ext.getCmp('modx-filter-area');if(acb){var s=acb.store;s.baseParams['namespace']=rec.data.name;s.removeAll();s.load();acb.setValue('');}},filterByArea:function(cb,rec,ri){this.getStore().baseParams['area']=rec.data['v'];this.getBottomToolbar().changePage(1);this.refresh();},renderDynField:function(v,md,rec,ri,ci,s,g){var r=s.getAt(ri).data;v=Ext.util.Format.htmlEncode(v);var f;if(r.xtype=='combo-boolean'||r.xtype=='modx-combo-boolean'){f=MODx.grid.Grid.prototype.rendYesNo;return f(v,md,rec,ri,ci,s,g);}else if(r.xtype==='datefield'){f=Ext.util.Format.dateRenderer(MODx.config.manager_date_format);return f(v,md,rec,ri,ci,s,g);}else if(r.xtype==='text-password'||r.xtype=='modx-text-password'){f=MODx.grid.Grid.prototype.rendPassword;return f(v,md,rec,ri,ci,s,g);}else if(r.xtype.substr(0,5)=='combo'||r.xtype.substr(0,10)=='modx-combo'){var cm=g.getColumnModel();var ed=cm.getCellEditor(ci,ri);if(!ed){var o=Ext.ComponentMgr.create({xtype:r.xtype||'textfield'});ed=new Ext.grid.GridEditor(o);cm.setEditor(ci,ed);}
if(ed.store&&!ed.store.isLoaded&&ed.config.mode!='local'){ed.store.load();ed.store.isLoaded=true;}
f=Ext.util.Format.comboRenderer(ed.field,v);return f(v,md,rec,ri,ci,s,g);}
return v;},renderLastModDate:function(value){if(Ext.isEmpty(value)){return'—';}
return value;}});Ext.reg('modx-grid-settings',MODx.grid.SettingsGrid);MODx.combo.Area=function(config){config=config||{};Ext.applyIf(config,{name:'area',hiddenName:'area',displayField:'d',valueField:'v',fields:['d','v'],url:MODx.config.connector_url,baseParams:{action:'system/settings/getAreas'}});MODx.combo.Area.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.Area,MODx.combo.ComboBox);Ext.reg('modx-combo-area',MODx.combo.Area);MODx.window.CreateSetting=function(config){config=config||{};Ext.applyIf(config,{title:_('setting_create'),width:600,url:config.url,action:'system/settings/create',fields:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false},items:[{columnWidth:.5,items:[{xtype:'hidden',name:'fk',id:'modx-cs-fk',value:config.fk||0},{xtype:'textfield',fieldLabel:_('key'),name:'key',id:'modx-cs-key',maxLength:100,anchor:'100%'},{xtype:'label',forId:'modx-cs-key',html:_('key_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('name'),name:'name',id:'modx-cs-name',anchor:'100%'},{xtype:'label',forId:'modx-cs-name',html:_('name_desc'),cls:'desc-under'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:'modx-cs-description',allowBlank:true,anchor:'100%'},{xtype:'label',forId:'modx-cs-description',html:_('description_desc'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'modx-combo-xtype-spec',fieldLabel:_('xtype'),description:MODx.expandHelp?'':_('xtype_desc'),id:'modx-cs-xtype',anchor:'100%'},{xtype:'label',forId:'modx-cs-xtype',html:_('xtype_desc'),cls:'desc-under'},{xtype:'modx-combo-namespace',fieldLabel:_('namespace'),name:'namespace',id:'modx-cs-namespace',value:'core',anchor:'100%'},{xtype:'label',forId:'modx-cs-namespace',html:_('namespace_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('area_lexicon_string'),description:_('area_lexicon_string_msg'),name:'area',id:'modx-cs-area',anchor:'100%'},{xtype:'label',forId:'modx-cs-area',html:_('area_lexicon_string_msg'),cls:'desc-under'}]}]},{xtype:'textarea',fieldLabel:_('value'),name:'value',id:'modx-cs-value',anchor:'100%'}],keys:[]});MODx.window.CreateSetting.superclass.constructor.call(this,config);this.on('show',function(){this.reset();this.setValues({namespace:Ext.getCmp('modx-filter-namespace').value,area:Ext.getCmp('modx-filter-area').value});},this);};Ext.extend(MODx.window.CreateSetting,MODx.Window);Ext.reg('modx-window-setting-create',MODx.window.CreateSetting);MODx.combo.xType=function(config){config=config||{};Ext.applyIf(config,{store:new Ext.data.SimpleStore({fields:['d','v'],data:[[_('textfield'),'textfield'],[_('textarea'),'textarea'],[_('yesno'),'combo-boolean'],[_('password'),'text-password'],[_('category'),'modx-combo-category'],[_('charset'),'modx-combo-charset'],[_('country'),'modx-combo-country'],[_('context'),'modx-combo-context'],[_('namespace'),'modx-combo-namespace'],[_('template'),'modx-combo-template'],[_('user'),'modx-combo-user'],[_('usergroup'),'modx-combo-usergroup'],[_('language'),'modx-combo-language'],[_('source'),'modx-combo-source'],[_('setting_manager_theme'),'modx-combo-manager-theme']]}),displayField:'d',valueField:'v',mode:'local',name:'xtype',hiddenName:'xtype',triggerAction:'all',editable:false,selectOnFocus:false,value:'textfield'});MODx.combo.xType.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.xType,Ext.form.ComboBox);Ext.reg('modx-combo-xtype-spec',MODx.combo.xType);MODx.window.UpdateSetting=function(config){config=config||{};this.ident=config.ident||'modx-uss-'+Ext.id();Ext.applyIf(config,{title:_('setting_update'),width:600,url:config.grid.config.url,action:'system/settings/update',fields:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false},items:[{columnWidth:.5,items:[{xtype:'hidden',name:'fk',id:'modx-'+this.ident+'-fk',value:config.fk||0},{xtype:'statictextfield',fieldLabel:_('key'),description:MODx.expandHelp?'':_('key_desc'),name:'key',id:'modx-'+this.ident+'-key',maxLength:100,submitValue:true,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-key',html:_('key_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('name'),description:MODx.expandHelp?'':_('name_desc'),name:'name',id:'modx-'+this.ident+'-name',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-name',html:_('name_desc'),cls:'desc-under'},{xtype:'textarea',fieldLabel:_('description'),description:MODx.expandHelp?'':_('description_desc'),name:'description',id:'modx-'+this.ident+'-description',allowBlank:true,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-description',html:_('description_desc'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'modx-combo-xtype-spec',fieldLabel:_('xtype'),description:MODx.expandHelp?'':_('xtype_desc'),id:'modx-'+this.ident+'-xtype',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-xtype',html:_('xtype_desc'),cls:'desc-under'},{xtype:'modx-combo-namespace',fieldLabel:_('namespace'),description:MODx.expandHelp?'':_('namespace_desc'),name:'namespace',id:'modx-'+this.ident+'-namespace',value:'core',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-namespace',html:_('namespace_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('area_lexicon_string'),description:MODx.expandHelp?'':_('area_lexicon_string_msg'),name:'area',id:'modx-'+this.ident+'-area',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-area',html:_('area_lexicon_string_msg'),cls:'desc-under'}]}]},{xtype:config.record?config.record.xtype:'textarea',fieldLabel:_('value'),name:'value',hiddenName:'value',id:'modx-'+this.ident+'-value',anchor:'100%'}],keys:[]});MODx.window.UpdateSetting.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateSetting,MODx.Window);Ext.reg('modx-window-setting-update',MODx.window.UpdateSetting);;MODx.grid.ContextSettings=function(config){config=config||{};Ext.applyIf(config,{title:_('context_settings'),id:'modx-grid-context-settings',url:MODx.config.connector_url,baseParams:{action:'context/setting/getList',context_key:config.context_key},saveParams:{context_key:config.context_key},fk:config.context_key,autosave:false,tbar:[{text:_('create_new'),scope:this,cls:'primary-button',handler:{xtype:'modx-window-setting-create',url:MODx.config.connector_url,baseParams:{action:'context/setting/create'},fk:config.context_key}}]});MODx.grid.ContextSettings.superclass.constructor.call(this,config);};Ext.extend(MODx.grid.ContextSettings,MODx.grid.SettingsGrid,{removeSetting:function(){return this.remove('setting_remove_confirm','context/setting/remove');},updateSetting:function(btn,e){var r=this.menu.record;r.fk=Ext.isDefined(this.config.fk)?this.config.fk:0;var uss=MODx.load({xtype:'modx-window-setting-update',action:'context/setting/update',record:r,grid:this,listeners:{'success':{fn:function(r){this.refresh();},scope:this}}});uss.reset();uss.setValues(r);uss.show(e.target);}});Ext.reg('modx-grid-context-settings',MODx.grid.ContextSettings);MODx.window.UpdateContextSetting=function(config){config=config||{};var r=config.record;Ext.applyIf(config,{title:_('setting_update'),action:'context/setting/update',fk:r.context_key});MODx.window.UpdateContextSetting.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateContextSetting,MODx.window.UpdateSetting);Ext.reg('modx-window-context-setting-update',MODx.window.UpdateContextSetting);;MODx.panel.Context=function(config){config=config||{};Ext.applyIf(config,{url:MODx.config.connector_url,baseParams:{action:'context/get'},id:'modx-panel-context',cls:'container',class_key:'modContext',plugin:'',bodyStyle:'',items:[{html:'<h2>'+_('context')+': '+config.context+'</h2>',border:false,id:'modx-context-name',cls:'modx-page-header'},MODx.getPageStructure([{title:_('general_information'),autoHeight:true,layout:'form',defaults:{border:false,msgTarget:'side'},items:[{xtype:'panel',border:false,cls:'main-wrapper',layout:'form',items:[{xtype:'statictextfield',fieldLabel:_('key'),name:'key',width:300,maxLength:100,enableKeyEvents:true,allowBlank:true,value:config.context,submitValue:true},{xtype:'textfield',fieldLabel:_('name'),name:'name',width:300,maxLength:255},{xtype:'textarea',fieldLabel:_('description'),name:'description',width:300,grow:true},{html:MODx.onContextFormRender,border:false}]}]},{title:_('context_settings'),autoHeight:true,layout:'form',items:[{html:'<p>'+_('context_settings_desc')+'</p>',id:'modx-context-settings-desc',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-context-settings',cls:'main-wrapper',title:'',preventRender:true,context_key:config.context,listeners:{'afteredit':{fn:function(){this.markDirty();},scope:this}}}]},{title:_('access_permissions'),autoHeight:true,items:[{xtype:'modx-grid-access-context',cls:'main-wrapper',title:'',preventRender:true,context_key:config.context,listeners:{'afteredit':{fn:function(){this.markDirty();},scope:this}}}]}],{id:'modx-context-tabs'})],useLoadingMask:true,listeners:{'setup':{fn:this.setup,scope:this},'success':{fn:this.success,scope:this},'beforeSubmit':{fn:this.beforeSubmit,scope:this}}});MODx.panel.Context.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.Context,MODx.FormPanel,{initialized:false,setup:function(){if(this.initialized||(this.config.context===''||this.config.context===0)){this.fireEvent('ready');return false;}
MODx.Ajax.request({url:this.config.url,params:{action:'context/get',key:this.config.context},listeners:{'success':{fn:function(r){this.getForm().setValues(r.object);var el=Ext.getCmp('modx-context-name');if(el){el.getEl().update('<h2>'+_('context')+': '+r.object.key+'</h2>');}
this.fireEvent('ready');MODx.fireEvent('ready');this.initialized=true;},scope:this}}});},beforeSubmit:function(o){var r={};var g=Ext.getCmp('modx-grid-context-settings');if(g){r.settings=g.encodeModified();}
Ext.apply(o.form.baseParams,r);},success:function(o){var g=Ext.getCmp('modx-grid-context-settings');if(g){g.getStore().commitChanges();}
var t=parent.Ext.getCmp('modx-resource-tree');if(t){t.refresh();}}});Ext.reg('modx-panel-context',MODx.panel.Context);;MODx.page.UpdateContext=function(config){config=config||{};Ext.applyIf(config,{formpanel:'modx-panel-context',actions:{'new':'context/create',edit:'context/update','delete':'context/delete',cancel:'context/view'},buttons:[{process:'context/update',text:_('save'),id:'modx-abtn-save',cls:'primary-button',method:'remote',keys:[{key:MODx.config.keymap_save||"s",ctrl:true}]},{process:'cancel',text:_('cancel'),id:'modx-abtn-cancel',params:{a:'context'}},{text:_('help_ex'),id:'modx-abtn-help',handler:MODx.loadHelpPane}],components:[{xtype:'modx-panel-context',context:MODx.request.key}]});MODx.page.UpdateContext.superclass.constructor.call(this,config);};Ext.extend(MODx.page.UpdateContext,MODx.Component);Ext.reg('modx-page-context-update',MODx.page.UpdateContext);