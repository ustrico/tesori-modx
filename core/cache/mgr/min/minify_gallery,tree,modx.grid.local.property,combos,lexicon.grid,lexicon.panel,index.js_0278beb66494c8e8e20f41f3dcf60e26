var GAL=function(config){config=config||{};GAL.superclass.constructor.call(this,config);};Ext.extend(GAL,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},view:{}});Ext.reg('gallery',GAL);GAL=new GAL();GAL.window.CreateAlbum=function(config){config=config||{};this.ident=config.ident||'gcalb'+Ext.id();Ext.applyIf(config,{title:_('gallery.album_create'),id:this.ident,width:600,url:GAL.config.connector_url,action:'mgr/album/create',fields:[{xtype:'hidden',name:'parent'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:config.record['parent']==0?'hidden':'statictextfield',fieldLabel:_('gallery.parent'),name:'parent_name',id:this.ident+'-parent-name',anchor:'100%'},{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'}]},{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('gallery.year'),name:'year',anchor:'100%',allowBlank:true},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.active_desc'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.prominent'),description:MODx.expandHelp?'':_('gallery.prominent_desc'),name:'prominent',id:this.ident+'-prominent',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-prominent',text:_('gallery.prominent_desc'),cls:'desc-under'}]}]}]});GAL.window.CreateAlbum.superclass.constructor.call(this,config);};Ext.extend(GAL.window.CreateAlbum,MODx.Window);Ext.reg('gal-window-album-create',GAL.window.CreateAlbum);GAL.window.UpdateItem=function(config){config=config||{};this.ident=config.ident||'gupdit'+Ext.id();Ext.applyIf(config,{title:_('gallery.item_update'),id:this.ident,closeAction:'close',width:600,url:GAL.config.connector_url,action:'mgr/item/update',fileUpload:true,fields:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'},{xtype:'textfield',fieldLabel:_('gallery.item_url'),description:MODx.expandHelp?'':_('gallery.item_url_desc'),name:'url',id:this.ident+'-item-url',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-item-url',text:_('gallery.item_url_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'hidden',name:'thumbnail'},{xtype:'hidden',name:'image'},{html:'',id:this.ident+'-preview'},{xtype:'statictextfield',name:'id',fieldLabel:_('id'),submitValue:true,anchor:'100%'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]}]});GAL.window.UpdateItem.superclass.constructor.call(this,config);this.on('activate',function(w,e){if(typeof Tiny!='undefined'){MODx.loadRTE(this.ident+'-description');}
var d=this.fp.getForm().getValues();if(d&&d.image){var p=Ext.getCmp(this.ident+'-preview');var u=d.image+'&h=200&w=200&zc=1&q=100&f=png';p.update('<div class="gal-item-update-preview"><img src="'+u+'" alt="" onclick="Ext.getCmp(\'gal-album-items-view\').showScreenshot(\''+d.id+'\'); return false;" /></div>');}},this);};Ext.extend(GAL.window.UpdateItem,MODx.Window);Ext.reg('gal-window-item-update',GAL.window.UpdateItem);GAL.window.UploadItem=function(config){config=config||{};this.ident=config.ident||'gupit'+Ext.id();Ext.applyIf(config,{title:_('gallery.item_upload'),id:this.ident,width:600,url:GAL.config.connector_url,action:'mgr/item/upload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,cls:(MODx.config.connector_url)?'':'main-wrapper',labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'},{xtype:'textfield',fieldLabel:_('gallery.item_url'),description:_('gallery.item_url_desc'),name:'url',id:this.ident+'-item-url',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-item-url',text:_('gallery.item_url_desc'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.file'),description:MODx.expandHelp?'':_('gallery.item_upload_file_desc'),name:'file',id:this.ident+'-file',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-file',text:_('gallery.item_upload_file_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),name:'active',description:'',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]}]});GAL.window.UploadItem.superclass.constructor.call(this,config);this.on('activate',function(){if(typeof Tiny!='undefined'){MODx.loadRTE(this.ident+'-description');}});};Ext.extend(GAL.window.UploadItem,MODx.Window);Ext.reg('gal-window-item-upload',GAL.window.UploadItem);GAL.window.UploadCover=function(config){config=config||{};this.ident=config.ident||'gupit'+Ext.id();Ext.applyIf(config,{title:_('gallery.cover_upload'),id:this.ident,height:300,saveBtnText:_('gallery.upload_cover'),url:GAL.config.connector_url,action:'mgr/album/uploadcover',fileUpload:true,fields:[{xtype:'hidden',name:'albumid'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',border:false,cls:(MODx.config.connector_url)?'':'main-wrapper',labelSeparator:''},items:[{columnWidth:1,items:[{xtype:'hidden',name:'id'},{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.file'),description:MODx.expandHelp?'':_('gallery.item_upload_file_desc'),name:'file',id:this.ident+'-file',anchor:'100%'},{xtype:'panel',fieldLabel:_('gallery.current_cover'),html:'',id:this.ident+'-preview'}]}]}]});GAL.window.UploadCover.superclass.constructor.call(this,config);};Ext.extend(GAL.window.UploadCover,MODx.Window);Ext.reg('gal-window-cover-update',GAL.window.UploadCover);GAL.window.UploadMultiItems=function(config){config=config||{};this.ident=config.ident||'gupmuit'+Ext.id();Ext.applyIf(config,{title:_('gallery.multi_item_upload'),id:this.ident,height:350,fields:[{xtype:'hidden',name:'album'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'checkbox',boxLabel:_('gallery.active'),hideLabel:true,name:'active',description:'',id:this.ident+'-active',checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]},{html:'<div id="file-upload" />'+_('gallery.loading_ellipsis')+'</div>',id:'file-upload-field',xtype:'panel'}],buttons:[{text:_('done'),scope:this,handler:function(){this.hide();}}],keys:[]});GAL.window.UploadMultiItems.superclass.constructor.call(this,config);this.on('show',this.setup,this)};Ext.extend(GAL.window.UploadMultiItems,MODx.Window,{setup:function(){if(typeof GAL.uploader=='undefined'){GAL.uploader=new qq.FileUploader({element:document.getElementById('file-upload'),action:GAL.config.connector_url,params:{action:'mgr/item/ajaxupload',album:this.config.album,HTTP_MODAUTH:MODx.siteId},onComplete:function(){GAL.uploader.win.fireEvent('success');},onSubmit:function(){var f=GAL.uploader.win.fp.getForm();var data={active:f.findField('active').getValue()?1:0,tags:f.findField('tags').getValue()};var p=this.params;Ext.apply(p,data);GAL.uploader.setParams(p);}});GAL.uploader.win=this;}}});Ext.reg('gal-window-multi-item-upload',GAL.window.UploadMultiItems);GAL.window.BatchUpload=function(config){config=config||{};this.ident=config.ident||'gupbu'+Ext.id();Ext.applyIf(config,{title:_('gallery.batch_upload'),id:this.ident,url:GAL.config.connector_url,action:'mgr/item/batchupload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{xtype:'textfield',fieldLabel:_('gallery.directory'),description:MODx.expandHelp?'':_('gallery.batch_upload_intro'),name:'directory',id:this.ident+'-directory',anchor:'100%',value:MODx.config['gallery.default_batch_upload_path']||'{assets_path}images/'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-directory',text:_('gallery.batch_upload_intro'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.batch_upload_tags'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.batch_upload_tags'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]});GAL.window.BatchUpload.superclass.constructor.call(this,config);};Ext.extend(GAL.window.BatchUpload,MODx.Window);Ext.reg('gal-window-batch-upload',GAL.window.BatchUpload);GAL.window.ZipUpload=function(config){config=config||{};this.ident=config.ident||'gupbu'+Ext.id();Ext.applyIf(config,{title:_('gallery.zip_upload'),id:this.ident,url:GAL.config.connector_url,action:'mgr/item/zipupload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.zip_file'),description:MODx.expandHelp?'':_('gallery.zip_upload_intro'),name:'zip',id:this.ident+'-zip',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-zip',text:_('gallery.zip_upload_intro'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.batch_upload_tags'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.batch_upload_tags'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]});GAL.window.ZipUpload.superclass.constructor.call(this,config);};Ext.extend(GAL.window.ZipUpload,MODx.Window);Ext.reg('gal-window-zip-upload',GAL.window.ZipUpload);;var galTreeHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gal-tree-handler'});galTreeHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galTreeHandlerClass,Ext.Component,{tree:null,data:{},windows:{},getMenu:function(t,node,e){this.tree=t;this.data=node.attributes&&node.attributes.data?node.attributes.data:{};var m=[];switch(node.attributes.type){case'root':m=this.getRootMenu(node,e);break;case'gallery-album':m=this.getAlbumMenu(node,e);break;case'gallery-item':m=this.getItemMenu(node,e);break;}
return m;},getItemMenu:function(node,e){return[{text:_('gallery.item_update'),handler:this.updateItem,scope:this},'-',{text:_('gallery.item_remove'),handler:this.removeItem,scope:this}];},getAlbumMenu:function(node,e){return[{text:_('gallery.album_create'),handler:this.createAlbum,scope:this},'-',{text:_('gallery.album_update'),handler:this.updateAlbum,scope:this},{text:_('gallery.upload'),menu:{items:[{text:_('gallery.item_upload'),handler:this.uploadItem,scope:this},{text:_('gallery.multi_item_upload'),handler:this.uploadMultiItems,scope:this},{text:_('gallery.batch_upload'),handler:this.batchUpload,scope:this},{text:_('gallery.zip_upload'),handler:this.zipUpload,scope:this}]}},'-',{text:_('gallery.album_remove'),handler:this.removeAlbum,scope:this}];},getRootMenu:function(node,e){return[{text:_('gallery.album_create'),handler:this.createAlbum,scope:this}];},createAlbum:function(btn,e){var r;if(this.data.id){var n=this.tree.cm.activeNode.attributes.data;r={'parent':n.id,parent_name:n.name};}else{r={'parent':0,parent_name:_('none')};}
if(!this.windows.createAlbum){this.windows.createAlbum=MODx.load({xtype:'gal-window-album-create',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.createAlbum.fp.getForm().reset();this.windows.createAlbum.setValues(r);this.windows.createAlbum.show(e.target);},updateAlbum:function(btn,e){var id=this.data.id?this.data.id:0;location.href='?a='+MODx.action['gallery:index']+'&album='+id+'&action=album/update';},removeAlbum:function(btn,e){MODx.msg.confirm({text:_('gallery.album_remove_confirm'),url:GAL.config.connector_url,params:{action:'mgr/album/remove',id:this.tree.cm.activeNode.attributes.data.id},listeners:{'success':{fn:function(r){this.tree.refreshParentNode();},scope:this}}});},updateItem:function(btn,e){this.windows.updateItem=MODx.load({xtype:'gal-window-item-update',listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});this.windows.updateItem.setValues(this.data);this.windows.updateItem.show(e.target);},removeItem:function(btn,e){MODx.msg.confirm({text:_('gallery.item_delete_confirm'),url:GAL.config.connector_url,params:{action:'mgr/item/remove',id:this.data.id},listeners:{'success':{fn:function(r){this.tree.refreshParentNode();},scope:this}}});},uploadMultiItems:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.uploadMultiItems){this.windows.uploadMultiItems=MODx.load({xtype:'gal-window-multi-item-upload',album:this.data.id,record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.uploadMultiItems.fp.getForm().reset();this.windows.uploadMultiItems.setValues(r);this.windows.uploadMultiItems.show(e.target);},uploadItem:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.uploadItem){this.windows.uploadItem=MODx.load({xtype:'gal-window-item-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.uploadItem.fp.getForm().reset();this.windows.uploadItem.setValues(r);this.windows.uploadItem.show(e.target);},batchUpload:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.batchUpload){this.windows.batchUpload=MODx.load({xtype:'gal-window-batch-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}else{this.windows.batchUpload.fp.getForm().reset();}
this.windows.batchUpload.setValues(r);this.windows.batchUpload.show(e.target);},zipUpload:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.zipUpload){this.windows.zipUpload=MODx.load({xtype:'gal-window-zip-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}else{this.windows.zipUpload.fp.getForm().reset();}
this.windows.zipUpload.setValues(r);this.windows.zipUpload.show(e.target);},handleDrop:function(t,dropEvent){this.tree=t;var dropNode=dropEvent.dropNode;var target=dropEvent.target;if(!target.attributes.type)return false;if(target.attributes.type=='gallery-album'&&dropNode.attributes.type=='gallery-item'&&dropEvent.point!='append')return false;if(dropNode.attributes.type=='gallery-album'&&target.attributes.type=='gallery-item')return false;return true;}});Ext.reg('gal-tree-handler',galTreeHandlerClass);var galTreeHandler=new galTreeHandlerClass();var galItemDropHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gallery-item-drop-handler'});galItemDropHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galItemDropHandlerClass,Ext.Component,{handle:function(target,opt){var na=target.node.attributes;var cfg={ddTargetEl:opt.ddTargetEl,cfg:opt.cfg,iframe:opt.cfg.iframe,iframeEl:opt.cfg.iframeEl,onInsert:opt.cfg.onInsert,panel:opt.cfg.panel,classKey:'modSnippet',pk:GAL.snippetGalleryItem,name:'GalleryItem'};GAL.elProps={id:na.data.id};MODx.loadInsertElement(cfg);setTimeout("galTreeWorkaround(GAL.elProps);",600);return true;}});var galItemDropHandler=new galItemDropHandlerClass();var galAlbumDropHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gallery-album-drop-handler'});galAlbumDropHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galAlbumDropHandlerClass,Ext.Component,{handle:function(target,opt){var na=target.node.attributes;var cfg={ddTargetEl:opt.ddTargetEl,cfg:opt.cfg,iframe:opt.cfg.iframe,iframeEl:opt.cfg.iframeEl,onInsert:opt.cfg.onInsert,panel:opt.cfg.panel,classKey:'modSnippet',pk:GAL.snippetGallery,name:'Gallery'};GAL.elProps={album:na.data.id};MODx.loadInsertElement(cfg);setTimeout("galTreeWorkaround(GAL.elProps);",600);return true;}});var galAlbumDropHandler=new galAlbumDropHandlerClass();function galTreeWorkaround(props){var w=Ext.getCmp('modx-window-insert-element');w.modps=[];if(w){for(var k in props){var fld=Ext.getCmp('modx-iprop-'+k);if(fld){fld.setValue(props[k]);w.changeProp(k);}}}};setTimeout('galleryFixLeafDrag();',1200);function galleryFixLeafDrag(){var t=Ext.getCmp('modx-file-tree');if(t){t.on('startdrag',function(t,n,e){if(n.attributes.type=='gallery-album'){n.attributes.leaf=true;}},this);}};MODx.grid.LocalProperty=function(config){config=config||{};Ext.applyIf(config,{dynProperty:'xtype',dynField:'value',propertyRecord:[{name:'name'},{name:'value'}],data:[]});MODx.grid.LocalProperty.superclass.constructor.call(this,config);this.propRecord=Ext.data.Record.create(config.propertyRecord);};Ext.extend(MODx.grid.LocalProperty,MODx.grid.LocalGrid,{onCellDblClick:function(g,ri,ci,e){var cm=this.getColumnModel();if(cm.getColumnId(ci)==this.config.dynField){e.preventDefault();var r=this.getStore().getAt(ri).data;this.initEditor(cm,ci,ri,r);this.startEditing(ri,ci);}},initEditor:function(cm,ci,ri,r){cm.setEditable(ci,true);var xtype=this.config.dynProperty;var o;if(r[xtype]=='list'){o=this.createCombo(r);}else{var z={};z[xtype]=r[xtype]||'textfield';try{o=Ext.ComponentMgr.create(z);}catch(e){z[xtype]='textfield';o=MODx.load(z);}}
var ed=new Ext.grid.GridEditor(o);cm.setEditor(ci,ed);return ed;},renderDynField:function(v,md,rec,ri,ci,s,g){var r=s.getAt(ri).data;var f,idx;var oz=v;var xtype=this.config.dynProperty;if(!r[xtype]||r[xtype]=='combo-boolean'){f=MODx.grid.Grid.prototype.rendYesNo;oz=f(v==1,md);}else if(r[xtype]==='datefield'){f=Ext.util.Format.dateRenderer('Y-m-d');oz=f(v);}else if(r[xtype]==='password'){f=this.rendPassword;oz=f(v,md);}else if(r[xtype].substr(0,5)=='combo'||r[xtype]=='list'||r[xtype].substr(0,9)=='modx-combo'){var cm=g.getColumnModel();var ed=cm.getCellEditor(ci,ri);var cb;if(!ed){r.xtype=r.xtype||'combo-boolean';cb=this.createCombo(r);ed=new Ext.grid.GridEditor(cb);cm.setEditor(ci,ed);}else if(ed&&ed.field&&ed.field.xtype=='modx-combo'){cb=ed.field;}
if(r[xtype]!='list'){f=Ext.util.Format.comboRenderer(ed.field);oz=f(v);}else if(cb){idx=cb.getStore().find(cb.valueField,v);rec=cb.getStore().getAt(idx);if(rec){oz=rec.get(cb.displayField);}else{oz=v;}}}
return Ext.util.Format.htmlEncode(oz);},createCombo:function(p){var obj;try{obj=Ext.ComponentMgr.create({xtype:r.xtype,id:Ext.id()});}catch(e){try{var flds=p.options;var data=[];for(var i=0;i<flds.length;i=i+1){data.push([flds[i].name,flds[i].value,flds[i].text]);}
obj=MODx.load({xtype:'modx-combo',store:new Ext.data.SimpleStore({fields:['d','v','t'],data:data}),displayField:'d',valueField:'v',mode:'local',triggerAction:'all',editable:false,selectOnFocus:false,preventRender:true});}catch(e2){obj=Ext.ComponentMgr.create({xtype:'combo-boolean',id:Ext.id()});}}
return obj;}});Ext.reg('grid-local-property',MODx.grid.LocalProperty);;MODx.combo.LexiconTopic=function(config){config=config||{};Ext.applyIf(config,{name:'topic',hiddenName:'topic',forceSelection:true,typeAhead:true,minChars:1,editable:true,allowBlank:true,url:MODx.config.connector_url,fields:['name'],displayField:'name',valueField:'name',baseParams:{action:'workspace/lexicon/topic/getList','namespace':'core','language':'en'}});MODx.combo.LexiconTopic.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.LexiconTopic,MODx.combo.ComboBox,{setNamespace:function(ns,t){this.store.baseParams['namespace']=ns;this.store.load({callback:function(){if(t){this.setValue(t);}},scope:this});},setLanguage:function(ns,t){this.store.baseParams['language']=ns;this.store.load({callback:function(){if(t){this.setValue(t);}},scope:this});}});Ext.reg('modx-combo-lexicon-topic',MODx.combo.LexiconTopic);;MODx.grid.Lexicon=function(config){config=config||{};Ext.applyIf(config,{id:'modx-grid-lexicon',url:MODx.config.connector_url,fields:['name','value','namespace','topic','language','editedon','overridden'],baseParams:{action:'workspace/lexicon/getList','namespace':MODx.request['ns']?MODx.request['ns']:'core',topic:'',language:MODx.config.manager_language||'en'},width:'98%',paging:true,autosave:true,save_action:'workspace/lexicon/updatefromgrid',columns:[{header:_('name'),dataIndex:'name',width:200,sortable:true,renderer:this._renderStatus},{header:_('value'),dataIndex:'value',width:500,sortable:false,editor:{xtype:'textarea'},renderer:this._renderStatus},{header:_('last_modified'),dataIndex:'editedon',width:125,renderer:this._renderLastModDate}],tbar:[{xtype:'tbtext',text:_('namespace')+':'},{xtype:'modx-combo-namespace',id:'modx-lexicon-filter-namespace',itemId:'namespace',value:MODx.request['ns']?MODx.request['ns']:'core',width:120,listeners:{'select':{fn:this.changeNamespace,scope:this}}},{xtype:'tbtext',text:_('topic')+':'},{xtype:'modx-combo-lexicon-topic',id:'modx-lexicon-filter-topic',itemId:'topic',value:'default',width:120,baseParams:{action:'workspace/lexicon/topic/getList','namespace':MODx.request['ns']?MODx.request['ns']:'core','language':'en'},listeners:{'select':{fn:this.changeTopic,scope:this}}},{xtype:'tbtext',text:_('language')+':'},{xtype:'modx-combo-language',name:'language',id:'modx-lexicon-filter-language',itemId:'language',value:MODx.config.manager_language||'en',width:100,baseParams:{action:'system/language/getlist','namespace':MODx.request['ns']?MODx.request['ns']:'core'},listeners:{'select':{fn:this.changeLanguage,scope:this}}},'->',{xtype:'button',text:_('entry_create'),cls:'primary-button',handler:this.createEntry,scope:this},{xtype:'textfield',name:'name',id:'modx-lexicon-filter-search',cls:'x-form-filter',itemId:'search',width:120,emptyText:_('search')+'...',listeners:{'change':{fn:this.filter.createDelegate(this,['search'],true),scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:this.blur,scope:cmp});},scope:this}}},{xtype:'button',id:'modx-lexicon-filter-clear',cls:'x-form-filter-clear',itemId:'clear',text:_('filter_clear'),listeners:{'click':{fn:this.clearFilter,scope:this}}}],pagingItems:[{text:_('reload_from_base'),handler:this.reloadFromBase,scope:this}]});MODx.grid.Lexicon.superclass.constructor.call(this,config);};Ext.extend(MODx.grid.Lexicon,MODx.grid.Grid,{console:null,_renderStatus:function(v,md,rec,ri){switch(rec.data.overridden){case 1:return'<span style="color: green;">'+v+'</span>';break;case 2:return'<span style="color: purple;">'+v+'</span>';default:return'<span>'+v+'</span>';}},_renderLastModDate:function(value){if(Ext.isEmpty(value)){return'â€”';}
return new Date(value*1000).format(MODx.config.manager_date_format+' '+MODx.config.manager_time_format);},filter:function(cb,r,i,name){if(!name){return false;}
this.store.baseParams[name]=cb.getValue();this.getBottomToolbar().changePage(1);this.refresh();return true;},clearFilter:function(){this.store.baseParams={action:'workspace/lexicon/getList','namespace':'core',topic:'default',language:'en'};this.getBottomToolbar().changePage(1);var tb=this.getTopToolbar();tb.getComponent('namespace').setValue('core');var tcb=tb.getComponent('topic');tcb.store.baseParams['namespace']='core';tcb.store.load();tcb.setValue('default');var tcl=tb.getComponent('language');tcb.store.baseParams['namespace']='core';tcb.store.load();tcl.setValue('en');tb.getComponent('search').setValue('');this.refresh();},changeNamespace:function(cb,nv,ov){this.setFilterParams(cb.getValue(),'default','en');},changeTopic:function(cb,nv,ov){this.setFilterParams(null,cb.getValue());},changeLanguage:function(cb,nv,ov){this.setFilterParams(null,null,cb.getValue());},setFilterParams:function(ns,t,l){var tb=this.getTopToolbar();if(!tb){return false;}
var tcb,tcl;if(ns){tb.getComponent('namespace').setValue(ns);tcl=tb.getComponent('language');if(tcl){tcl.store.baseParams['namespace']=ns;tcl.store.load({callback:function(){tcl.setValue(l||'en');}});}
tcb=tb.getComponent('topic');if(tcb){tcb.store.baseParams['namespace']=ns;tcb.store.baseParams['language']=l?l:(tcl?tcl.getValue():'en');tcb.store.load({callback:function(){tcb.setValue(t||'default');}});}}else if(t){tcb=tb.getComponent('topic');if(tcb){tcb.setValue(t);}}
var s=this.getStore();if(s){if(ns){s.baseParams['namespace']=ns;}
if(t){s.baseParams['topic']=t||'default';}
if(l){s.baseParams['language']=l||'en';}
s.removeAll();}
this.getBottomToolbar().changePage(1);this.refresh();},loadWindow2:function(btn,e,o){var tb=this.getTopToolbar();this.menu.record={'namespace':tb.getComponent('namespace').getValue(),language:tb.getComponent('language').getValue()};if(o.xtype!='modx-window-lexicon-import'){this.menu.record.topic=tb.getComponent('topic').getValue();}
this.loadWindow(btn,e,o);},reloadFromBase:function(){Ext.Ajax.timeout=0;var topic='/workspace/lexicon/reload/';this.console=MODx.load({xtype:'modx-console',register:'mgr',topic:topic});this.console.on('complete',function(){this.refresh();},this);this.console.show(Ext.getBody());MODx.Ajax.request({url:this.config.url,params:{action:'workspace/lexicon/reloadFromBase',register:'mgr',topic:topic},listeners:{'success':{fn:function(r){this.refresh();},scope:this}}});},revertEntry:function(){var p=this.menu.record;p.action='workspace/lexicon/revert';MODx.Ajax.request({url:this.config.url,params:p,listeners:{'success':{fn:function(r){this.refresh();},scope:this}}});},getMenu:function(){var r=this.getSelectionModel().getSelected();var m=[];if(r.data.overridden){m.push({text:_('entry_revert'),handler:this.revertEntry});}
return m;},createEntry:function(btn,e){var r=this.menu.record||{};var tb=this.getTopToolbar();r['namespace']=tb.getComponent('namespace').getValue();r.language=tb.getComponent('language').getValue();r.topic=tb.getComponent('topic').getValue();if(!this.createEntryWindow){this.createEntryWindow=MODx.load({xtype:'modx-window-lexicon-entry-create',record:r,listeners:{'success':{fn:function(o){this.refresh();},scope:this}}});}
this.createEntryWindow.reset();this.createEntryWindow.setValues(r);this.createEntryWindow.show(e.target);}});Ext.reg('modx-grid-lexicon',MODx.grid.Lexicon);MODx.window.ExportLexicon=function(config){config=config||{};this.ident=config.ident||'explex'+Ext.id();var r=config.record;Ext.applyIf(config,{title:_('lexicon_export'),url:MODx.config.connector_url,action:'workspace/lexicon/export',fileUpload:true,fields:[{html:_('lexicon_export_desc'),border:false,bodyStyle:'margin: 10px;',id:'modx-'+this.ident+'-desc',itemId:'desc',anchor:'100%'},{xtype:'modx-combo-namespace',fieldLabel:_('namespace'),name:'namespace',id:'modx-'+this.ident+'-namespace',itemId:'namespace',anchor:'100%',listeners:{'select':{fn:function(cb,r,i){cle=this.fp.getComponent('topic');if(cle){cle.store.baseParams['namespace']=cb.getValue();cle.setValue('');cle.store.reload();}else{MODx.debug('cle not found');}},scope:this}}},{xtype:'modx-combo-lexicon-topic',fieldLabel:_('topic'),name:'topic',id:'modx-'+this.ident+'-topic',itemId:'topic',anchor:'100%'},{xtype:'modx-combo-language',fieldLabel:_('language'),name:'language',id:'modx-'+this.ident+'-language',itemId:'language',anchor:'100%'}]});MODx.window.ExportLexicon.superclass.constructor.call(this,config);};Ext.extend(MODx.window.ExportLexicon,MODx.Window);Ext.reg('modx-window-lexicon-export',MODx.window.ExportLexicon);MODx.window.LexiconEntryCreate=function(config){config=config||{};this.ident=config.ident||'lexentc'+Ext.id();var r=config.record;Ext.applyIf(config,{title:_('entry_create'),url:MODx.config.connector_url,action:'workspace/lexicon/create',fileUpload:true,fields:[{xtype:'textfield',fieldLabel:_('name'),id:'modx-'+this.ident+'-name',itemId:'name',name:'name',anchor:'100%'},{xtype:'modx-combo-namespace',fieldLabel:_('namespace'),name:'namespace',id:'modx-'+this.ident+'-namespace',itemId:'namespace',anchor:'100%',listeners:{'select':{fn:function(cb,r,i){cle=this.fp.getComponent('topic');if(cle){cle.store.baseParams['namespace']=cb.getValue();cle.setValue('');cle.store.reload();}else{MODx.debug('cle not found');}},scope:this}}},{xtype:'modx-combo-lexicon-topic',fieldLabel:_('topic'),name:'topic',id:'modx-'+this.ident+'-topic',itemId:'topic',anchor:'100%'},{xtype:'modx-combo-language',fieldLabel:_('language'),name:'language',id:'modx-'+this.ident+'-language',itemId:'language',anchor:'100%'},{xtype:'textarea',fieldLabel:_('value'),id:'modx-'+this.ident+'-value',itemId:'value',name:'value',anchor:'100%'}]});MODx.window.LexiconEntryCreate.superclass.constructor.call(this,config);};Ext.extend(MODx.window.LexiconEntryCreate,MODx.Window);Ext.reg('modx-window-lexicon-entry-create',MODx.window.LexiconEntryCreate);;MODx.panel.Lexicon=function(config){config=config||{};Ext.applyIf(config,{id:'modx-panel-lexicon',cls:'container',itemId:'panel-lexicon',bodyStyle:'',defaults:{autoHeight:true,collapsible:false},items:[{html:'<h2>'+_('lexicon_management')+'</h2>',border:false,id:'modx-lexicon-header',itemId:'lexicon-header',cls:'modx-page-header'},MODx.getPageStructure([{title:_('lexicon_management'),layout:'form',items:[{html:'<p>'+_('lexicon_management_desc')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-lexicon',itemId:'grid-lexicon',cls:'main-wrapper',title:'',preventRender:true}]}])]});MODx.panel.Lexicon.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.Lexicon,MODx.FormPanel);Ext.reg('modx-panel-lexicon',MODx.panel.Lexicon);;MODx.page.LexiconManagement=function(config){config=config||{};Ext.applyIf(config,{components:[{xtype:'modx-panel-lexicon'}],buttons:[{text:_('help_ex'),handler:MODx.loadHelpPane}]});MODx.page.LexiconManagement.superclass.constructor.call(this,config);};Ext.extend(MODx.page.LexiconManagement,MODx.Component);Ext.reg('modx-page-lexicon-management',MODx.page.LexiconManagement);