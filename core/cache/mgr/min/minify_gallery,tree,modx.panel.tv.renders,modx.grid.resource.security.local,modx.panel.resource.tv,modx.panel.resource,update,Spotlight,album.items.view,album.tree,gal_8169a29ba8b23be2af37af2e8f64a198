var GAL=function(config){config=config||{};GAL.superclass.constructor.call(this,config);};Ext.extend(GAL,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},view:{}});Ext.reg('gallery',GAL);GAL=new GAL();GAL.window.CreateAlbum=function(config){config=config||{};this.ident=config.ident||'gcalb'+Ext.id();Ext.applyIf(config,{title:_('gallery.album_create'),id:this.ident,width:600,url:GAL.config.connector_url,action:'mgr/album/create',fields:[{xtype:'hidden',name:'parent'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:config.record['parent']==0?'hidden':'statictextfield',fieldLabel:_('gallery.parent'),name:'parent_name',id:this.ident+'-parent-name',anchor:'100%'},{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'}]},{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('gallery.year'),name:'year',anchor:'100%',allowBlank:true},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.active_desc'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.prominent'),description:MODx.expandHelp?'':_('gallery.prominent_desc'),name:'prominent',id:this.ident+'-prominent',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-prominent',text:_('gallery.prominent_desc'),cls:'desc-under'}]}]}]});GAL.window.CreateAlbum.superclass.constructor.call(this,config);};Ext.extend(GAL.window.CreateAlbum,MODx.Window);Ext.reg('gal-window-album-create',GAL.window.CreateAlbum);GAL.window.UpdateItem=function(config){config=config||{};this.ident=config.ident||'gupdit'+Ext.id();Ext.applyIf(config,{title:_('gallery.item_update'),id:this.ident,closeAction:'close',width:600,url:GAL.config.connector_url,action:'mgr/item/update',fileUpload:true,fields:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'},{xtype:'textfield',fieldLabel:_('gallery.item_url'),description:MODx.expandHelp?'':_('gallery.item_url_desc'),name:'url',id:this.ident+'-item-url',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-item-url',text:_('gallery.item_url_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'hidden',name:'thumbnail'},{xtype:'hidden',name:'image'},{html:'',id:this.ident+'-preview'},{xtype:'statictextfield',name:'id',fieldLabel:_('id'),submitValue:true,anchor:'100%'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]}]});GAL.window.UpdateItem.superclass.constructor.call(this,config);this.on('activate',function(w,e){if(typeof Tiny!='undefined'){MODx.loadRTE(this.ident+'-description');}
var d=this.fp.getForm().getValues();if(d&&d.image){var p=Ext.getCmp(this.ident+'-preview');var u=d.image+'&h=200&w=200&zc=1&q=100&f=png';p.update('<div class="gal-item-update-preview"><img src="'+u+'" alt="" onclick="Ext.getCmp(\'gal-album-items-view\').showScreenshot(\''+d.id+'\'); return false;" /></div>');}},this);};Ext.extend(GAL.window.UpdateItem,MODx.Window);Ext.reg('gal-window-item-update',GAL.window.UpdateItem);GAL.window.UploadItem=function(config){config=config||{};this.ident=config.ident||'gupit'+Ext.id();Ext.applyIf(config,{title:_('gallery.item_upload'),id:this.ident,width:600,url:GAL.config.connector_url,action:'mgr/item/upload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,cls:(MODx.config.connector_url)?'':'main-wrapper',labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'},{xtype:'textfield',fieldLabel:_('gallery.item_url'),description:_('gallery.item_url_desc'),name:'url',id:this.ident+'-item-url',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-item-url',text:_('gallery.item_url_desc'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.file'),description:MODx.expandHelp?'':_('gallery.item_upload_file_desc'),name:'file',id:this.ident+'-file',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-file',text:_('gallery.item_upload_file_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),name:'active',description:'',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]}]});GAL.window.UploadItem.superclass.constructor.call(this,config);this.on('activate',function(){if(typeof Tiny!='undefined'){MODx.loadRTE(this.ident+'-description');}});};Ext.extend(GAL.window.UploadItem,MODx.Window);Ext.reg('gal-window-item-upload',GAL.window.UploadItem);GAL.window.UploadCover=function(config){config=config||{};this.ident=config.ident||'gupit'+Ext.id();Ext.applyIf(config,{title:_('gallery.cover_upload'),id:this.ident,height:300,saveBtnText:_('gallery.upload_cover'),url:GAL.config.connector_url,action:'mgr/album/uploadcover',fileUpload:true,fields:[{xtype:'hidden',name:'albumid'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',border:false,cls:(MODx.config.connector_url)?'':'main-wrapper',labelSeparator:''},items:[{columnWidth:1,items:[{xtype:'hidden',name:'id'},{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.file'),description:MODx.expandHelp?'':_('gallery.item_upload_file_desc'),name:'file',id:this.ident+'-file',anchor:'100%'},{xtype:'panel',fieldLabel:_('gallery.current_cover'),html:'',id:this.ident+'-preview'}]}]}]});GAL.window.UploadCover.superclass.constructor.call(this,config);};Ext.extend(GAL.window.UploadCover,MODx.Window);Ext.reg('gal-window-cover-update',GAL.window.UploadCover);GAL.window.UploadMultiItems=function(config){config=config||{};this.ident=config.ident||'gupmuit'+Ext.id();Ext.applyIf(config,{title:_('gallery.multi_item_upload'),id:this.ident,height:350,fields:[{xtype:'hidden',name:'album'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'checkbox',boxLabel:_('gallery.active'),hideLabel:true,name:'active',description:'',id:this.ident+'-active',checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]},{html:'<div id="file-upload" />'+_('gallery.loading_ellipsis')+'</div>',id:'file-upload-field',xtype:'panel'}],buttons:[{text:_('done'),scope:this,handler:function(){this.hide();}}],keys:[]});GAL.window.UploadMultiItems.superclass.constructor.call(this,config);this.on('show',this.setup,this)};Ext.extend(GAL.window.UploadMultiItems,MODx.Window,{setup:function(){if(typeof GAL.uploader=='undefined'){GAL.uploader=new qq.FileUploader({element:document.getElementById('file-upload'),action:GAL.config.connector_url,params:{action:'mgr/item/ajaxupload',album:this.config.album,HTTP_MODAUTH:MODx.siteId},onComplete:function(){GAL.uploader.win.fireEvent('success');},onSubmit:function(){var f=GAL.uploader.win.fp.getForm();var data={active:f.findField('active').getValue()?1:0,tags:f.findField('tags').getValue()};var p=this.params;Ext.apply(p,data);GAL.uploader.setParams(p);}});GAL.uploader.win=this;}}});Ext.reg('gal-window-multi-item-upload',GAL.window.UploadMultiItems);GAL.window.BatchUpload=function(config){config=config||{};this.ident=config.ident||'gupbu'+Ext.id();Ext.applyIf(config,{title:_('gallery.batch_upload'),id:this.ident,url:GAL.config.connector_url,action:'mgr/item/batchupload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{xtype:'textfield',fieldLabel:_('gallery.directory'),description:MODx.expandHelp?'':_('gallery.batch_upload_intro'),name:'directory',id:this.ident+'-directory',anchor:'100%',value:MODx.config['gallery.default_batch_upload_path']||'{assets_path}images/'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-directory',text:_('gallery.batch_upload_intro'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.batch_upload_tags'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.batch_upload_tags'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]});GAL.window.BatchUpload.superclass.constructor.call(this,config);};Ext.extend(GAL.window.BatchUpload,MODx.Window);Ext.reg('gal-window-batch-upload',GAL.window.BatchUpload);GAL.window.ZipUpload=function(config){config=config||{};this.ident=config.ident||'gupbu'+Ext.id();Ext.applyIf(config,{title:_('gallery.zip_upload'),id:this.ident,url:GAL.config.connector_url,action:'mgr/item/zipupload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.zip_file'),description:MODx.expandHelp?'':_('gallery.zip_upload_intro'),name:'zip',id:this.ident+'-zip',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-zip',text:_('gallery.zip_upload_intro'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.batch_upload_tags'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.batch_upload_tags'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]});GAL.window.ZipUpload.superclass.constructor.call(this,config);};Ext.extend(GAL.window.ZipUpload,MODx.Window);Ext.reg('gal-window-zip-upload',GAL.window.ZipUpload);;var galTreeHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gal-tree-handler'});galTreeHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galTreeHandlerClass,Ext.Component,{tree:null,data:{},windows:{},getMenu:function(t,node,e){this.tree=t;this.data=node.attributes&&node.attributes.data?node.attributes.data:{};var m=[];switch(node.attributes.type){case'root':m=this.getRootMenu(node,e);break;case'gallery-album':m=this.getAlbumMenu(node,e);break;case'gallery-item':m=this.getItemMenu(node,e);break;}
return m;},getItemMenu:function(node,e){return[{text:_('gallery.item_update'),handler:this.updateItem,scope:this},'-',{text:_('gallery.item_remove'),handler:this.removeItem,scope:this}];},getAlbumMenu:function(node,e){return[{text:_('gallery.album_create'),handler:this.createAlbum,scope:this},'-',{text:_('gallery.album_update'),handler:this.updateAlbum,scope:this},{text:_('gallery.upload'),menu:{items:[{text:_('gallery.item_upload'),handler:this.uploadItem,scope:this},{text:_('gallery.multi_item_upload'),handler:this.uploadMultiItems,scope:this},{text:_('gallery.batch_upload'),handler:this.batchUpload,scope:this},{text:_('gallery.zip_upload'),handler:this.zipUpload,scope:this}]}},'-',{text:_('gallery.album_remove'),handler:this.removeAlbum,scope:this}];},getRootMenu:function(node,e){return[{text:_('gallery.album_create'),handler:this.createAlbum,scope:this}];},createAlbum:function(btn,e){var r;if(this.data.id){var n=this.tree.cm.activeNode.attributes.data;r={'parent':n.id,parent_name:n.name};}else{r={'parent':0,parent_name:_('none')};}
if(!this.windows.createAlbum){this.windows.createAlbum=MODx.load({xtype:'gal-window-album-create',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.createAlbum.fp.getForm().reset();this.windows.createAlbum.setValues(r);this.windows.createAlbum.show(e.target);},updateAlbum:function(btn,e){var id=this.data.id?this.data.id:0;location.href='?a='+MODx.action['gallery:index']+'&album='+id+'&action=album/update';},removeAlbum:function(btn,e){MODx.msg.confirm({text:_('gallery.album_remove_confirm'),url:GAL.config.connector_url,params:{action:'mgr/album/remove',id:this.tree.cm.activeNode.attributes.data.id},listeners:{'success':{fn:function(r){this.tree.refreshParentNode();},scope:this}}});},updateItem:function(btn,e){this.windows.updateItem=MODx.load({xtype:'gal-window-item-update',listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});this.windows.updateItem.setValues(this.data);this.windows.updateItem.show(e.target);},removeItem:function(btn,e){MODx.msg.confirm({text:_('gallery.item_delete_confirm'),url:GAL.config.connector_url,params:{action:'mgr/item/remove',id:this.data.id},listeners:{'success':{fn:function(r){this.tree.refreshParentNode();},scope:this}}});},uploadMultiItems:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.uploadMultiItems){this.windows.uploadMultiItems=MODx.load({xtype:'gal-window-multi-item-upload',album:this.data.id,record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.uploadMultiItems.fp.getForm().reset();this.windows.uploadMultiItems.setValues(r);this.windows.uploadMultiItems.show(e.target);},uploadItem:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.uploadItem){this.windows.uploadItem=MODx.load({xtype:'gal-window-item-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.uploadItem.fp.getForm().reset();this.windows.uploadItem.setValues(r);this.windows.uploadItem.show(e.target);},batchUpload:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.batchUpload){this.windows.batchUpload=MODx.load({xtype:'gal-window-batch-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}else{this.windows.batchUpload.fp.getForm().reset();}
this.windows.batchUpload.setValues(r);this.windows.batchUpload.show(e.target);},zipUpload:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.zipUpload){this.windows.zipUpload=MODx.load({xtype:'gal-window-zip-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}else{this.windows.zipUpload.fp.getForm().reset();}
this.windows.zipUpload.setValues(r);this.windows.zipUpload.show(e.target);},handleDrop:function(t,dropEvent){this.tree=t;var dropNode=dropEvent.dropNode;var target=dropEvent.target;if(!target.attributes.type)return false;if(target.attributes.type=='gallery-album'&&dropNode.attributes.type=='gallery-item'&&dropEvent.point!='append')return false;if(dropNode.attributes.type=='gallery-album'&&target.attributes.type=='gallery-item')return false;return true;}});Ext.reg('gal-tree-handler',galTreeHandlerClass);var galTreeHandler=new galTreeHandlerClass();var galItemDropHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gallery-item-drop-handler'});galItemDropHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galItemDropHandlerClass,Ext.Component,{handle:function(target,opt){var na=target.node.attributes;var cfg={ddTargetEl:opt.ddTargetEl,cfg:opt.cfg,iframe:opt.cfg.iframe,iframeEl:opt.cfg.iframeEl,onInsert:opt.cfg.onInsert,panel:opt.cfg.panel,classKey:'modSnippet',pk:GAL.snippetGalleryItem,name:'GalleryItem'};GAL.elProps={id:na.data.id};MODx.loadInsertElement(cfg);setTimeout("galTreeWorkaround(GAL.elProps);",600);return true;}});var galItemDropHandler=new galItemDropHandlerClass();var galAlbumDropHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gallery-album-drop-handler'});galAlbumDropHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galAlbumDropHandlerClass,Ext.Component,{handle:function(target,opt){var na=target.node.attributes;var cfg={ddTargetEl:opt.ddTargetEl,cfg:opt.cfg,iframe:opt.cfg.iframe,iframeEl:opt.cfg.iframeEl,onInsert:opt.cfg.onInsert,panel:opt.cfg.panel,classKey:'modSnippet',pk:GAL.snippetGallery,name:'Gallery'};GAL.elProps={album:na.data.id};MODx.loadInsertElement(cfg);setTimeout("galTreeWorkaround(GAL.elProps);",600);return true;}});var galAlbumDropHandler=new galAlbumDropHandlerClass();function galTreeWorkaround(props){var w=Ext.getCmp('modx-window-insert-element');w.modps=[];if(w){for(var k in props){var fld=Ext.getCmp('modx-iprop-'+k);if(fld){fld.setValue(props[k]);w.changeProp(k);}}}};setTimeout('galleryFixLeafDrag();',1200);function galleryFixLeafDrag(){var t=Ext.getCmp('modx-file-tree');if(t){t.on('startdrag',function(t,n,e){if(n.attributes.type=='gallery-album'){n.attributes.leaf=true;}},this);}};MODx.panel.ImageTV=function(config){config=config||{};config.filemanager_url=MODx.config.filemanager_url;Ext.applyIf(config,{layout:'form',autoHeight:true,border:false,hideLabels:true,defaults:{autoHeight:true,border:false},items:[{xtype:'hidden',name:'tv'+config.tv,id:'tv'+config.tv,value:config.value},{xtype:'modx-combo-browser',browserEl:'tvbrowser'+config.tv,name:'tvbrowser'+config.tv,id:'tvbrowser'+config.tv,triggerClass:'x-form-image-trigger',value:config.relativeValue,hideFiles:true,source:config.source||1,allowedFileTypes:config.allowedFileTypes||'',openTo:config.openTo||'',hideSourceCombo:true,listeners:{'select':{fn:function(data){Ext.getCmp('tv'+this.config.tv).setValue(data.relativeUrl);Ext.getCmp('tvbrowser'+this.config.tv).setValue(data.relativeUrl);this.fireEvent('select',data);},scope:this},'change':{fn:function(cb,nv){Ext.getCmp('tv'+this.config.tv).setValue(nv);this.fireEvent('select',{relativeUrl:nv,url:nv});},scope:this}}}]});MODx.panel.ImageTV.superclass.constructor.call(this,config);this.addEvents({select:true});};Ext.extend(MODx.panel.ImageTV,MODx.Panel);Ext.reg('modx-panel-tv-image',MODx.panel.ImageTV);MODx.panel.FileTV=function(config){config=config||{};config.filemanager_url=MODx.config.filemanager_url;Ext.applyIf(config,{layout:'form',autoHeight:true,border:false,hideLabels:true,defaults:{autoHeight:true,border:false},items:[{xtype:'hidden',name:'tv'+config.tv,id:'tv'+config.tv,value:config.value},{xtype:'modx-combo-browser',browserEl:'tvbrowser'+config.tv,name:'tvbrowser'+config.tv,id:'tvbrowser'+config.tv,value:config.relativeValue,hideFiles:true,source:config.source||1,allowedFileTypes:config.allowedFileTypes||'',wctx:config.wctx||'web',openTo:config.openTo||'',hideSourceCombo:true,listeners:{'select':{fn:function(data){Ext.getCmp('tv'+this.config.tv).setValue(data.relativeUrl);Ext.getCmp('tvbrowser'+this.config.tv).setValue(data.relativeUrl);this.fireEvent('select',data);},scope:this},'change':{fn:function(cb,nv){Ext.getCmp('tv'+this.config.tv).setValue(nv);this.fireEvent('select',{relativeUrl:nv,url:nv});},scope:this}}}]});MODx.panel.FileTV.superclass.constructor.call(this,config);this.addEvents({select:true});};Ext.extend(MODx.panel.FileTV,MODx.Panel);Ext.reg('modx-panel-tv-file',MODx.panel.FileTV);MODx.checkTV=function(id){var cb=Ext.get('tv'+id);Ext.get('tvh'+id).dom.value=cb.dom.checked?cb.dom.value:'';};;MODx.grid.ResourceSecurity=function(config){config=config||{};var ac=new Ext.ux.grid.CheckColumn({header:_('access'),dataIndex:'access',width:40,sortable:false,hidden:MODx.perm.resourcegroup_resource_edit!=1});Ext.applyIf(config,{id:'modx-grid-resource-security',fields:['id','name','access'],paging:false,remoteSort:false,autoHeight:true,plugins:ac,columns:[{header:_('name'),dataIndex:'name',width:200,sortable:true},ac]});MODx.grid.ResourceSecurity.superclass.constructor.call(this,config);this.propRecord=Ext.data.Record.create(config.fields);this.on('rowclick',MODx.fireResourceFormChange);};Ext.extend(MODx.grid.ResourceSecurity,MODx.grid.LocalGrid);Ext.reg('modx-grid-resource-security',MODx.grid.ResourceSecurity);;MODx.panel.ResourceTV=function(config){config=config||{};Ext.applyIf(config,{id:'modx-panel-resource-tv',title:_('template_variables'),class_key:'',resource:'',cls:MODx.config.tvs_below_content==1?'x-panel-body tvs-wrapper below-content':'tvs-wrapper x-panel-body',autoHeight:true,applyTo:'modx-resource-tvs-div',header:false,templateField:'modx-resource-template'});MODx.panel.ResourceTV.superclass.constructor.call(this,config);this.addEvents({load:true});};Ext.extend(MODx.panel.ResourceTV,MODx.Panel,{autoload:function(){return false;},refreshTVs:function(){return false;var t=Ext.getCmp(this.config.templateField);if(!t&&!this.config.template){return false;}
var template=this.config.template?this.config.template:t.getValue();this.getUpdater().update({url:MODx.config.manager_url+'?a=resource/tvs',method:'GET',params:{'class_key':this.config.class_key,'template':template,'resource':this.config.resource},scripts:true,callback:function(){this.fireEvent('load');if(MODx.afterTVLoad){MODx.afterTVLoad();}},scope:this});}});Ext.reg('modx-panel-resource-tv',MODx.panel.ResourceTV);;MODx.panel.Resource=function(config){config=config||{record:{}};config.record=config.record||{};Ext.applyIf(config,{url:MODx.config.connector_url,baseParams:{},id:'modx-panel-resource',class_key:'modDocument',resource:'',bodyStyle:'',cls:'container form-with-labels',defaults:{collapsible:false,autoHeight:true},forceLayout:true,items:this.getFields(config),fileUpload:true,useLoadingMask:true,listeners:{'setup':{fn:this.setup,scope:this},'success':{fn:this.success,scope:this},'failure':{fn:this.failure,scope:this},'beforeSubmit':{fn:this.beforeSubmit,scope:this},'fieldChange':{fn:this.onFieldChange,scope:this}}});MODx.panel.Resource.superclass.constructor.call(this,config);var ta=Ext.get('ta');if(ta){ta.on('keydown',this.fieldChangeEvent,this);}
this.on('ready',this.onReady,this);var urio=Ext.getCmp('modx-resource-uri-override');if(urio){urio.on('check',this.freezeUri);}
this.addEvents('tv-reset');};Ext.extend(MODx.panel.Resource,MODx.FormPanel,{initialized:false,defaultClassKey:'modDocument',classLexiconKey:'document',rteElements:'ta',rteLoaded:false,warnUnsavedChanges:false,setup:function(){if(!this.initialized){this.getForm().setValues(this.config.record);var pcmb=this.getForm().findField('parent-cmb');if(pcmb&&Ext.isEmpty(this.config.record.parent_pagetitle)){pcmb.setValue('');}else if(pcmb){pcmb.setValue(this.config.record.parent_pagetitle+' ('+this.config.record.parent+')');}
if(!Ext.isEmpty(this.config.record.pagetitle)){Ext.getCmp('modx-resource-header').getEl().update('<h2>'+Ext.util.Format.stripTags(this.config.record.pagetitle)+'</h2>');}
if(!Ext.isEmpty(this.config.record.resourceGroups)){var g=Ext.getCmp('modx-grid-resource-security');if(g&&Ext.isEmpty(g.config.url)){var s=g.getStore();if(s){s.loadData(this.config.record.resourceGroups);}}}
this.defaultClassKey=this.config.record.class_key||this.defaultClassKey;this.defaultValues=this.config.record||{};if((this.config.record&&this.config.record.richtext)||MODx.request.reload||MODx.request.activeSave==1){this.markDirty();}
if(MODx.config.confirm_navigation==1){var panel=this;window.onbeforeunload=function(){if(panel.warnUnsavedChanges)return _('unsaved_changes');};}
if(this.config.record.deleted){this.handlePreview('hide');}}
if(MODx.config.use_editor&&MODx.loadRTE){var f=this.getForm().findField('richtext');if(f&&f.getValue()==1&&!this.rteLoaded){MODx.loadRTE(this.rteElements);this.rteLoaded=true;}else if(f&&f.getValue()==0&&this.rteLoaded){if(MODx.unloadRTE){MODx.unloadRTE(this.rteElements);}
this.rteLoaded=false;}}
this.fireEvent('ready');this.initialized=true;MODx.fireEvent('ready');MODx.sleep(4);if(MODx.afterTVLoad){MODx.afterTVLoad();}
this.fireEvent('load');},handlePreview:function(action){var previewBtn=Ext.getCmp('modx-abtn-preview');if(previewBtn==undefined){Ext.defer(function(){this.handlePreview(action);},200,this);}else{var toolBar=Ext.getCmp('modx-page-update-resource').ab,btnIndex=toolBar.items.indexOf(previewBtn);previewBtn[action]();toolBar.items.get(btnIndex+1)[action]();}},beforeDestroy:function(){if(this.rteLoaded&&MODx.unloadRTE){MODx.unloadRTE(this.rteElements);this.rteLoaded=false;}
MODx.panel.Resource.superclass.beforeDestroy.call(this);},beforeSubmit:function(o){var ta=Ext.get('ta');if(ta){var v=ta.dom.value;var hc=Ext.getCmp('hiddenContent');if(hc){hc.setValue(v);}}
var g=Ext.getCmp('modx-grid-resource-security');if(g){Ext.apply(o.form.baseParams,{resource_groups:g.encode()});}
if(ta){this.cleanupEditor();}
if(this.getForm().baseParams.action=='resource/create'){var btn=Ext.getCmp('modx-abtn-save');if(btn){btn.disable();}}
return this.fireEvent('save',{values:this.getForm().getValues(),stay:Ext.state.Manager.get('modx.stay.'+MODx.request.a,'stay')});},success:function(o){this.warnUnsavedChanges=false;var g=Ext.getCmp('modx-grid-resource-security');if(g){g.getStore().commitChanges();}
var t=Ext.getCmp('modx-resource-tree');if(t){var ctx=Ext.getCmp('modx-resource-context-key').getValue();var pa=Ext.getCmp('modx-resource-parent-hidden').getValue();var pao=Ext.getCmp('modx-resource-parent-old-hidden').getValue();var v=ctx+'_'+pa;var n=t.getNodeById(v);if(pa!==pao){t.refresh();Ext.getCmp('modx-resource-parent-old-hidden').setValue(pa);}else{if(typeof n!=="undefined"){n.leaf=false;}
t.refreshNode(v,true);}}
var object=o.result.object;if(this.config.resource&&object.parent!==undefined&&(object.class_key!=this.defaultClassKey||object.parent!=this.defaultValues.parent)){location.href=location.href;}else{if(object.deleted!==this.record.deleted){if(object.deleted){var action='hide';}else{action='show';}
this.handlePreview(action);}
this.record=object;this.getForm().setValues(object);Ext.getCmp('modx-page-update-resource').config.preview_url=object.preview_url;}},failure:function(o){this.warnUnsavedChanges=true;if(this.getForm().baseParams.action=='resource/create'){var btn=Ext.getCmp('modx-abtn-save');if(btn){btn.enable();}}},freezeUri:function(cb){var uri=Ext.getCmp('modx-resource-uri');if(!uri){return false;}
if(cb.checked){uri.show();}else{uri.hide();}},templateWarning:function(){var t=Ext.getCmp('modx-resource-template');if(!t){return false;}
if(t.getValue()!==t.originalValue){Ext.Msg.confirm(_('warning'),_('resource_change_template_confirm'),function(e){if(e=='yes'){var nt=t.getValue();var f=Ext.getCmp('modx-page-update-resource');f.config.action='resource/reload';this.warnUnsavedChanges=false;MODx.activePage.submitForm({success:{fn:function(r){MODx.loadPage(r.result.object.action,'id='+r.result.object.id+'&reload='+r.result.object.reload+'&class_key='+r.result.object.class_key);},scope:this}},{bypassValidCheck:true},{reloadOnly:true});}else{t.setValue(this.config.record.template);}},this);}},onFieldChange:function(o){if(o&&o.field&&o.field.name=='syncsite')return;if(this.isReady||MODx.request.reload){this.warnUnsavedChanges=true;}},cleanupEditor:function(){if(MODx.onSaveEditor){var fld=Ext.getCmp('ta');if(fld){MODx.onSaveEditor(fld);}}},getFields:function(config){var it=[];it.push({title:_(this.classLexiconKey),id:'modx-resource-settings',cls:'modx-resource-tab',layout:'form',labelAlign:'top',labelSeparator:'',bodyCssClass:'tab-panel-wrapper main-wrapper',autoHeight:true,defaults:{border:false,msgTarget:'under',width:400},items:this.getMainFields(config)});it.push({id:'modx-page-settings',title:_('settings'),cls:'modx-resource-tab',layout:'form',forceLayout:true,deferredRender:false,labelWidth:200,bodyCssClass:'main-wrapper',autoHeight:true,defaults:{border:false,msgTarget:'under'},items:this.getSettingFields(config)});if(config.show_tvs&&MODx.config.tvs_below_content!=1){it.push(this.getTemplateVariablesPanel(config));}
if(MODx.perm.resourcegroup_resource_list==1){it.push(this.getAccessPermissionsTab(config));}
var its=[];its.push(this.getPageHeader(config),{id:'modx-resource-tabs',xtype:'modx-tabs',forceLayout:true,deferredRender:false,collapsible:true,animCollapse:false,itemId:'tabs',items:it});var ct=this.getContentField(config);if(ct){its.push({title:_('resource_content'),id:'modx-resource-content',layout:'form',bodyCssClass:'main-wrapper',autoHeight:true,collapsible:true,animCollapse:false,hideMode:'offsets',items:ct});}
if(MODx.config.tvs_below_content==1){var tvs=this.getTemplateVariablesPanel(config);its.push(tvs);}
return its;},getPageHeader:function(config){config=config||{record:{}};return{html:'<h2>'+_('document_new')+'</h2>',id:'modx-resource-header',cls:'modx-page-header',border:false,forceLayout:true,anchor:'100%'};},getTemplateVariablesPanel:function(config){return{xtype:'modx-panel-resource-tv',collapsed:false,resource:config.resource,class_key:config.record.class_key||'modDocument',template:config.record.template,anchor:'100%',border:true,style:'visibility: visible'};},getMainFields:function(config){config=config||{record:{}};return[{layout:'column',border:false,anchor:'100%',id:'modx-resource-main-columns',defaults:{labelSeparator:'',labelAlign:'top',border:false,msgTarget:'under'},items:[{columnWidth:.67,layout:'form',id:'modx-resource-main-left',defaults:{msgTarget:'under'},items:this.getMainLeftFields(config)},{columnWidth:.33,layout:'form',labelWidth:0,border:false,id:'modx-resource-main-right',style:'margin-right: 0',defaults:{msgTarget:'under'},items:this.getMainRightFields(config)}]},{html:MODx.onDocFormRender,border:false},{xtype:'hidden',fieldLabel:_('id'),hideLabel:true,description:'<b>[[*id]]</b><br />',name:'id',id:'modx-resource-id',anchor:'100%',value:config.resource||config.record.id,submitValue:true},{xtype:'hidden',name:'type',value:'document'},{xtype:'hidden',name:'context_key',id:'modx-resource-context-key',value:config.record.context_key||'web'},{xtype:'hidden',name:'content',id:'hiddenContent',value:(config.record.content||config.record.ta)||''},{xtype:'hidden',name:'create-resource-token',id:'modx-create-resource-token',value:config.record.create_resource_token||''},{xtype:'hidden',name:'reloaded',value:!Ext.isEmpty(MODx.request.reload)?1:0},{xtype:'hidden',name:'parent',value:config.record.parent||0,id:'modx-resource-parent-hidden'},{xtype:'hidden',name:'parent-original',value:config.record.parent||0,id:'modx-resource-parent-old-hidden'}];},getMainLeftFields:function(config){config=config||{record:{}};return[{xtype:'textfield',fieldLabel:_('resource_pagetitle')+'<span class="required">*</span>',description:'<b>[[*pagetitle]]</b><br />'+_('resource_pagetitle_help'),name:'pagetitle',id:'modx-resource-pagetitle',maxLength:255,anchor:'100%',allowBlank:false,enableKeyEvents:true,listeners:{'keyup':{scope:this,fn:function(f,e){var titlePrefix=MODx.request.a=='resource/create'?_('new_document'):_('document');var title=Ext.util.Format.stripTags(f.getValue());Ext.getCmp('modx-resource-header').getEl().update('<h2>'+title+'</h2>');}}}},{xtype:'textfield',fieldLabel:_('resource_longtitle'),description:'<b>[[*longtitle]]</b><br />'+_('resource_longtitle_help'),name:'longtitle',id:'modx-resource-longtitle',maxLength:255,anchor:'100%',value:config.record.longtitle||''},{xtype:'textarea',fieldLabel:_('resource_description'),description:'<b>[[*description]]</b><br />'+_('resource_description_help'),name:'description',id:'modx-resource-description',maxLength:255,anchor:'100%',value:config.record.description||''},{xtype:'textarea',fieldLabel:_('resource_summary'),description:'<b>[[*introtext]]</b><br />'+_('resource_summary_help'),name:'introtext',id:'modx-resource-introtext',grow:true,anchor:'100%',value:config.record.introtext||''}];},getMainRightFields:function(config){config=config||{};var aliasLength=~~MODx.config['friendly_alias_max_length']||0;return[{xtype:'modx-combo-template',fieldLabel:_('resource_template'),description:'<b>[[*template]]</b><br />'+_('resource_template_help'),name:'template',id:'modx-resource-template',anchor:'100%',editable:false,baseParams:{action:'element/template/getList',combo:'1',limit:0},listeners:{'select':{fn:this.templateWarning,scope:this}}},{xtype:'textfield',fieldLabel:_('resource_alias'),description:'<b>[[*alias]]</b><br />'+_('resource_alias_help'),name:'alias',id:'modx-resource-alias',maxLength:(aliasLength>255||aliasLength===0)?255:aliasLength,anchor:'100%',value:config.record.alias||''},{xtype:'textfield',fieldLabel:_('resource_menutitle'),description:'<b>[[*menutitle]]</b><br />'+_('resource_menutitle_help'),name:'menutitle',id:'modx-resource-menutitle',maxLength:255,anchor:'100%',value:config.record.menutitle||''},{xtype:'textfield',fieldLabel:_('resource_link_attributes'),description:'<b>[[*link_attributes]]</b><br />'+_('resource_link_attributes_help'),name:'link_attributes',id:'modx-resource-link-attributes',maxLength:255,anchor:'100%',value:config.record.link_attributes||''},{xtype:'xcheckbox',boxLabel:_('resource_hide_from_menus'),hideLabel:true,description:'<b>[[*hidemenu]]</b><br />'+_('resource_hide_from_menus_help'),name:'hidemenu',id:'modx-resource-hidemenu',inputValue:1,checked:parseInt(config.record.hidemenu)||false},{xtype:'xcheckbox',boxLabel:_('resource_published'),hideLabel:true,description:'<b>[[*published]]</b><br />'+_('resource_published_help'),name:'published',id:'modx-resource-published',inputValue:1,checked:parseInt(config.record.published)}]},getSettingFields:function(config){config=config||{record:{}};var s=[{layout:'column',border:false,anchor:'100%',defaults:{labelSeparator:'',labelAlign:'top',border:false,layout:'form',msgTarget:'under'},items:[{columnWidth:.5,id:'modx-page-settings-left',defaults:{msgTarget:'under'},items:this.getSettingLeftFields(config)},{columnWidth:.5,id:'modx-page-settings-right',defaults:{msgTarget:'under'},items:this.getSettingRightFields(config)}]}];return s;},getSettingLeftFields:function(config){return[{xtype:'modx-field-parent-change',fieldLabel:_('resource_parent'),description:'<b>[[*parent]]</b><br />'+_('resource_parent_help'),name:'parent-cmb',id:'modx-resource-parent',value:config.record.parent||0,anchor:'100%'},{xtype:'modx-combo-class-derivatives',fieldLabel:_('resource_type'),description:'<b>[[*class_key]]</b><br />',name:'class_key',hiddenName:'class_key',id:'modx-resource-class-key',allowBlank:false,value:config.record.class_key||'modDocument',anchor:'100%'},{xtype:'modx-combo-content-type',fieldLabel:_('resource_content_type'),description:'<b>[[*content_type]]</b><br />'+_('resource_content_type_help'),name:'content_type',hiddenName:'content_type',id:'modx-resource-content-type',anchor:'100%',value:config.record.content_type||(MODx.config.default_content_type||1)},{xtype:'modx-combo-content-disposition',fieldLabel:_('resource_contentdispo'),description:'<b>[[*content_dispo]]</b><br />'+_('resource_contentdispo_help'),name:'content_dispo',hiddenName:'content_dispo',id:'modx-resource-content-dispo',anchor:'100%',value:config.record.content_dispo||0},{xtype:'numberfield',fieldLabel:_('resource_menuindex'),description:'<b>[[*menuindex]]</b><br />'+_('resource_menuindex_help'),name:'menuindex',id:'modx-resource-menuindex',width:75,value:parseInt(config.record.menuindex)||0}];},getSettingRightFields:function(config){return[{xtype:'xdatetime',fieldLabel:_('resource_publishedon'),description:'<b>[[*publishedon]]</b><br />'+_('resource_publishedon_help'),name:'publishedon',id:'modx-resource-publishedon',allowBlank:true,dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format,startDay:parseInt(MODx.config.manager_week_start),dateWidth:120,timeWidth:120,offset_time:MODx.config.server_offset_time,value:config.record.publishedon},{xtype:MODx.config.publish_document?'xdatetime':'hidden',fieldLabel:_('resource_publishdate'),description:'<b>[[*pub_date]]</b><br />'+_('resource_publishdate_help'),name:'pub_date',id:'modx-resource-pub-date',allowBlank:true,dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format,startDay:parseInt(MODx.config.manager_week_start),dateWidth:120,timeWidth:120,offset_time:MODx.config.server_offset_time,value:config.record.pub_date},{xtype:MODx.config.publish_document?'xdatetime':'hidden',fieldLabel:_('resource_unpublishdate'),description:'<b>[[*unpub_date]]</b><br />'+_('resource_unpublishdate_help'),name:'unpub_date',id:'modx-resource-unpub-date',allowBlank:true,dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format,startDay:parseInt(MODx.config.manager_week_start),dateWidth:120,timeWidth:120,offset_time:MODx.config.server_offset_time,value:config.record.unpub_date},{xtype:'fieldset',items:this.getSettingRightFieldset(config)}];},getSettingRightFieldset:function(config){return[{layout:'column',id:'modx-page-settings-box-columns',border:false,anchor:'100%',defaults:{labelSeparator:'',labelAlign:'top',border:false,layout:'form',msgTarget:'under'},items:[{columnWidth:.5,id:'modx-page-settings-right-box-left',defaults:{msgTarget:'under'},items:this.getSettingRightFieldsetLeft(config)},{columnWidth:.5,id:'modx-page-settings-right-box-right',defaults:{msgTarget:'under'},items:this.getSettingRightFieldsetRight(config)}]},{xtype:'xcheckbox',boxLabel:_('resource_uri_override'),description:_('resource_uri_override_help'),hideLabel:true,name:'uri_override',value:1,checked:parseInt(config.record.uri_override)?true:false,id:'modx-resource-uri-override'},{xtype:'textfield',fieldLabel:_('resource_uri'),description:'<b>[[*uri]]</b><br />'+_('resource_uri_help'),name:'uri',id:'modx-resource-uri',maxLength:255,anchor:'70%',value:config.record.uri||'',hidden:!config.record.uri_override}];},getSettingRightFieldsetLeft:function(config){return[{xtype:'xcheckbox',boxLabel:_('resource_folder'),description:'<b>[[*isfolder]]</b><br />'+_('resource_folder_help'),hideLabel:true,name:'isfolder',id:'modx-resource-isfolder',inputValue:1,checked:parseInt(config.record.isfolder)||0},{xtype:'xcheckbox',boxLabel:_('resource_searchable'),description:'<b>[[*searchable]]</b><br />'+_('resource_searchable_help'),hideLabel:true,name:'searchable',id:'modx-resource-searchable',inputValue:1,checked:parseInt(config.record.searchable)},{xtype:'xcheckbox',boxLabel:_('resource_richtext'),description:'<b>[[*richtext]]</b><br />'+_('resource_richtext_help'),hideLabel:true,name:'richtext',id:'modx-resource-richtext',inputValue:1,checked:parseInt(config.record.richtext)}];},getSettingRightFieldsetRight:function(config){return[{xtype:'xcheckbox',boxLabel:_('resource_cacheable'),description:'<b>[[*cacheable]]</b><br />'+_('resource_cacheable_help'),hideLabel:true,name:'cacheable',id:'modx-resource-cacheable',inputValue:1,checked:parseInt(config.record.cacheable)},{xtype:'xcheckbox',boxLabel:_('resource_syncsite'),description:_('resource_syncsite_help'),hideLabel:true,name:'syncsite',id:'modx-resource-syncsite',inputValue:1,checked:config.record.syncsite!==undefined&&config.record.syncsite!==null?parseInt(config.record.syncsite):true},{xtype:'xcheckbox',boxLabel:_('deleted'),description:'<b>[[*deleted]]</b>',hideLabel:true,name:'deleted',id:'modx-resource-deleted',inputValue:1,checked:parseInt(config.record.deleted)||false}];},getContentField:function(config){return[{id:'modx-content-above',border:false},{xtype:'textarea',name:'ta',id:'ta',hideLabel:true,anchor:'100%',height:400,grow:false,value:(config.record.content||config.record.ta)||''},{id:'modx-content-below',border:false}];},getAccessPermissionsTab:function(config){return{id:'modx-resource-access-permissions',autoHeight:true,title:_('resource_groups'),layout:'form',anchor:'100%',items:[{html:'<p>'+_('resource_access_message')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-resource-security',cls:'main-wrapper',preventRender:true,resource:config.resource,mode:config.mode||'update',"parent":config.record["parent"]||0,"token":config.record.create_resource_token,reloaded:!Ext.isEmpty(MODx.request.reload),listeners:{'afteredit':{fn:this.fieldChangeEvent,scope:this}}}]};}});Ext.reg('modx-panel-resource',MODx.panel.Resource);var triggerDirtyField=function(fld){Ext.getCmp('modx-panel-resource').fieldChangeEvent(fld);};MODx.triggerRTEOnChange=function(){triggerDirtyField(Ext.getCmp('ta'));};MODx.fireResourceFormChange=function(f,nv,ov){Ext.getCmp('modx-panel-resource').fireEvent('fieldChange');};;MODx.page.UpdateResource=function(config){config=config||{record:{}};config.record=config.record||{};Ext.apply(config.record,{'parent-cmb':config.record['parent']});Ext.applyIf(config,{url:MODx.config.connector_url,which_editor:'none',formpanel:'modx-panel-resource',id:'modx-page-update-resource',action:'resource/update',components:[{xtype:config.panelXType||'modx-panel-resource',renderTo:config.panelRenderTo||'modx-panel-resource-div',resource:config.resource,record:config.record||{},publish_document:config.publish_document,show_tvs:config.show_tvs,mode:config.mode,url:config.url}],buttons:this.getButtons(config)});MODx.page.UpdateResource.superclass.constructor.call(this,config);if(!Ext.isIE){Ext.EventManager.on(window,'beforeunload',function(e){MODx.releaseLock(this.config.resource);MODx.sleep(400);return false;},this);}
new Ext.KeyMap(Ext.getBody(),{key:'p',alt:true,ctrl:true,fn:this.preview,scope:this});};Ext.extend(MODx.page.UpdateResource,MODx.Component,{preview:function(){window.open(this.config.preview_url);return false;},duplicateResource:function(btn,e){MODx.msg.confirm({text:_('resource_duplicate_confirm'),url:MODx.config.connector_url,params:{action:'resource/duplicate',id:this.config.resource},listeners:{success:{fn:function(r){MODx.loadPage('resource/update','id='+r.object.id);},scope:this}}});},deleteResource:function(btn,e){MODx.msg.confirm({text:_('resource_delete_confirm'),url:MODx.config.connector_url,params:{action:'resource/delete',id:this.config.resource},listeners:{success:{fn:function(r){MODx.loadPage('resource/update','id='+r.object.id);},scope:this}}});},cancel:function(btn,e){var fp=Ext.getCmp(this.config.formpanel);if(fp&&fp.isDirty()){Ext.Msg.confirm(_('warning'),_('resource_cancel_dirty_confirm'),function(e){if(e=='yes'){fp.warnUnsavedChanges=false;MODx.releaseLock(MODx.request.id);MODx.sleep(400);MODx.loadPage('?');}},this);}else{MODx.releaseLock(MODx.request.id);MODx.loadPage('?');}},getButtons:function(cfg){var btns=[];if(cfg.canSave==1){btns.push({process:'resource/update',text:_('save'),id:'modx-abtn-save',cls:'primary-button',method:'remote',keys:[{key:MODx.config.keymap_save||'s',ctrl:true}]});}else if(cfg.locked){btns.push({text:cfg.lockedText||_('locked'),id:'modx-abtn-locked',handler:Ext.emptyFn,disabled:true});}
if(cfg.canDuplicate==1&&(cfg.record.parent!==parseInt(MODx.config.tree_root_id)||cfg.canCreateRoot==1)){btns.push({text:_('duplicate'),id:'modx-abtn-duplicate',handler:this.duplicateResource,scope:this});}
if(cfg.canDelete==1&&!cfg.locked){btns.push({text:_('delete'),id:'modx-abtn-delete',handler:this.deleteResource,scope:this});}
btns.push({text:_('view'),id:'modx-abtn-preview',handler:this.preview,scope:this});btns.push({text:_('cancel'),id:'modx-abtn-cancel',handler:this.cancel,scope:this});btns.push({text:_('help_ex'),id:'modx-abtn-help',handler:MODx.loadHelpPane});return btns;}});Ext.reg('modx-page-resource-update',MODx.page.UpdateResource);;Ext.Spotlight=function(config){Ext.apply(this,config);}
Ext.Spotlight.prototype={active:false,animate:true,animated:false,duration:.25,easing:'easeNone',createElements:function(){var bd=Ext.getBody();this.right=bd.createChild({cls:'x-spotlight'});this.left=bd.createChild({cls:'x-spotlight'});this.top=bd.createChild({cls:'x-spotlight'});this.bottom=bd.createChild({cls:'x-spotlight'});this.all=new Ext.CompositeElement([this.right,this.left,this.top,this.bottom]);},show:function(el,callback,scope){if(this.animated){this.show.defer(50,this,[el,callback,scope]);return;}
this.el=Ext.get(el);if(!this.right){this.createElements();}
if(!this.active){this.all.setDisplayed('');this.applyBounds(true,false);this.active=true;Ext.EventManager.onWindowResize(this.syncSize,this);this.applyBounds(false,this.animate,false,callback,scope);}else{this.applyBounds(false,false,false,callback,scope);}},hide:function(callback,scope){if(this.animated){this.hide.defer(50,this,[callback,scope]);return;}
Ext.EventManager.removeResizeListener(this.syncSize,this);this.applyBounds(true,this.animate,true,callback,scope);},doHide:function(){this.active=false;this.all.setDisplayed(false);},syncSize:function(){this.applyBounds(false,false);},applyBounds:function(basePts,anim,doHide,callback,scope){var rg=this.el.getRegion();var dw=Ext.lib.Dom.getViewWidth(true);var dh=Ext.lib.Dom.getViewHeight(true);var c=0,cb=false;if(anim){cb={callback:function(){c++;if(c==4){this.animated=false;if(doHide){this.doHide();}
Ext.callback(callback,scope,[this]);}},scope:this,duration:this.duration,easing:this.easing};this.animated=true;}
this.right.setBounds(rg.right,basePts?dh:rg.top,dw-rg.right,basePts?0:(dh-rg.top),cb);this.left.setBounds(0,0,rg.left,basePts?0:rg.bottom,cb);this.top.setBounds(basePts?dw:rg.left,0,basePts?0:dw-rg.left,rg.top,cb);this.bottom.setBounds(0,rg.bottom,basePts?0:rg.right,dh-rg.bottom,cb);if(!anim){if(doHide){this.doHide();}
if(callback){Ext.callback(callback,scope,[this]);}}},destroy:function(){this.doHide();Ext.destroy(this.right,this.left,this.top,this.bottom);delete this.el;delete this.all;}};;GAL.view.AlbumItems=function(config){config=config||{};this._initTemplates();Ext.applyIf(config,{url:GAL.config.connector_url,fields:['id','album','name','description','mediatype','url','createdon','createdby','filename','filesize','thumbnail','image','image_width','image_height','tags','active','rank','absoluteImage','relativeImage','menu'],ident:'galbit',id:'gal-album-items-view',baseParams:{action:'mgr/item/getList',album:config.album},loadingText:_('loading'),tpl:this.templates.thumb,enableDD:true,multiSelect:true,itemSelector:'div.modx-browser-thumb-wrap',listeners:{'selectionchange':{fn:this.showDetails,scope:this,buffer:100},'dblclick':config.onSelect||{fn:Ext.emptyFn,scope:this}},prepareData:this.formatData.createDelegate(this)});GAL.view.AlbumItems.superclass.constructor.call(this,config);this.on('selectionchange',this.showDetails,this,{buffer:100});this.addEvents('sort','select');this.on('sort',this.onSort,this);this.on('dblclick',this.onDblClick,this);};Ext.extend(GAL.view.AlbumItems,MODx.DataView,{templates:{},windows:{},onSort:function(o){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/item/sort',album:this.config.album,source:o.source.id,target:o.target.id}});},onDblClick:function(d,idx,n){var node=this.getSelectedNodes()[0];if(!node)return false;if(this.config.inPanel){this.cm.activeNode=node;this.updateItem(node,n);}else{var data=this.lookup[node.id];this.fireEvent('select',data);}},updateItem:function(btn,e){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;this.windows.updateItem=MODx.load({xtype:'gal-window-item-update',listeners:{'success':{fn:function(){this.store.reload();},scope:this}}});this.windows.updateItem.setValues(data);this.windows.updateItem.show(e.target);},setAsCover:function(btn,e){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/album/setCoverItem',id:data.id,albumid:data.album},listeners:{'success':{fn:function(r){var panel=Ext.getCmp('gal-panel-album');panel.getForm().setValues(r.object);},scope:this}}});},deleteItem:function(btn,e){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;MODx.msg.confirm({text:_('gallery.item_delete_confirm'),url:this.config.url,params:{action:'mgr/item/remove',id:data.id},listeners:{'success':{fn:function(r){this.store.reload();},scope:this}}});},deleteMultiple:function(btn,e){var recs=this.getSelectedRecords();if(!recs)return false;var ids='';for(var i=0;i<recs.length;i++){ids+=','+recs[i].id;}
MODx.msg.confirm({text:_('gallery.item_delete_multiple_confirm'),url:this.config.url,params:{action:'mgr/item/removeMultiple',ids:ids.substr(1)},listeners:{'success':{fn:function(r){this.store.reload();},scope:this}}});return true;},run:function(p){p=p||{};var v={};Ext.apply(v,this.store.baseParams);Ext.apply(v,p);this.pagingBar.changePage(1);this.store.baseParams=v;this.store.load();},sortBy:function(sel){this.store.baseParams.sorter=sel.getValue();this.store.reload();return true;},sortDir:function(sel){this.store.baseParams.dir=sel.getValue();this.store.reload();},showDetails:function(){var selNode=this.getSelectedNodes();var detailEl=Ext.getCmp('gal-album-items-detail').body;if(selNode&&selNode.length>0){selNode=selNode[0];var data=this.lookup[selNode.id];if(data){detailEl.hide();this.templates.details.overwrite(detailEl,data);detailEl.slideIn('l',{stopFx:true,duration:'.2'});}}else{detailEl.update('');}},formatData:function(data){var formatSize=function(data){if(data.size<1024){return data.size+' '+_('gallery.bytes');}else{return(Math.round(((data.size*10)/1024))/10)+" KB";}};data.shortName=Ext.util.Format.ellipsis(data.name,16);data.sizeString=formatSize(data);data.releasedon=new Date(data.releasedon).format("m/d/Y g:i a");this.lookup['gal-item-'+data.id]=data;return data;},_initTemplates:function(){this.templates.thumb=new Ext.XTemplate('<tpl for=".">','<div class="modx-browser-thumb-wrap modx-pb-thumb-wrap <tpl if="!active">gal-item-inactive</tpl>" id="gal-item-{id}">','<div class="modx-browser-thumb gal-item-thumb">','<img src="{thumbnail}" title="{name}" />','</div>','<span>{shortName}</span>','</div>','</tpl>');this.templates.thumb.compile();this.templates.details=new Ext.XTemplate('<div class="details">','<tpl for=".">','<div class="modx-browser-detail-thumb modx-pb-detail-thumb"><img src="{image}" alt="{shortName}" onclick="Ext.getCmp(\'gal-album-items-view\').showScreenshot(\'{id}\'); return false;" /></div>','<div class="modx-browser-details-info modx-pb-details-info">','<span class="gal-detail-active">','<tpl if="active"><span class="green">'+_('gallery.active')+'</span></tpl>','<tpl if="!active"><span class="red">'+_('gallery.inactive')+'</span></tpl>','</span>','<h4>{shortName}</h4><br />','<tpl if="description"><p>{description}</p><br /></tpl>','<b>'+_('id')+':</b><span>{id}</span>','<b>'+_('gallery.file_name')+':</b><span>{filename}</span>','<b>'+_('gallery.file_size')+':</b><span>{filesize}</span>','<tpl if="tags"><b>'+_('gallery.tags')+':</b><span>{tags}</span></tpl>','<tpl if="url"><b>'+_('gallery.item_url')+':</b><span>{url}</span></tpl>','</div>','</tpl>','</div>');this.templates.details.compile();},showScreenshot:function(id){var data=this.lookup['gal-item-'+id];if(!data)return false;if(!this.ssWin){this.ssWin=new Ext.Window({layout:'fit',width:600,height:450,closeAction:'hide',plain:true,items:[{id:'gal-item-ss',html:''}],buttons:[{text:_('close'),handler:function(){this.ssWin.hide();},scope:this}]});}
this.ssWin.show();this.ssWin.setSize(data.image_width,data.image_height);this.ssWin.center();this.ssWin.setTitle(data.name);Ext.get('gal-item-ss').update('<img src="'+data.image+'" alt="" onclick="Ext.getCmp(\'gal-album-items-view\').ssWin.hide();" />');},_showContextMenu:function(v,i,n,e){e.preventDefault();var data=this.lookup[n.id];var m=this.cm;m.removeAll();var ct=this.getSelectionCount();if(ct==1){m.add({text:_('gallery.item_update'),handler:this.updateItem,scope:this});m.add({text:_('gallery.set_as_cover'),handler:this.setAsCover,scope:this});m.add('-');m.add({text:_('gallery.item_delete'),handler:this.deleteItem,scope:this});m.show(n,'tl-c?');}else if(ct>1){m.add({text:_('gallery.item_delete_multiple'),handler:this.deleteMultiple,scope:this});m.show(n,'tl-c?');}
m.activeNode=n;}});Ext.reg('gal-view-album-items',GAL.view.AlbumItems);;GAL.tree.Album=function(config){config=config||{};Ext.applyIf(config,{id:'gal-tree-album',url:GAL.config.connector_url,action:'mgr/album/getNodes',tbar:[{text:_('gallery.album_create'),cls:'primary-button',handler:function(btn,e){this.createAlbum(btn,e,true);},scope:this},'-',{text:_('gallery.refresh'),handler:this.refresh,scope:this}],sortAction:'mgr/album/sort',rootVisible:false});GAL.tree.Album.superclass.constructor.call(this,config);};Ext.extend(GAL.tree.Album,MODx.tree.Tree,{windows:{},createAlbum:function(btn,e,b){b=b||false;var r;if(this.cm.activeNode&&!b){var n=this.cm.activeNode.attributes;r={'parent':n.pk,parent_name:n.name};}else{r={'parent':0,parent_name:_('none')};}
if(!this.windows.createAlbum){this.windows.createAlbum=MODx.load({xtype:'gal-window-album-create',record:r,listeners:{'success':{fn:function(){this.refresh();},scope:this}}});}
this.windows.createAlbum.fp.getForm().reset();this.windows.createAlbum.setValues(r);this.windows.createAlbum.show(e.target);},updateAlbum:function(btn,e){var id=this.cm.activeNode?this.cm.activeNode.attributes.pk:0;location.href='?a='+GAL.action+'&album='+id+'&action=album/update';},removeAlbum:function(btn,e){if(!this.cm.activeNode)return false;MODx.msg.confirm({text:_('gallery.album_remove_confirm'),url:this.config.url,params:{action:'mgr/album/remove',id:this.cm.activeNode.attributes.pk},listeners:{'success':{fn:function(r){this.refresh();},scope:this}}});},_handleDrag:function(dropEvent){var encNodes=this.encode();MODx.Ajax.request({url:this.config.url,params:{data:encNodes,action:this.config.sortAction},listeners:{'success':{fn:function(r){this.reloadNode(dropEvent.target.parentNode);},scope:this},'failure':{fn:function(r){MODx.form.Handler.errorJSON(r);return false;},scope:this}}});},_handleDrop:function(e){var target=e.target;var source=e.dropNode;var ap=true;return target.getDepth()<=source.getDepth()&&ap;}});Ext.reg('gal-tree-album',GAL.tree.Album);;GAL.Browser=function(config){if(GAL.browserOpen)return false;GAL.browserOpen=true;config=config||{};Ext.applyIf(config,{onSelect:function(data){},scope:this,cls:'modx-browser'});GAL.Browser.superclass.constructor.call(this,config);this.config=config;this.win=new GAL.BrowserWindow(config);this.win.reset();};Ext.extend(GAL.Browser,Ext.Component,{show:function(el){this.win.show(el);},hide:function(){this.win.hide();}});Ext.reg('gal-browser',GAL.Browser);GAL.BrowserWindow=function(config){config=config||{};this.ident=Ext.id();this.view=MODx.load({xtype:'gal-view-album-items',cls:'modx-pb-view-ct',album:config.album||0,listeners:{'select':{fn:this.onSelect,scope:this}}});this.view.pagingBar=new Ext.PagingToolbar({pageSize:24,store:this.view.store,displayInfo:true,autoLoad:true});this.tree=MODx.load({xtype:'gal-tree-album',scope:this,ident:this.ident,rootVisible:config.rootVisible==null?true:config.rootVisible,listeners:{'click':{fn:function(node,e){this.load(node.attributes.pk);return false;e.stopPropagation();e.preventDefault();},scope:this}},tbar:[]});Ext.applyIf(config,{title:_('gallery.browser'),cls:'modx-pb-win',layout:'border',minWidth:500,minHeight:300,width:'90%',height:500,modal:false,closeAction:'hide',border:false,items:[{id:this.ident+'-browser-tree',cls:'modx-pb-browser-tree',region:'west',width:250,height:'100%',items:this.tree,border:false,autoScroll:true},{id:this.ident+'-browser-view',cls:'modx-pb-view-ct',region:'center',autoScroll:true,width:450,items:this.view,border:false,tbar:this.getToolbar(),bbar:[this.view.pagingBar]},{html:'',id:'gal-album-items-detail',region:'east',split:true,autoScroll:true,width:'20%',minWidth:150,maxWidth:250,height:450,border:false}],buttons:[{id:this.ident+'-ok-btn',text:_('ok'),handler:this.onSelect,scope:this},{text:_('cancel'),handler:this.hide,scope:this}],keys:{key:27,handler:this.hide,scope:this}});GAL.BrowserWindow.superclass.constructor.call(this,config);this.config=config;this.addEvents({'select':true});};Ext.extend(GAL.BrowserWindow,Ext.Window,{returnEl:null,filter:function(){var filter=Ext.getCmp('filter');this.view.store.filter('name',filter.getValue(),true);this.view.select(0);},setReturn:function(el){this.returnEl=el;},load:function(id){this.view.run({album:id});},sortImages:function(){var v=Ext.getCmp('sortSelect').getValue();this.view.store.sort(v,v=='name'?'asc':'desc');this.view.select(0);},reset:function(){if(this.rendered){Ext.getCmp('filter').reset();this.view.getEl().dom.scrollTop=0;}
this.view.store.clearFilter();this.view.select(0);},getToolbar:function(){return[{text:_('filter')+':'},{xtype:'textfield',id:'filter',selectOnFocus:true,width:100,listeners:{'render':{fn:function(){Ext.getCmp('filter').getEl().on('keyup',function(){this.filter();},this,{buffer:500});},scope:this}}},' ','-',{text:_('sort_by')+':'},{id:'sortSelect',xtype:'combo',typeAhead:true,triggerAction:'all',width:100,editable:false,mode:'local',displayField:'desc',valueField:'name',lazyInit:false,value:'name',store:new Ext.data.SimpleStore({fields:['name','desc'],data:[['name',_('name')],['createdon',_('createdon')],['rank',_('rank')]]}),listeners:{'select':{fn:this.sortImages,scope:this}}},'-',{icon:MODx.config.template_url+'images/restyle/icons/refresh.png',cls:'x-btn-icon',tooltip:{text:_('tree_refresh')},handler:this.load,scope:this}];},onSelect:function(data){var selNode=this.view.getSelectedNodes()[0];var callback=this.config.onSelect||this.onSelectHandler;var lookup=this.view.lookup;var scope=this.config.scope;this.hide(this.config.animEl||null,function(){if(selNode&&callback){var data=lookup[selNode.id];Ext.callback(callback,scope||this,[data]);this.fireEvent('select',data);if(window.top.opener){window.top.close();window.top.opener.focus();}}},scope);},onSelectHandler:function(data){Ext.get(this.returnEl).dom.value=unescape(data.url);}});Ext.reg('gal-browser-window',GAL.BrowserWindow);