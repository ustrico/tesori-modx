var GAL=function(config){config=config||{};GAL.superclass.constructor.call(this,config);};Ext.extend(GAL,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},view:{}});Ext.reg('gallery',GAL);GAL=new GAL();GAL.window.CreateAlbum=function(config){config=config||{};this.ident=config.ident||'gcalb'+Ext.id();Ext.applyIf(config,{title:_('gallery.album_create'),id:this.ident,width:600,url:GAL.config.connector_url,action:'mgr/album/create',fields:[{xtype:'hidden',name:'parent'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:config.record['parent']==0?'hidden':'statictextfield',fieldLabel:_('gallery.parent'),name:'parent_name',id:this.ident+'-parent-name',anchor:'100%'},{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'}]},{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('gallery.year'),name:'year',anchor:'100%',allowBlank:true},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.active_desc'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.prominent'),description:MODx.expandHelp?'':_('gallery.prominent_desc'),name:'prominent',id:this.ident+'-prominent',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-prominent',text:_('gallery.prominent_desc'),cls:'desc-under'}]}]}]});GAL.window.CreateAlbum.superclass.constructor.call(this,config);};Ext.extend(GAL.window.CreateAlbum,MODx.Window);Ext.reg('gal-window-album-create',GAL.window.CreateAlbum);GAL.window.UpdateItem=function(config){config=config||{};this.ident=config.ident||'gupdit'+Ext.id();Ext.applyIf(config,{title:_('gallery.item_update'),id:this.ident,closeAction:'close',width:600,url:GAL.config.connector_url,action:'mgr/item/update',fileUpload:true,fields:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'},{xtype:'textfield',fieldLabel:_('gallery.item_url'),description:MODx.expandHelp?'':_('gallery.item_url_desc'),name:'url',id:this.ident+'-item-url',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-item-url',text:_('gallery.item_url_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'hidden',name:'thumbnail'},{xtype:'hidden',name:'image'},{html:'',id:this.ident+'-preview'},{xtype:'statictextfield',name:'id',fieldLabel:_('id'),submitValue:true,anchor:'100%'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]}]});GAL.window.UpdateItem.superclass.constructor.call(this,config);this.on('activate',function(w,e){if(typeof Tiny!='undefined'){MODx.loadRTE(this.ident+'-description');}
var d=this.fp.getForm().getValues();if(d&&d.image){var p=Ext.getCmp(this.ident+'-preview');var u=d.image+'&h=200&w=200&zc=1&q=100&f=png';p.update('<div class="gal-item-update-preview"><img src="'+u+'" alt="" onclick="Ext.getCmp(\'gal-album-items-view\').showScreenshot(\''+d.id+'\'); return false;" /></div>');}},this);};Ext.extend(GAL.window.UpdateItem,MODx.Window);Ext.reg('gal-window-item-update',GAL.window.UpdateItem);GAL.window.UploadItem=function(config){config=config||{};this.ident=config.ident||'gupit'+Ext.id();Ext.applyIf(config,{title:_('gallery.item_upload'),id:this.ident,width:600,url:GAL.config.connector_url,action:'mgr/item/upload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,cls:(MODx.config.connector_url)?'':'main-wrapper',labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'},{xtype:'textfield',fieldLabel:_('gallery.item_url'),description:_('gallery.item_url_desc'),name:'url',id:this.ident+'-item-url',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-item-url',text:_('gallery.item_url_desc'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.file'),description:MODx.expandHelp?'':_('gallery.item_upload_file_desc'),name:'file',id:this.ident+'-file',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-file',text:_('gallery.item_upload_file_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),name:'active',description:'',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]}]});GAL.window.UploadItem.superclass.constructor.call(this,config);this.on('activate',function(){if(typeof Tiny!='undefined'){MODx.loadRTE(this.ident+'-description');}});};Ext.extend(GAL.window.UploadItem,MODx.Window);Ext.reg('gal-window-item-upload',GAL.window.UploadItem);GAL.window.UploadCover=function(config){config=config||{};this.ident=config.ident||'gupit'+Ext.id();Ext.applyIf(config,{title:_('gallery.cover_upload'),id:this.ident,height:300,saveBtnText:_('gallery.upload_cover'),url:GAL.config.connector_url,action:'mgr/album/uploadcover',fileUpload:true,fields:[{xtype:'hidden',name:'albumid'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',border:false,cls:(MODx.config.connector_url)?'':'main-wrapper',labelSeparator:''},items:[{columnWidth:1,items:[{xtype:'hidden',name:'id'},{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.file'),description:MODx.expandHelp?'':_('gallery.item_upload_file_desc'),name:'file',id:this.ident+'-file',anchor:'100%'},{xtype:'panel',fieldLabel:_('gallery.current_cover'),html:'',id:this.ident+'-preview'}]}]}]});GAL.window.UploadCover.superclass.constructor.call(this,config);};Ext.extend(GAL.window.UploadCover,MODx.Window);Ext.reg('gal-window-cover-update',GAL.window.UploadCover);GAL.window.UploadMultiItems=function(config){config=config||{};this.ident=config.ident||'gupmuit'+Ext.id();Ext.applyIf(config,{title:_('gallery.multi_item_upload'),id:this.ident,height:350,fields:[{xtype:'hidden',name:'album'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'checkbox',boxLabel:_('gallery.active'),hideLabel:true,name:'active',description:'',id:this.ident+'-active',checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]},{html:'<div id="file-upload" />'+_('gallery.loading_ellipsis')+'</div>',id:'file-upload-field',xtype:'panel'}],buttons:[{text:_('done'),scope:this,handler:function(){this.hide();}}],keys:[]});GAL.window.UploadMultiItems.superclass.constructor.call(this,config);this.on('show',this.setup,this)};Ext.extend(GAL.window.UploadMultiItems,MODx.Window,{setup:function(){if(typeof GAL.uploader=='undefined'){GAL.uploader=new qq.FileUploader({element:document.getElementById('file-upload'),action:GAL.config.connector_url,params:{action:'mgr/item/ajaxupload',album:this.config.album,HTTP_MODAUTH:MODx.siteId},onComplete:function(){GAL.uploader.win.fireEvent('success');},onSubmit:function(){var f=GAL.uploader.win.fp.getForm();var data={active:f.findField('active').getValue()?1:0,tags:f.findField('tags').getValue()};var p=this.params;Ext.apply(p,data);GAL.uploader.setParams(p);}});GAL.uploader.win=this;}}});Ext.reg('gal-window-multi-item-upload',GAL.window.UploadMultiItems);GAL.window.BatchUpload=function(config){config=config||{};this.ident=config.ident||'gupbu'+Ext.id();Ext.applyIf(config,{title:_('gallery.batch_upload'),id:this.ident,url:GAL.config.connector_url,action:'mgr/item/batchupload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{xtype:'textfield',fieldLabel:_('gallery.directory'),description:MODx.expandHelp?'':_('gallery.batch_upload_intro'),name:'directory',id:this.ident+'-directory',anchor:'100%',value:MODx.config['gallery.default_batch_upload_path']||'{assets_path}images/'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-directory',text:_('gallery.batch_upload_intro'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.batch_upload_tags'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.batch_upload_tags'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]});GAL.window.BatchUpload.superclass.constructor.call(this,config);};Ext.extend(GAL.window.BatchUpload,MODx.Window);Ext.reg('gal-window-batch-upload',GAL.window.BatchUpload);GAL.window.ZipUpload=function(config){config=config||{};this.ident=config.ident||'gupbu'+Ext.id();Ext.applyIf(config,{title:_('gallery.zip_upload'),id:this.ident,url:GAL.config.connector_url,action:'mgr/item/zipupload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.zip_file'),description:MODx.expandHelp?'':_('gallery.zip_upload_intro'),name:'zip',id:this.ident+'-zip',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-zip',text:_('gallery.zip_upload_intro'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.batch_upload_tags'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.batch_upload_tags'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]});GAL.window.ZipUpload.superclass.constructor.call(this,config);};Ext.extend(GAL.window.ZipUpload,MODx.Window);Ext.reg('gal-window-zip-upload',GAL.window.ZipUpload);;var galTreeHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gal-tree-handler'});galTreeHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galTreeHandlerClass,Ext.Component,{tree:null,data:{},windows:{},getMenu:function(t,node,e){this.tree=t;this.data=node.attributes&&node.attributes.data?node.attributes.data:{};var m=[];switch(node.attributes.type){case'root':m=this.getRootMenu(node,e);break;case'gallery-album':m=this.getAlbumMenu(node,e);break;case'gallery-item':m=this.getItemMenu(node,e);break;}
return m;},getItemMenu:function(node,e){return[{text:_('gallery.item_update'),handler:this.updateItem,scope:this},'-',{text:_('gallery.item_remove'),handler:this.removeItem,scope:this}];},getAlbumMenu:function(node,e){return[{text:_('gallery.album_create'),handler:this.createAlbum,scope:this},'-',{text:_('gallery.album_update'),handler:this.updateAlbum,scope:this},{text:_('gallery.upload'),menu:{items:[{text:_('gallery.item_upload'),handler:this.uploadItem,scope:this},{text:_('gallery.multi_item_upload'),handler:this.uploadMultiItems,scope:this},{text:_('gallery.batch_upload'),handler:this.batchUpload,scope:this},{text:_('gallery.zip_upload'),handler:this.zipUpload,scope:this}]}},'-',{text:_('gallery.album_remove'),handler:this.removeAlbum,scope:this}];},getRootMenu:function(node,e){return[{text:_('gallery.album_create'),handler:this.createAlbum,scope:this}];},createAlbum:function(btn,e){var r;if(this.data.id){var n=this.tree.cm.activeNode.attributes.data;r={'parent':n.id,parent_name:n.name};}else{r={'parent':0,parent_name:_('none')};}
if(!this.windows.createAlbum){this.windows.createAlbum=MODx.load({xtype:'gal-window-album-create',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.createAlbum.fp.getForm().reset();this.windows.createAlbum.setValues(r);this.windows.createAlbum.show(e.target);},updateAlbum:function(btn,e){var id=this.data.id?this.data.id:0;location.href='?a='+MODx.action['gallery:index']+'&album='+id+'&action=album/update';},removeAlbum:function(btn,e){MODx.msg.confirm({text:_('gallery.album_remove_confirm'),url:GAL.config.connector_url,params:{action:'mgr/album/remove',id:this.tree.cm.activeNode.attributes.data.id},listeners:{'success':{fn:function(r){this.tree.refreshParentNode();},scope:this}}});},updateItem:function(btn,e){this.windows.updateItem=MODx.load({xtype:'gal-window-item-update',listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});this.windows.updateItem.setValues(this.data);this.windows.updateItem.show(e.target);},removeItem:function(btn,e){MODx.msg.confirm({text:_('gallery.item_delete_confirm'),url:GAL.config.connector_url,params:{action:'mgr/item/remove',id:this.data.id},listeners:{'success':{fn:function(r){this.tree.refreshParentNode();},scope:this}}});},uploadMultiItems:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.uploadMultiItems){this.windows.uploadMultiItems=MODx.load({xtype:'gal-window-multi-item-upload',album:this.data.id,record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.uploadMultiItems.fp.getForm().reset();this.windows.uploadMultiItems.setValues(r);this.windows.uploadMultiItems.show(e.target);},uploadItem:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.uploadItem){this.windows.uploadItem=MODx.load({xtype:'gal-window-item-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.uploadItem.fp.getForm().reset();this.windows.uploadItem.setValues(r);this.windows.uploadItem.show(e.target);},batchUpload:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.batchUpload){this.windows.batchUpload=MODx.load({xtype:'gal-window-batch-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}else{this.windows.batchUpload.fp.getForm().reset();}
this.windows.batchUpload.setValues(r);this.windows.batchUpload.show(e.target);},zipUpload:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.zipUpload){this.windows.zipUpload=MODx.load({xtype:'gal-window-zip-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}else{this.windows.zipUpload.fp.getForm().reset();}
this.windows.zipUpload.setValues(r);this.windows.zipUpload.show(e.target);},handleDrop:function(t,dropEvent){this.tree=t;var dropNode=dropEvent.dropNode;var target=dropEvent.target;if(!target.attributes.type)return false;if(target.attributes.type=='gallery-album'&&dropNode.attributes.type=='gallery-item'&&dropEvent.point!='append')return false;if(dropNode.attributes.type=='gallery-album'&&target.attributes.type=='gallery-item')return false;return true;}});Ext.reg('gal-tree-handler',galTreeHandlerClass);var galTreeHandler=new galTreeHandlerClass();var galItemDropHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gallery-item-drop-handler'});galItemDropHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galItemDropHandlerClass,Ext.Component,{handle:function(target,opt){var na=target.node.attributes;var cfg={ddTargetEl:opt.ddTargetEl,cfg:opt.cfg,iframe:opt.cfg.iframe,iframeEl:opt.cfg.iframeEl,onInsert:opt.cfg.onInsert,panel:opt.cfg.panel,classKey:'modSnippet',pk:GAL.snippetGalleryItem,name:'GalleryItem'};GAL.elProps={id:na.data.id};MODx.loadInsertElement(cfg);setTimeout("galTreeWorkaround(GAL.elProps);",600);return true;}});var galItemDropHandler=new galItemDropHandlerClass();var galAlbumDropHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gallery-album-drop-handler'});galAlbumDropHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galAlbumDropHandlerClass,Ext.Component,{handle:function(target,opt){var na=target.node.attributes;var cfg={ddTargetEl:opt.ddTargetEl,cfg:opt.cfg,iframe:opt.cfg.iframe,iframeEl:opt.cfg.iframeEl,onInsert:opt.cfg.onInsert,panel:opt.cfg.panel,classKey:'modSnippet',pk:GAL.snippetGallery,name:'Gallery'};GAL.elProps={album:na.data.id};MODx.loadInsertElement(cfg);setTimeout("galTreeWorkaround(GAL.elProps);",600);return true;}});var galAlbumDropHandler=new galAlbumDropHandlerClass();function galTreeWorkaround(props){var w=Ext.getCmp('modx-window-insert-element');w.modps=[];if(w){for(var k in props){var fld=Ext.getCmp('modx-iprop-'+k);if(fld){fld.setValue(props[k]);w.changeProp(k);}}}};setTimeout('galleryFixLeafDrag();',1200);function galleryFixLeafDrag(){var t=Ext.getCmp('modx-file-tree');if(t){t.on('startdrag',function(t,n,e){if(n.attributes.type=='gallery-album'){n.attributes.leaf=true;}},this);}};MODx.grid.SettingsGrid=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="desc">{description_trans}</p>')});if(!config.tbar){config.tbar=[{text:_('setting_create'),scope:this,cls:'primary-button',handler:{xtype:'modx-window-setting-create',url:config.url||MODx.config.connector_url,blankValues:true}}];}
config.tbar.push('->',{xtype:'modx-combo-namespace',name:'namespace',id:'modx-filter-namespace',emptyText:_('namespace_filter'),value:MODx.request['ns']?MODx.request['ns']:'core',allowBlank:true,editable:true,typeAhead:true,forceSelection:true,queryParam:'search',width:150,listeners:{'select':{fn:this.filterByNamespace,scope:this}}},{xtype:'modx-combo-area',name:'area',id:'modx-filter-area',emptyText:_('area_filter'),value:MODx.request['area'],baseParams:{action:'system/settings/getAreas',namespace:MODx.request['ns']?MODx.request['ns']:'core'},width:250,allowBlank:true,editable:true,typeAhead:true,forceSelection:true,listeners:{'select':{fn:this.filterByArea,scope:this}}},{xtype:'textfield',name:'filter_key',id:'modx-filter-key',cls:'x-form-filter',emptyText:_('search_by_key')+'...',listeners:{'change':{fn:this.filterByKey,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:this.blur,scope:cmp});},scope:this}}},{xtype:'button',id:'modx-filter-clear',cls:'x-form-filter-clear',text:_('filter_clear'),listeners:{'click':{fn:this.clearFilter,scope:this}}});this.cm=new Ext.grid.ColumnModel({columns:[this.exp,{header:_('name'),dataIndex:'name_trans',sortable:true,editable:false,width:175},{header:_('key'),dataIndex:'key',sortable:true,editable:false,width:150},{header:_('value'),dataIndex:'value',sortable:true,editable:true,renderer:this.renderDynField.createDelegate(this,[this],true),width:260},{header:_('last_modified'),dataIndex:'editedon',sortable:true,editable:false,renderer:this.renderLastModDate.createDelegate(this,[this],true),width:100},{header:_('area'),dataIndex:'area_text',sortable:true,hidden:true,editable:false}],getCellEditor:function(colIndex,rowIndex){var field=this.getDataIndex(colIndex);if(field=='value'){var rec=config.store.getAt(rowIndex);var xt={xtype:'textfield'};if(rec){xt.xtype=rec.get('xtype');if(xt=='text-password'){xt.xtype='textfield';xt.inputType='password';}}
var o=MODx.load(xt);return new Ext.grid.GridEditor(o);}
return Ext.grid.ColumnModel.prototype.getCellEditor.call(this,colIndex,rowIndex);}});Ext.applyIf(config,{cm:this.cm,fields:['key','name','value','description','xtype','namespace','area','area_text','editedon','oldkey','menu','name_trans','description_trans'],url:MODx.config.connector_url,baseParams:{action:'system/settings/getList',namespace:MODx.request['ns']?MODx.request['ns']:'core',area:MODx.request['area']},clicksToEdit:2,grouping:true,groupBy:'area_text',singleText:_('setting'),pluralText:_('settings'),sortBy:'key',plugins:this.exp,primaryKey:'key',autosave:true,save_action:'system/settings/updatefromgrid',pageSize:MODx.config.default_per_page>30?MODx.config.default_per_page:30,paging:true,collapseFirst:false,tools:[{id:'plus',qtip:_('expand_all'),handler:this.expandAll,scope:this},{id:'minus',hidden:true,qtip:_('collapse_all'),handler:this.collapseAll,scope:this}]});this.view=new Ext.grid.GroupingView({emptyText:config.emptyText||_('ext_emptymsg'),forceFit:true,autoFill:true,showPreview:true,enableRowBody:true,scrollOffset:0});MODx.grid.SettingsGrid.superclass.constructor.call(this,config);};Ext.extend(MODx.grid.SettingsGrid,MODx.grid.Grid,{_addEnterKeyHandler:function(){this.getEl().addKeyListener(Ext.EventObject.ENTER,function(){this.fireEvent('change');},this);},_showMenu:function(g,ri,e){e.stopEvent();e.preventDefault();this.menu.record=this.getStore().getAt(ri).data;if(!this.getSelectionModel().isSelected(ri)){this.getSelectionModel().selectRow(ri);}
this.menu.removeAll();var m=[];if(this.menu.record.menu){m=this.menu.record.menu;}else{m.push({text:_('setting_update'),handler:this.updateSetting},'-',{text:_('setting_remove'),handler:this.removeSetting});}
if(m.length>0){this.addContextMenuItem(m);this.menu.showAt(e.xy);}},removeSetting:function(){return this.remove('setting_remove_confirm','system/settings/remove');},updateSetting:function(btn,e){var r=this.menu.record;r.fk=Ext.isDefined(this.config.fk)?this.config.fk:0;var uss=MODx.load({xtype:'modx-window-setting-update',record:r,grid:this,listeners:{'success':{fn:function(r){this.refresh();},scope:this}}});uss.reset();uss.setValues(r);uss.show(e.target);},clearFilter:function(){var ns=MODx.request['ns']?MODx.request['ns']:'core';var area=MODx.request['area']?MODx.request['area']:'';this.getStore().baseParams=this.initialConfig.baseParams;var acb=Ext.getCmp('modx-filter-area');if(acb){acb.store.baseParams['namespace']=ns;acb.store.load();acb.reset();}
Ext.getCmp('modx-filter-namespace').reset();Ext.getCmp('modx-filter-key').reset();this.getStore().baseParams.namespace=ns;this.getStore().baseParams.area=area;this.getStore().baseParams.key='';this.getBottomToolbar().changePage(1);this.refresh();},filterByKey:function(tf,newValue,oldValue){this.getStore().baseParams.key=newValue;this.getStore().baseParams.namespace='';this.getBottomToolbar().changePage(1);this.refresh();return true;},filterByNamespace:function(cb,rec,ri){this.getStore().baseParams['namespace']=rec.data['name'];this.getStore().baseParams['area']='';this.getBottomToolbar().changePage(1);this.refresh();var acb=Ext.getCmp('modx-filter-area');if(acb){var s=acb.store;s.baseParams['namespace']=rec.data.name;s.removeAll();s.load();acb.setValue('');}},filterByArea:function(cb,rec,ri){this.getStore().baseParams['area']=rec.data['v'];this.getBottomToolbar().changePage(1);this.refresh();},renderDynField:function(v,md,rec,ri,ci,s,g){var r=s.getAt(ri).data;v=Ext.util.Format.htmlEncode(v);var f;if(r.xtype=='combo-boolean'||r.xtype=='modx-combo-boolean'){f=MODx.grid.Grid.prototype.rendYesNo;return f(v,md,rec,ri,ci,s,g);}else if(r.xtype==='datefield'){f=Ext.util.Format.dateRenderer(MODx.config.manager_date_format);return f(v,md,rec,ri,ci,s,g);}else if(r.xtype==='text-password'||r.xtype=='modx-text-password'){f=MODx.grid.Grid.prototype.rendPassword;return f(v,md,rec,ri,ci,s,g);}else if(r.xtype.substr(0,5)=='combo'||r.xtype.substr(0,10)=='modx-combo'){var cm=g.getColumnModel();var ed=cm.getCellEditor(ci,ri);if(!ed){var o=Ext.ComponentMgr.create({xtype:r.xtype||'textfield'});ed=new Ext.grid.GridEditor(o);cm.setEditor(ci,ed);}
if(ed.store&&!ed.store.isLoaded&&ed.config.mode!='local'){ed.store.load();ed.store.isLoaded=true;}
f=Ext.util.Format.comboRenderer(ed.field,v);return f(v,md,rec,ri,ci,s,g);}
return v;},renderLastModDate:function(value){if(Ext.isEmpty(value)){return'—';}
return value;}});Ext.reg('modx-grid-settings',MODx.grid.SettingsGrid);MODx.combo.Area=function(config){config=config||{};Ext.applyIf(config,{name:'area',hiddenName:'area',displayField:'d',valueField:'v',fields:['d','v'],url:MODx.config.connector_url,baseParams:{action:'system/settings/getAreas'}});MODx.combo.Area.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.Area,MODx.combo.ComboBox);Ext.reg('modx-combo-area',MODx.combo.Area);MODx.window.CreateSetting=function(config){config=config||{};Ext.applyIf(config,{title:_('setting_create'),width:600,url:config.url,action:'system/settings/create',fields:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false},items:[{columnWidth:.5,items:[{xtype:'hidden',name:'fk',id:'modx-cs-fk',value:config.fk||0},{xtype:'textfield',fieldLabel:_('key'),name:'key',id:'modx-cs-key',maxLength:100,anchor:'100%'},{xtype:'label',forId:'modx-cs-key',html:_('key_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('name'),name:'name',id:'modx-cs-name',anchor:'100%'},{xtype:'label',forId:'modx-cs-name',html:_('name_desc'),cls:'desc-under'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:'modx-cs-description',allowBlank:true,anchor:'100%'},{xtype:'label',forId:'modx-cs-description',html:_('description_desc'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'modx-combo-xtype-spec',fieldLabel:_('xtype'),description:MODx.expandHelp?'':_('xtype_desc'),id:'modx-cs-xtype',anchor:'100%'},{xtype:'label',forId:'modx-cs-xtype',html:_('xtype_desc'),cls:'desc-under'},{xtype:'modx-combo-namespace',fieldLabel:_('namespace'),name:'namespace',id:'modx-cs-namespace',value:'core',anchor:'100%'},{xtype:'label',forId:'modx-cs-namespace',html:_('namespace_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('area_lexicon_string'),description:_('area_lexicon_string_msg'),name:'area',id:'modx-cs-area',anchor:'100%'},{xtype:'label',forId:'modx-cs-area',html:_('area_lexicon_string_msg'),cls:'desc-under'}]}]},{xtype:'textarea',fieldLabel:_('value'),name:'value',id:'modx-cs-value',anchor:'100%'}],keys:[]});MODx.window.CreateSetting.superclass.constructor.call(this,config);this.on('show',function(){this.reset();this.setValues({namespace:Ext.getCmp('modx-filter-namespace').value,area:Ext.getCmp('modx-filter-area').value});},this);};Ext.extend(MODx.window.CreateSetting,MODx.Window);Ext.reg('modx-window-setting-create',MODx.window.CreateSetting);MODx.combo.xType=function(config){config=config||{};Ext.applyIf(config,{store:new Ext.data.SimpleStore({fields:['d','v'],data:[[_('textfield'),'textfield'],[_('textarea'),'textarea'],[_('yesno'),'combo-boolean'],[_('password'),'text-password'],[_('category'),'modx-combo-category'],[_('charset'),'modx-combo-charset'],[_('country'),'modx-combo-country'],[_('context'),'modx-combo-context'],[_('namespace'),'modx-combo-namespace'],[_('template'),'modx-combo-template'],[_('user'),'modx-combo-user'],[_('usergroup'),'modx-combo-usergroup'],[_('language'),'modx-combo-language'],[_('source'),'modx-combo-source'],[_('setting_manager_theme'),'modx-combo-manager-theme']]}),displayField:'d',valueField:'v',mode:'local',name:'xtype',hiddenName:'xtype',triggerAction:'all',editable:false,selectOnFocus:false,value:'textfield'});MODx.combo.xType.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.xType,Ext.form.ComboBox);Ext.reg('modx-combo-xtype-spec',MODx.combo.xType);MODx.window.UpdateSetting=function(config){config=config||{};this.ident=config.ident||'modx-uss-'+Ext.id();Ext.applyIf(config,{title:_('setting_update'),width:600,url:config.grid.config.url,action:'system/settings/update',fields:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false},items:[{columnWidth:.5,items:[{xtype:'hidden',name:'fk',id:'modx-'+this.ident+'-fk',value:config.fk||0},{xtype:'statictextfield',fieldLabel:_('key'),description:MODx.expandHelp?'':_('key_desc'),name:'key',id:'modx-'+this.ident+'-key',maxLength:100,submitValue:true,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-key',html:_('key_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('name'),description:MODx.expandHelp?'':_('name_desc'),name:'name',id:'modx-'+this.ident+'-name',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-name',html:_('name_desc'),cls:'desc-under'},{xtype:'textarea',fieldLabel:_('description'),description:MODx.expandHelp?'':_('description_desc'),name:'description',id:'modx-'+this.ident+'-description',allowBlank:true,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-description',html:_('description_desc'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'modx-combo-xtype-spec',fieldLabel:_('xtype'),description:MODx.expandHelp?'':_('xtype_desc'),id:'modx-'+this.ident+'-xtype',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-xtype',html:_('xtype_desc'),cls:'desc-under'},{xtype:'modx-combo-namespace',fieldLabel:_('namespace'),description:MODx.expandHelp?'':_('namespace_desc'),name:'namespace',id:'modx-'+this.ident+'-namespace',value:'core',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-namespace',html:_('namespace_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('area_lexicon_string'),description:MODx.expandHelp?'':_('area_lexicon_string_msg'),name:'area',id:'modx-'+this.ident+'-area',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-area',html:_('area_lexicon_string_msg'),cls:'desc-under'}]}]},{xtype:config.record?config.record.xtype:'textarea',fieldLabel:_('value'),name:'value',hiddenName:'value',id:'modx-'+this.ident+'-value',anchor:'100%'}],keys:[]});MODx.window.UpdateSetting.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateSetting,MODx.Window);Ext.reg('modx-window-setting-update',MODx.window.UpdateSetting);;MODx.grid.GroupSettings=function(config){config=config||{};Ext.applyIf(config,{title:_('user_group_settings'),id:'modx-grid-group-settings',url:MODx.config.connector_url,baseParams:{action:'security/group/setting/getList',group:config.group},saveParams:{group:config.group},save_action:'security/group/setting/updatefromgrid',fk:config.group,tbar:[{text:_('create_new'),cls:'primary-button',scope:this,handler:{xtype:'modx-window-setting-create',url:MODx.config.connector_url,baseParams:{action:'security/group/setting/create'},fk:config.group}}]});MODx.grid.GroupSettings.superclass.constructor.call(this,config);};Ext.extend(MODx.grid.GroupSettings,MODx.grid.SettingsGrid,{_showMenu:function(g,ri,e){e.stopEvent();e.preventDefault();this.menu.record=this.getStore().getAt(ri).data;if(!this.getSelectionModel().isSelected(ri)){this.getSelectionModel().selectRow(ri);}
this.menu.removeAll();var m=[];if(this.menu.record.menu){m=this.menu.record.menu;}else{m.push({text:_('setting_update'),handler:this.updateSetting},'-',{text:_('setting_remove'),handler:this.remove.createDelegate(this,['setting_remove_confirm','security/group/setting/remove'])});}
if(m.length>0){this.addContextMenuItem(m);this.menu.showAt(e.xy);}},updateSetting:function(btn,e){var r=this.menu.record;r.fk=Ext.isDefined(this.config.fk)?this.config.fk:0;var uss=MODx.load({xtype:'modx-window-setting-update',action:'security/group/setting/update',record:r,grid:this,listeners:{'success':{fn:function(r){this.refresh();},scope:this}}});uss.reset();uss.setValues(r);uss.show(e.target);}});Ext.reg('modx-grid-group-settings',MODx.grid.GroupSettings);;MODx.grid.UserGroupContext=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="desc">{permissions}</p>')});Ext.applyIf(config,{id:'modx-grid-user-group-contexts',url:MODx.config.connector_url,baseParams:{action:'security/access/usergroup/context/getList',usergroup:config.usergroup},fields:['id','target','principal','authority','authority_name','policy','policy_name','permissions','cls'],paging:true,hideMode:'offsets',grouping:true,groupBy:'authority_name',singleText:_('policy'),pluralText:_('policies'),sortBy:'authority',sortDir:'ASC',remoteSort:true,plugins:[this.exp],columns:[this.exp,{header:_('context'),dataIndex:'target',width:120,sortable:true},{header:_('minimum_role'),dataIndex:'authority_name',width:100,sortable:false},{header:_('policy'),dataIndex:'policy_name',width:200,sortable:true}],tbar:[{text:_('context_add'),cls:'primary-button',scope:this,handler:this.createAcl},'->',{xtype:'modx-combo-context',id:'modx-ugc-context-filter',emptyText:_('filter_by_context'),allowBlank:true,listeners:{'select':{fn:this.filterContext,scope:this}}},{xtype:'modx-combo-policy',id:'modx-ugc-policy-filter',emptyText:_('filter_by_policy'),allowBlank:true,baseParams:{action:'security/access/policy/getList',group:'Admin'},listeners:{'select':{fn:this.filterPolicy,scope:this}}},{text:_('clear_filter'),id:'modx-ugc-clear-filter',handler:this.clearFilter,scope:this}]});MODx.grid.UserGroupContext.superclass.constructor.call(this,config);this.addEvents('createAcl','updateAcl');};Ext.extend(MODx.grid.UserGroupContext,MODx.grid.Grid,{combos:{},windows:{},getMenu:function(){var r=this.getSelectionModel().getSelected();var p=r.data.cls;var m=[];if(this.getSelectionModel().getCount()>1){}else{if(p.indexOf('pedit')!=-1){m.push({text:_('access_context_update'),handler:this.updateAcl});}
if(p.indexOf('premove')!=-1){if(m.length>0){m.push('-');}
m.push({text:_('access_context_remove'),handler:this.remove.createDelegate(this,["confirm_remove","security/access/usergroup/context/remove"])});}}
if(m.length>0){this.addContextMenuItem(m);}},filterContext:function(cb,rec,ri){this.getStore().baseParams['context']=rec.data['key'];this.getBottomToolbar().changePage(1);this.refresh();},filterPolicy:function(cb,rec,ri){this.getStore().baseParams['policy']=rec.data['id'];this.getBottomToolbar().changePage(1);this.refresh();},clearFilter:function(btn,e){Ext.getCmp('modx-ugc-context-filter').setValue('');this.getStore().baseParams['context']='';Ext.getCmp('modx-ugc-policy-filter').setValue('');this.getStore().baseParams['policy']='';this.getBottomToolbar().changePage(1);this.refresh();},createAcl:function(itm,e){var r={principal:this.config.usergroup};if(!this.windows.createAcl){this.windows.createAcl=MODx.load({xtype:'modx-window-user-group-context-create',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('createAcl',r);},scope:this}}});}
this.windows.createAcl.setValues(r);this.windows.createAcl.show(e.target);},updateAcl:function(itm,e){var r=this.menu.record;if(!this.windows.updateAcl){this.windows.updateAcl=MODx.load({xtype:'modx-window-user-group-context-update',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('updateAcl',r);},scope:this}}});}
this.windows.updateAcl.setValues(r);this.windows.updateAcl.show(e.target);}});Ext.reg('modx-grid-user-group-context',MODx.grid.UserGroupContext);MODx.window.CreateUGAccessContext=function(config){config=config||{};this.ident=config.ident||'cugactx'+Ext.id();Ext.applyIf(config,{title:_('ugc_mutate'),url:MODx.config.connector_url,action:'security/access/usergroup/context/create',fields:[{xtype:'hidden',name:'id'},{xtype:'modx-combo-context',fieldLabel:_('context'),description:MODx.expandHelp?'':_('user_group_context_context_desc'),id:'modx-'+this.ident+'-context',name:'target',hiddenName:'target',editable:false,allowBlank:false,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-context',html:_('user_group_context_context_desc'),cls:'desc-under'},{xtype:'modx-combo-authority',fieldLabel:_('minimum_role'),description:MODx.expandHelp?'':_('user_group_context_authority_desc'),id:'modx-'+this.ident+'-authority',name:'authority',value:0,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-authority',html:_('user_group_context_authority_desc'),cls:'desc-under'},{xtype:'modx-combo-policy',fieldLabel:_('policy'),description:MODx.expandHelp?'':_('user_group_context_policy_desc'),id:'modx-'+this.ident+'-policy',name:'policy',hiddenName:'policy',baseParams:{action:'security/access/policy/getList',group:'Admin,Object',combo:'1'},allowBlank:false,anchor:'100%',listeners:{'select':{fn:this.onPolicySelect,scope:this}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-policy',html:_('user_group_context_policy_desc'),cls:'desc-under'},{xtype:'hidden',name:'principal',hiddenName:'principal'},{id:'modx-'+this.ident+'-permissions-list-ct',cls:'modx-permissions-list',defaults:{border:false},autoHeight:true,hidden:true,anchor:'100%',items:[{html:'<h4>'+_('permissions_in_policy')+'</h4>',id:'modx-'+this.ident+'-permissions-list-header'},{id:'modx-'+this.ident+'-permissions-list',cls:'modx-permissions-list-textarea',xtype:'textarea',grow:false,anchor:'100%',height:150,width:'97%',readOnly:true}]}]});MODx.window.CreateUGAccessContext.superclass.constructor.call(this,config);};Ext.extend(MODx.window.CreateUGAccessContext,MODx.Window,{onPolicySelect:function(cb,rec,idx){var s=cb.getStore();if(!s)return;var r=s.getAt(idx);if(r){Ext.getCmp('modx-'+this.ident+'-permissions-list-ct').show();var pl=Ext.getCmp('modx-'+this.ident+'-permissions-list');var o=rec.data.permissions.join(', ');pl.setValue(o);}}});Ext.reg('modx-window-user-group-context-create',MODx.window.CreateUGAccessContext);MODx.window.UpdateUGAccessContext=function(config){config=config||{};this.ident=config.ident||'uugactx'+Ext.id();Ext.applyIf(config,{title:_('ugc_mutate'),action:'security/access/usergroup/context/update'});MODx.window.UpdateUGAccessContext.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateUGAccessContext,MODx.window.CreateUGAccessContext);Ext.reg('modx-window-user-group-context-update',MODx.window.UpdateUGAccessContext);;MODx.grid.UserGroupResourceGroup=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="desc">{permissions}</p>')});Ext.applyIf(config,{id:'modx-grid-user-group-resource-groups',url:MODx.config.connector_url,baseParams:{action:'security/access/usergroup/resourcegroup/getList',usergroup:config.usergroup},paging:true,hideMode:'offsets',fields:['id','target','name','principal','authority','authority_name','policy','policy_name','context_key','permissions','menu'],grouping:true,groupBy:'authority_name',singleText:_('policy'),pluralText:_('policies'),sortBy:'authority',sortDir:'ASC',remoteSort:true,plugins:[this.exp],columns:[this.exp,{header:_('resource_group'),dataIndex:'name',width:120,sortable:true},{header:_('minimum_role'),dataIndex:'authority_name',width:100},{header:_('policy'),dataIndex:'policy_name',width:200},{header:_('context'),dataIndex:'context_key',width:150,sortable:true}],tbar:[{text:_('resource_group_add'),cls:'primary-button',scope:this,handler:this.createAcl},'->',{xtype:'modx-combo-resourcegroup',id:'modx-ugrg-resourcegroup-filter',emptyText:_('filter_by_resource_group'),width:200,allowBlank:true,listeners:{'select':{fn:this.filterResourceGroup,scope:this}}},{xtype:'modx-combo-policy',id:'modx-ugrg-policy-filter',emptyText:_('filter_by_policy'),baseParams:{action:'security/access/policy/getList',group:'Object'},allowBlank:true,listeners:{'select':{fn:this.filterPolicy,scope:this}}},{text:_('clear_filter'),id:'modx-ugrg-clear-filter',handler:this.clearFilter,scope:this}]});MODx.grid.UserGroupResourceGroup.superclass.constructor.call(this,config);this.addEvents('createAcl','updateAcl');};Ext.extend(MODx.grid.UserGroupResourceGroup,MODx.grid.Grid,{combos:{},windows:{},filterResourceGroup:function(cb,rec,ri){this.getStore().baseParams['resourceGroup']=rec.data['id'];this.getBottomToolbar().changePage(1);this.refresh();},filterPolicy:function(cb,rec,ri){this.getStore().baseParams['policy']=rec.data['id'];this.getBottomToolbar().changePage(1);this.refresh();},clearFilter:function(btn,e){Ext.getCmp('modx-ugrg-resourcegroup-filter').setValue('');this.getStore().baseParams['resourceGroup']='';Ext.getCmp('modx-ugrg-policy-filter').setValue('');this.getStore().baseParams['policy']='';this.getBottomToolbar().changePage(1);this.refresh();},createAcl:function(itm,e){var r={principal:this.config.usergroup};if(!this.windows.createAcl){this.windows.createAcl=MODx.load({xtype:'modx-window-user-group-resourcegroup-create',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('createAcl',r);},scope:this}}});}
this.windows.createAcl.setValues(r);this.windows.createAcl.show(e.target);},updateAcl:function(itm,e){var r=this.menu.record;if(!this.windows.updateAcl){this.windows.updateAcl=MODx.load({xtype:'modx-window-user-group-resourcegroup-update',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('updateAcl',r);},scope:this}}});}
this.windows.updateAcl.setValues(r);this.windows.updateAcl.show(e.target);}});Ext.reg('modx-grid-user-group-resource-group',MODx.grid.UserGroupResourceGroup);MODx.window.CreateUGRG=function(config){config=config||{};this.ident=config.ident||'crgactx'+Ext.id();Ext.applyIf(config,{title:_('resource_group_add'),url:MODx.config.connector_url,action:'security/access/usergroup/resourcegroup/create',fields:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'principal',hiddenName:'principal'},{xtype:'hidden',name:'principal_class',value:'modUserGroup'},{xtype:'modx-combo-resourcegroup',fieldLabel:_('resource_group'),description:MODx.expandHelp?'':_('user_group_resourcegroup_resource_group_desc'),id:'modx-'+this.ident+'-resource-group',name:'target',hiddenName:'target',editable:false,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-resource-group',html:_('user_group_resourcegroup_resource_group_desc'),cls:'desc-under'},{xtype:'modx-combo-context',fieldLabel:_('context'),description:MODx.expandHelp?'':_('user_group_resourcegroup_context_desc'),id:'modx-'+this.ident+'-context',name:'context_key',hiddenName:'context_key',editable:false,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-context',html:_('user_group_resourcegroup_context_desc'),cls:'desc-under'},{xtype:'modx-combo-authority',fieldLabel:_('minimum_role'),description:MODx.expandHelp?'':_('user_group_resourcegroup_authority_desc'),id:'modx-'+this.ident+'-authority',name:'authority',value:0,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-authority',html:_('user_group_resourcegroup_authority_desc'),cls:'desc-under'},{xtype:'modx-combo-policy',fieldLabel:_('policy'),description:MODx.expandHelp?'':_('user_group_resourcegroup_policy_desc'),id:'modx-'+this.ident+'-policy',name:'policy',hiddenName:'policy',baseParams:{action:'security/access/policy/getList',group:'Resource,Object',combo:'1'},anchor:'100%',listeners:{'select':{fn:this.onPolicySelect,scope:this}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-policy',html:_('user_group_resourcegroup_policy_desc'),cls:'desc-under'},{id:'modx-'+this.ident+'-permissions-list-ct',cls:'modx-permissions-list',defaults:{border:false},autoHeight:true,hidden:true,anchor:'100%',items:[{html:'<h4>'+_('permissions_in_policy')+'</h4>',id:'modx-'+this.ident+'-permissions-list-header'},{id:'modx-'+this.ident+'-permissions-list',cls:'modx-permissions-list-textarea',xtype:'textarea',grow:false,anchor:'100%',height:100,width:'97%',readOnly:true}]}]});MODx.window.CreateUGRG.superclass.constructor.call(this,config);};Ext.extend(MODx.window.CreateUGRG,MODx.Window,{onPolicySelect:function(cb,rec,idx){var s=cb.getStore();if(!s)return;var r=s.getAt(idx);if(r){Ext.getCmp('modx-'+this.ident+'-permissions-list-ct').show();var pl=Ext.getCmp('modx-'+this.ident+'-permissions-list');var o=rec.data.permissions.join(', ');pl.setValue(o);}}});Ext.reg('modx-window-user-group-resourcegroup-create',MODx.window.CreateUGRG);MODx.window.UpdateUGRG=function(config){config=config||{};this.ident=config.ident||'ugrgactx'+Ext.id();Ext.applyIf(config,{title:_('access_rgroup_update'),action:'security/access/usergroup/resourcegroup/update'});MODx.window.UpdateUGRG.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateUGRG,MODx.window.CreateUGRG);Ext.reg('modx-window-user-group-resourcegroup-update',MODx.window.UpdateUGRG);;MODx.grid.UserGroupCategory=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="desc">{permissions}</p>')});Ext.applyIf(config,{id:'modx-grid-user-group-categories',url:MODx.config.connector_url,baseParams:{action:'security/access/usergroup/category/getList',usergroup:config.usergroup},paging:true,hideMode:'offsets',fields:['id','target','name','principal','authority','authority_name','policy','policy_name','context_key','permissions','menu'],grouping:true,groupBy:'authority_name',singleText:_('policy'),pluralText:_('policies'),sortBy:'authority',sortDir:'ASC',remoteSort:true,plugins:[this.exp],columns:[this.exp,{header:_('category'),dataIndex:'name',width:120,sortable:true},{header:_('minimum_role'),dataIndex:'authority_name',width:100},{header:_('policy'),dataIndex:'policy_name',width:200},{header:_('context'),dataIndex:'context_key',width:150,sortable:true}],tbar:[{text:_('category_add'),cls:'primary-button',scope:this,handler:this.createAcl},'->',{xtype:'modx-combo-category',id:'modx-ugcat-category-filter',emptyText:_('filter_by_category'),width:200,allowBlank:true,listeners:{'select':{fn:this.filterCategory,scope:this}}},{xtype:'modx-combo-policy',id:'modx-ugcat-policy-filter',emptyText:_('filter_by_policy'),allowBlank:true,baseParams:{action:'security/access/policy/getList',group:'Object'},listeners:{'select':{fn:this.filterPolicy,scope:this}}},{text:_('clear_filter'),id:'modx-ugcat-clear-filter',handler:this.clearFilter,scope:this}]});MODx.grid.UserGroupCategory.superclass.constructor.call(this,config);this.addEvents('createAcl','updateAcl');};Ext.extend(MODx.grid.UserGroupCategory,MODx.grid.Grid,{combos:{},windows:{},filterCategory:function(cb,rec,ri){this.getStore().baseParams['category']=rec.data['id'];this.getBottomToolbar().changePage(1);this.refresh();},filterPolicy:function(cb,rec,ri){this.getStore().baseParams['policy']=rec.data['id'];this.getBottomToolbar().changePage(1);this.refresh();},clearFilter:function(btn,e){Ext.getCmp('modx-ugcat-category-filter').setValue('');this.getStore().baseParams['category']='';Ext.getCmp('modx-ugcat-policy-filter').setValue('');this.getStore().baseParams['policy']='';this.getBottomToolbar().changePage(1);this.refresh();},createAcl:function(itm,e){var r={principal:this.config.usergroup};if(!this.windows.createAcl){this.windows.createAcl=MODx.load({xtype:'modx-window-user-group-category-create',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('createAcl',r);},scope:this}}});}
this.windows.createAcl.setValues(r);this.windows.createAcl.show(e.target);},updateAcl:function(itm,e){var r=this.menu.record;if(!this.windows.updateAcl){this.windows.updateAcl=MODx.load({xtype:'modx-window-user-group-category-update',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('updateAcl',r);},scope:this}}});}
this.windows.updateAcl.setValues(r);this.windows.updateAcl.show(e.target);}});Ext.reg('modx-grid-user-group-category',MODx.grid.UserGroupCategory);MODx.window.CreateUGCat=function(config){config=config||{};this.ident=config.ident||'cugcat'+Ext.id();Ext.applyIf(config,{title:_('category_add'),url:MODx.config.connector_url,action:'security/access/usergroup/category/create',fields:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'principal',hiddenName:'principal'},{xtype:'hidden',name:'principal_class',value:'modUserGroup'},{xtype:'modx-combo-category',fieldLabel:_('category'),description:MODx.expandHelp?'':_('user_group_category_category_desc'),id:'modx-'+this.ident+'-category',name:'target',hiddenName:'target',editable:false,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-category',html:_('user_group_category_category_desc'),cls:'desc-under'},{xtype:'modx-combo-context',fieldLabel:_('context'),description:MODx.expandHelp?'':_('user_group_category_context_desc'),id:'modx-'+this.ident+'-context',name:'context_key',hiddenName:'context_key',editable:false,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-context',html:_('user_group_category_context_desc'),cls:'desc-under'},{xtype:'modx-combo-authority',fieldLabel:_('minimum_role'),description:MODx.expandHelp?'':_('user_group_category_policy_desc'),id:'modx-'+this.ident+'-authority',name:'authority',value:0,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-authority',html:_('user_group_category_authority_desc'),cls:'desc-under'},{xtype:'modx-combo-policy',fieldLabel:_('policy'),description:MODx.expandHelp?'':_('user_group_category_policy_desc'),id:'modx-'+this.ident+'-policy',name:'policy',hiddenName:'policy',baseParams:{action:'security/access/policy/getList',group:'Element,Object',combo:'1'},anchor:'100%',listeners:{'select':{fn:this.onPolicySelect,scope:this}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-policy',html:_('user_group_category_policy_desc'),cls:'desc-under'},{id:'modx-'+this.ident+'-permissions-list-ct',cls:'modx-permissions-list',defaults:{border:false},autoHeight:true,hidden:true,anchor:'100%',items:[{html:'<h4>'+_('permissions_in_policy')+'</h4>',id:'modx-'+this.ident+'-permissions-list-header'},{id:'modx-'+this.ident+'-permissions-list',cls:'modx-permissions-list-textarea',xtype:'textarea',name:'permissions',grow:false,anchor:'100%',height:100,width:'97%',readOnly:true}]}]});MODx.window.CreateUGCat.superclass.constructor.call(this,config);};Ext.extend(MODx.window.CreateUGCat,MODx.Window,{onPolicySelect:function(cb,rec,idx){var s=cb.getStore();if(!s)return;var r=s.getAt(idx);if(r){Ext.getCmp('modx-'+this.ident+'-permissions-list-ct').show();var pl=Ext.getCmp('modx-'+this.ident+'-permissions-list');var o=rec.data.permissions.join(', ');pl.setValue(o);}}});Ext.reg('modx-window-user-group-category-create',MODx.window.CreateUGCat);MODx.window.UpdateUGCat=function(config){config=config||{};this.ident=config.ident||'updugcat'+Ext.id();Ext.applyIf(config,{title:_('access_category_update'),action:'security/access/usergroup/category/update'});MODx.window.UpdateUGCat.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateUGCat,MODx.window.CreateUGCat);Ext.reg('modx-window-user-group-category-update',MODx.window.UpdateUGCat);;MODx.grid.UserGroupSource=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="desc">{permissions}</p>')});Ext.applyIf(config,{id:'modx-grid-user-group-sources',url:MODx.config.connector_url,baseParams:{action:'security/access/usergroup/source/getList',usergroup:config.usergroup},paging:true,hideMode:'offsets',fields:['id','target','name','principal','authority','authority_name','policy','policy_name','context_key','permissions','menu'],grouping:true,groupBy:'authority_name',singleText:_('policy'),pluralText:_('policies'),sortBy:'authority',sortDir:'ASC',remoteSort:true,plugins:[this.exp],columns:[this.exp,{header:_('source'),dataIndex:'name',width:120,sortable:true},{header:_('minimum_role'),dataIndex:'authority_name',width:100},{header:_('policy'),dataIndex:'policy_name',width:200}],tbar:[{text:_('source_add'),cls:'primary-button',scope:this,handler:this.createAcl},'->',{xtype:'modx-combo-source',id:'modx-ugsource-source-filter',emptyText:_('filter_by_source'),width:200,allowBlank:true,listeners:{'select':{fn:this.filterSource,scope:this}}},{xtype:'modx-combo-policy',id:'modx-ugsource-policy-filter',emptyText:_('filter_by_policy'),allowBlank:true,baseParams:{action:'security/access/policy/getList',group:'MediaSource'},listeners:{'select':{fn:this.filterPolicy,scope:this}}},{text:_('clear_filter'),id:'modx-ugsource-clear-filter',handler:this.clearFilter,scope:this}]});MODx.grid.UserGroupSource.superclass.constructor.call(this,config);this.addEvents('createAcl','updateAcl');};Ext.extend(MODx.grid.UserGroupSource,MODx.grid.Grid,{combos:{},windows:{},filterSource:function(cb,rec,ri){this.getStore().baseParams['source']=rec.data['id'];this.getBottomToolbar().changePage(1);this.refresh();},filterPolicy:function(cb,rec,ri){this.getStore().baseParams['policy']=rec.data['id'];this.getBottomToolbar().changePage(1);this.refresh();},clearFilter:function(btn,e){Ext.getCmp('modx-ugsource-source-filter').setValue('');this.getStore().baseParams['source']='';Ext.getCmp('modx-ugsource-policy-filter').setValue('');this.getStore().baseParams['policy']='';this.getBottomToolbar().changePage(1);this.refresh();},createAcl:function(itm,e){var r={principal:this.config.usergroup};if(!this.windows.createAcl){this.windows.createAcl=MODx.load({xtype:'modx-window-user-group-source-create',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('createAcl',r);},scope:this}}});}
this.windows.createAcl.setValues(r);this.windows.createAcl.show(e.target);},updateAcl:function(itm,e){var r=this.menu.record;if(!this.windows.updateAcl){this.windows.updateAcl=MODx.load({xtype:'modx-window-user-group-source-update',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('updateAcl',r);},scope:this}}});}
this.windows.updateAcl.setValues(r);this.windows.updateAcl.show(e.target);}});Ext.reg('modx-grid-user-group-source',MODx.grid.UserGroupSource);MODx.window.CreateUGSource=function(config){config=config||{};this.ident=config.ident||'cugsrc'+Ext.id();Ext.applyIf(config,{title:_('source_add'),url:MODx.config.connector_url,action:'security/access/usergroup/source/create',fields:[{xtype:'hidden',name:'id'},{xtype:'hidden',name:'principal',hiddenName:'principal'},{xtype:'hidden',name:'principal_class',value:'modUserGroup'},{xtype:'hidden',name:'context_key',hiddenName:'context_key',value:'mgr'},{xtype:'modx-combo-source',fieldLabel:_('source'),description:MODx.expandHelp?'':_('user_group_source_source_desc'),id:'modx-'+this.ident+'-source',name:'target',hiddenName:'target',editable:false,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-source',html:_('user_group_source_source_desc'),cls:'desc-under'},{xtype:'modx-combo-authority',fieldLabel:_('minimum_role'),description:MODx.expandHelp?'':_('user_group_source_authority_desc'),id:'modx-'+this.ident+'-authority',name:'authority',value:0,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-authority',html:_('user_group_source_authority_desc'),cls:'desc-under'},{xtype:'modx-combo-policy',fieldLabel:_('policy'),description:MODx.expandHelp?'':_('user_group_source_policy_desc'),id:'modx-'+this.ident+'-policy',name:'policy',hiddenName:'policy',baseParams:{action:'security/access/policy/getList',group:'MediaSource'},anchor:'100%',listeners:{'select':{fn:this.onPolicySelect,scope:this}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-policy',html:_('user_group_source_policy_desc'),cls:'desc-under'},{id:'modx-'+this.ident+'-permissions-list-ct',cls:'modx-permissions-list',defaults:{border:false},autoHeight:true,hidden:true,anchor:'100%',items:[{html:'<h4>'+_('permissions_in_policy')+'</h4>',id:'modx-'+this.ident+'-permissions-list-header'},{id:'modx-'+this.ident+'-permissions-list',cls:'modx-permissions-list-textarea',xtype:'textarea',name:'permissions',grow:false,anchor:'100%',height:100,width:'97%',readOnly:true}]}]});MODx.window.CreateUGSource.superclass.constructor.call(this,config);};Ext.extend(MODx.window.CreateUGSource,MODx.Window,{onPolicySelect:function(cb,rec,idx){var s=cb.getStore();if(!s)return;var r=s.getAt(idx);if(r){Ext.getCmp('modx-'+this.ident+'-permissions-list-ct').show();var pl=Ext.getCmp('modx-'+this.ident+'-permissions-list');var o=rec.data.permissions.join(', ');pl.setValue(o);}}});Ext.reg('modx-window-user-group-source-create',MODx.window.CreateUGSource);MODx.window.UpdateUGSource=function(config){config=config||{};this.ident=config.ident||'updugsrc'+Ext.id();Ext.applyIf(config,{title:_('access_source_update'),action:'security/access/usergroup/source/update'});MODx.window.UpdateUGSource.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateUGSource,MODx.window.CreateUGSource);Ext.reg('modx-window-user-group-source-update',MODx.window.UpdateUGSource);;MODx.panel.UserGroup=function(config){config=config||{};Ext.applyIf(config,{id:'modx-panel-user-group',cls:'container form-with-labels',url:MODx.config.connector_url,baseParams:{action:'security/group/update'},defaults:{collapsible:false,autoHeight:true},items:[{html:'<h2>'+_('user_group_new')+'</h2>',border:false,cls:'modx-page-header',id:'modx-user-group-header'},{xtype:'modx-tabs',defaults:{autoHeight:true,border:true,bodyCssClass:'tab-panel-wrapper'},id:'modx-usergroup-tabs',forceLayout:true,deferredRender:false,stateful:true,stateId:'modx-usergroup-tabpanel',stateEvents:['tabchange'],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())};},items:[{title:_('general_information'),defaults:{border:false,msgTarget:'side'},layout:'form',id:'modx-usergroup-form',labelAlign:'top',labelSeparator:'',items:[{xtype:'panel',border:false,cls:'main-wrapper',layout:'form',items:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',labelSeparator:'',anchor:'100%',border:false},items:[{columnWidth:.6,items:[{xtype:'hidden',name:'id',id:'modx-usergroup-id',value:config.record.id},{name:'name',id:'modx-usergroup-name',xtype:config.record&&(config.record.name=='Administrator'||config.record.id==0)?'statictextfield':'textfield',fieldLabel:_('name')+'<span class="required">*</span>',allowBlank:false,enableKeyEvents:true,disabled:config.record.id===0,anchor:'100%',listeners:{'keyup':{scope:this,fn:function(f,e){Ext.getCmp('modx-user-group-header').getEl().update('<h2>'+_('user_group')+': '+f.getValue()+'</h2>');}}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-usergroup-name',html:_('user_group_desc_name'),cls:'desc-under'},{name:'description',id:'modx-usergroup-description',xtype:'textarea',fieldLabel:_('description'),anchor:'100%',grow:true},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-usergroup-description',html:_('user_group_desc_description'),cls:'desc-under'}]},{columnWidth:.4,items:[{name:'parent',hiddenName:'parent',id:'modx-usergroup-parent',xtype:'modx-combo-usergroup',fieldLabel:_('user_group_parent'),editable:false,anchor:'100%',disabled:config.record.id===0,baseParams:{action:'security/group/getList',addNone:true,exclude:config.record.id}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-usergroup-parent',html:_('user_group_desc_parent'),cls:'desc-under'},{name:'dashboard',id:'modx-usergroup-dashboard',xtype:'modx-combo-dashboard',fieldLabel:_('dashboard'),anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-usergroup-dashboard',html:_('user_group_desc_dashboard'),cls:'desc-under'}]}]}]}]},{title:_('users'),hideMode:'offsets',layout:'form',id:'modx-usergroup-users-panel',items:[{html:'<p>'+_('user_group_user_access_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-group-users',cls:'main-wrapper',preventRender:true,usergroup:config.record.id,autoHeight:true,width:'97%',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'updateRole':{fn:this.markDirty,scope:this},'addMember':{fn:this.markDirty,scope:this}}}]},{title:_('settings'),forceLayout:true,hideMode:'offsets',layout:'form',items:[{html:'<p>'+_('user_group_settings_desc')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-group-settings',cls:'main-wrapper',preventRender:true,group:config.record.id,autoHeight:true,width:'97%'}]},{title:_('permissions'),hidden:config.record.id===0,forceLayout:true,hideMode:'offsets',items:[{xtype:'modx-vtabs',items:[{title:_('user_group_context_access'),forceLayout:true,hideMode:'offsets',layout:'form',items:[{html:'<p>'+_('user_group_context_access_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-group-context',preventRender:true,usergroup:config.record.id,autoHeight:true,cls:'main-wrapper',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'afteredit':{fn:this.markDirty,scope:this},'updateAcl':{fn:this.markDirty,scope:this},'createAcl':{fn:this.markDirty,scope:this}}}]},{title:_('user_group_resourcegroup_access'),hidden:config.record.id===0,hideMode:'offsets',layout:'form',items:[{html:'<p>'+_('user_group_resourcegroup_access_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-group-resource-group',cls:'main-wrapper',preventRender:true,usergroup:config.record.id,autoHeight:true,width:'97%',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'afteredit':{fn:this.markDirty,scope:this},'updateAcl':{fn:this.markDirty,scope:this},'createAcl':{fn:this.markDirty,scope:this}}}]},{title:_('user_group_category_access'),hidden:config.record.id===0,hideMode:'offsets',layout:'form',items:[{html:'<p>'+_('user_group_category_access_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-group-category',cls:'main-wrapper',preventRender:true,usergroup:config.record.id,autoHeight:true,width:'97%',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'afteredit':{fn:this.markDirty,scope:this},'updateAcl':{fn:this.markDirty,scope:this},'createAcl':{fn:this.markDirty,scope:this}}}]},{title:_('user_group_source_access'),hidden:config.record.id===0,hideMode:'offsets',layout:'form',items:[{html:'<p>'+_('user_group_source_access_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-group-source',cls:'main-wrapper',preventRender:true,usergroup:config.record.id,autoHeight:true,width:'97%',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'afteredit':{fn:this.markDirty,scope:this},'updateAcl':{fn:this.markDirty,scope:this},'createAcl':{fn:this.markDirty,scope:this}}}]}]}]}]}],useLoadingMask:false,listeners:{'setup':{fn:this.setup,scope:this},'success':{fn:this.success,scope:this},'beforeSubmit':{fn:this.beforeSubmit,scope:this}}});MODx.panel.UserGroup.superclass.constructor.call(this,config);if(config.record.id==0||MODx.perm.usergroup_user_list==0){var tbs=Ext.getCmp('modx-usergroup-tabs');tbs.hideTabStripItem('modx-usergroup-users-panel');}};Ext.extend(MODx.panel.UserGroup,MODx.FormPanel,{initialized:false,setup:function(){if(this.initialized||this.config.usergroup===''||this.config.usergroup==undefined){this.fireEvent('ready');return false;}
var r=this.config.record;this.getForm().setValues(r);Ext.defer(function(){Ext.get('modx-user-group-header').update('<h2>'+_('user_group')+': '+r.name+'</h2>');},250,this);this.fireEvent('ready',r);MODx.fireEvent('ready');this.initialized=true;},beforeSubmit:function(o){},success:function(o){}});Ext.reg('modx-panel-user-group',MODx.panel.UserGroup);MODx.grid.UserGroupUsers=function(config){config=config||{};Ext.applyIf(config,{title:'',id:'modx-grid-user-group-users',url:MODx.config.connector_url,baseParams:{action:'security/group/user/getList',usergroup:config.usergroup},paging:true,grouping:true,remoteSort:true,groupBy:'role_name',singleText:_('user'),pluralText:_('users'),sortBy:'authority',sortDir:'ASC',fields:['id','username','role','role_name','authority'],columns:[{header:_('username'),dataIndex:'username',width:175,sortable:true},{header:_('role'),dataIndex:'role_name',width:175,sortable:true}],tbar:[{text:_('user_group_user_add'),cls:'primary-button',handler:this.addMember,hidden:MODx.perm.usergroup_user_edit==0},'->',{xtype:'textfield',id:'modx-ugu-filter-username',cls:'x-form-filter',listeners:{'change':{fn:this.searchUser,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:function(){this.fireEvent('change',this.getValue());this.blur();return true;},scope:cmp});}}},emptyText:_('search'),scope:this},{text:_('clear_filter'),id:'modx-ugu-clear-filter',cls:'x-form-filter-clear',handler:this.clearFilter,scope:this}]});MODx.grid.UserGroupUsers.superclass.constructor.call(this,config);this.addEvents('updateRole','addMember');};Ext.extend(MODx.grid.UserGroupUsers,MODx.grid.Grid,{getMenu:function(){var m=[];if(MODx.perm.usergroup_user_edit){m.push({text:_('user_role_update'),handler:this.updateRole});m.push('-');m.push({text:_('user_group_user_remove'),handler:this.removeUser});}
return m;},searchUser:function(tf,nv,ov){this.getStore().baseParams['username']=Ext.getCmp('modx-ugu-filter-username').getValue();this.getBottomToolbar().changePage(1);this.refresh();},clearFilter:function(btn,e){Ext.getCmp('modx-ugu-filter-username').setValue('');this.getStore().baseParams['username']='';this.getBottomToolbar().changePage(1);this.refresh();},updateRole:function(btn,e){var r=this.menu.record;r.usergroup=this.config.usergroup;r.user=r.id;this.loadWindow(btn,e,{xtype:'modx-window-user-group-role-update',record:r,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('updateRole',r);},scope:this}}});},addMember:function(btn,e){this.loadWindow(btn,e,{xtype:'modx-window-user-group-adduser',record:{usergroup:this.config.usergroup},listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('addMember',r);},scope:this}}});},removeUser:function(btn,e){var r=this.menu.record;MODx.msg.confirm({title:_('warning'),text:_('user_group_user_remove_confirm')||_('confirm_remove'),url:this.config.url,params:{action:'security/group/user/remove',user:r.id,usergroup:this.config.usergroup},listeners:{'success':{fn:this.refresh,scope:this}}});}});Ext.reg('modx-grid-user-group-users',MODx.grid.UserGroupUsers);MODx.window.UpdateUserGroupRole=function(config){config=config||{};Ext.applyIf(config,{id:'modx-window-user-group-role-update',title:_('user_group_user_update_role'),url:MODx.config.connector_url,action:'security/group/user/update',fields:[{xtype:'hidden',name:'usergroup',value:config.usergroup},{xtype:'hidden',name:'user',value:config.user},{xtype:'modx-combo-usergrouprole',id:'modx-uugr-role',name:'role',fieldLabel:_('role')}]});MODx.window.UpdateUserGroupRole.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateUserGroupRole,MODx.Window);Ext.reg('modx-window-user-group-role-update',MODx.window.UpdateUserGroupRole);MODx.window.AddUserToUserGroup=function(config){config=config||{};this.ident=config.ident||'auug'+Ext.id();Ext.applyIf(config,{title:_('user_group_user_add'),url:MODx.config.connector_url,action:'security/group/user/create',fields:[{fieldLabel:_('user'),description:MODx.expandHelp?'':_('user_group_user_add_user_desc'),name:'user',hiddenName:'user',id:'modx-auug-user',xtype:'modx-combo-user',editable:true,typeAhead:true,allowBlank:false,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-user',html:_('user_group_user_add_user_desc'),cls:'desc-under'},{fieldLabel:_('role'),description:MODx.expandHelp?'':_('user_group_user_add_role_desc'),name:'role',hiddenName:'role',id:'modx-auug-role',xtype:'modx-combo-role',allowBlank:false,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-role',html:_('user_group_user_add_role_desc'),cls:'desc-under'},{name:'usergroup',xtype:'hidden'}]});MODx.window.AddUserToUserGroup.superclass.constructor.call(this,config);};Ext.extend(MODx.window.AddUserToUserGroup,MODx.Window);Ext.reg('modx-window-user-group-adduser',MODx.window.AddUserToUserGroup);MODx.combo.Authority=function(config){config=config||{};Ext.applyIf(config,{name:'authority',hiddenName:'authority',forceSelection:true,typeAhead:false,editable:false,allowBlank:false,pageSize:20,url:MODx.config.connector_url,baseParams:{action:'security/role/getAuthorityList',addNone:true}});MODx.combo.Authority.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.Authority,MODx.combo.ComboBox);Ext.reg('modx-combo-authority',MODx.combo.Authority);;MODx.page.UpdateUserGroup=function(config){config=config||{};Ext.applyIf(config,{formpanel:'modx-panel-user-group',buttons:[{process:'security/group/update',text:_('save'),id:'modx-abtn-save',cls:'primary-button',method:'remote',keys:[{key:MODx.config.keymap_save||'s',ctrl:true}]},{text:_('cancel'),id:'modx-abtn-cancel',handler:function(){MODx.loadPage('security/permission')}},{text:_('help_ex'),id:'modx-abtn-help',handler:MODx.loadHelpPane}],components:[{xtype:'modx-panel-user-group',record:config.record||{},usergroup:MODx.request.id}]});MODx.page.UpdateUserGroup.superclass.constructor.call(this,config);};Ext.extend(MODx.page.UpdateUserGroup,MODx.Component);Ext.reg('modx-page-user-group-update',MODx.page.UpdateUserGroup);