var GAL=function(config){config=config||{};GAL.superclass.constructor.call(this,config);};Ext.extend(GAL,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},view:{}});Ext.reg('gallery',GAL);GAL=new GAL();GAL.window.CreateAlbum=function(config){config=config||{};this.ident=config.ident||'gcalb'+Ext.id();Ext.applyIf(config,{title:_('gallery.album_create'),id:this.ident,width:600,url:GAL.config.connector_url,action:'mgr/album/create',fields:[{xtype:'hidden',name:'parent'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:config.record['parent']==0?'hidden':'statictextfield',fieldLabel:_('gallery.parent'),name:'parent_name',id:this.ident+'-parent-name',anchor:'100%'},{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'}]},{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('gallery.year'),name:'year',anchor:'100%',allowBlank:true},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.active_desc'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.prominent'),description:MODx.expandHelp?'':_('gallery.prominent_desc'),name:'prominent',id:this.ident+'-prominent',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-prominent',text:_('gallery.prominent_desc'),cls:'desc-under'}]}]}]});GAL.window.CreateAlbum.superclass.constructor.call(this,config);};Ext.extend(GAL.window.CreateAlbum,MODx.Window);Ext.reg('gal-window-album-create',GAL.window.CreateAlbum);GAL.window.UpdateItem=function(config){config=config||{};this.ident=config.ident||'gupdit'+Ext.id();Ext.applyIf(config,{title:_('gallery.item_update'),id:this.ident,closeAction:'close',width:600,url:GAL.config.connector_url,action:'mgr/item/update',fileUpload:true,fields:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'},{xtype:'textfield',fieldLabel:_('gallery.item_url'),description:MODx.expandHelp?'':_('gallery.item_url_desc'),name:'url',id:this.ident+'-item-url',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-item-url',text:_('gallery.item_url_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'hidden',name:'thumbnail'},{xtype:'hidden',name:'image'},{html:'',id:this.ident+'-preview'},{xtype:'statictextfield',name:'id',fieldLabel:_('id'),submitValue:true,anchor:'100%'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]}]});GAL.window.UpdateItem.superclass.constructor.call(this,config);this.on('activate',function(w,e){if(typeof Tiny!='undefined'){MODx.loadRTE(this.ident+'-description');}
var d=this.fp.getForm().getValues();if(d&&d.image){var p=Ext.getCmp(this.ident+'-preview');var u=d.image+'&h=200&w=200&zc=1&q=100&f=png';p.update('<div class="gal-item-update-preview"><img src="'+u+'" alt="" onclick="Ext.getCmp(\'gal-album-items-view\').showScreenshot(\''+d.id+'\'); return false;" /></div>');}},this);};Ext.extend(GAL.window.UpdateItem,MODx.Window);Ext.reg('gal-window-item-update',GAL.window.UpdateItem);GAL.window.UploadItem=function(config){config=config||{};this.ident=config.ident||'gupit'+Ext.id();Ext.applyIf(config,{title:_('gallery.item_upload'),id:this.ident,width:600,url:GAL.config.connector_url,action:'mgr/item/upload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,cls:(MODx.config.connector_url)?'':'main-wrapper',labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('name'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:this.ident+'-description',anchor:'100%'},{xtype:'textfield',fieldLabel:_('gallery.item_url'),description:_('gallery.item_url_desc'),name:'url',id:this.ident+'-item-url',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-item-url',text:_('gallery.item_url_desc'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.file'),description:MODx.expandHelp?'':_('gallery.item_upload_file_desc'),name:'file',id:this.ident+'-file',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-file',text:_('gallery.item_upload_file_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),name:'active',description:'',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]}]});GAL.window.UploadItem.superclass.constructor.call(this,config);this.on('activate',function(){if(typeof Tiny!='undefined'){MODx.loadRTE(this.ident+'-description');}});};Ext.extend(GAL.window.UploadItem,MODx.Window);Ext.reg('gal-window-item-upload',GAL.window.UploadItem);GAL.window.UploadCover=function(config){config=config||{};this.ident=config.ident||'gupit'+Ext.id();Ext.applyIf(config,{title:_('gallery.cover_upload'),id:this.ident,height:300,saveBtnText:_('gallery.upload_cover'),url:GAL.config.connector_url,action:'mgr/album/uploadcover',fileUpload:true,fields:[{xtype:'hidden',name:'albumid'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',border:false,cls:(MODx.config.connector_url)?'':'main-wrapper',labelSeparator:''},items:[{columnWidth:1,items:[{xtype:'hidden',name:'id'},{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.file'),description:MODx.expandHelp?'':_('gallery.item_upload_file_desc'),name:'file',id:this.ident+'-file',anchor:'100%'},{xtype:'panel',fieldLabel:_('gallery.current_cover'),html:'',id:this.ident+'-preview'}]}]}]});GAL.window.UploadCover.superclass.constructor.call(this,config);};Ext.extend(GAL.window.UploadCover,MODx.Window);Ext.reg('gal-window-cover-update',GAL.window.UploadCover);GAL.window.UploadMultiItems=function(config){config=config||{};this.ident=config.ident||'gupmuit'+Ext.id();Ext.applyIf(config,{title:_('gallery.multi_item_upload'),id:this.ident,height:350,fields:[{xtype:'hidden',name:'album'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,labelSeparator:''},items:[{columnWidth:.5,items:[{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.comma_separated_list'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.comma_separated_list'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'checkbox',boxLabel:_('gallery.active'),hideLabel:true,name:'active',description:'',id:this.ident+'-active',checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]}]},{html:'<div id="file-upload" />'+_('gallery.loading_ellipsis')+'</div>',id:'file-upload-field',xtype:'panel'}],buttons:[{text:_('done'),scope:this,handler:function(){this.hide();}}],keys:[]});GAL.window.UploadMultiItems.superclass.constructor.call(this,config);this.on('show',this.setup,this)};Ext.extend(GAL.window.UploadMultiItems,MODx.Window,{setup:function(){if(typeof GAL.uploader=='undefined'){GAL.uploader=new qq.FileUploader({element:document.getElementById('file-upload'),action:GAL.config.connector_url,params:{action:'mgr/item/ajaxupload',album:this.config.album,HTTP_MODAUTH:MODx.siteId},onComplete:function(){GAL.uploader.win.fireEvent('success');},onSubmit:function(){var f=GAL.uploader.win.fp.getForm();var data={active:f.findField('active').getValue()?1:0,tags:f.findField('tags').getValue()};var p=this.params;Ext.apply(p,data);GAL.uploader.setParams(p);}});GAL.uploader.win=this;}}});Ext.reg('gal-window-multi-item-upload',GAL.window.UploadMultiItems);GAL.window.BatchUpload=function(config){config=config||{};this.ident=config.ident||'gupbu'+Ext.id();Ext.applyIf(config,{title:_('gallery.batch_upload'),id:this.ident,url:GAL.config.connector_url,action:'mgr/item/batchupload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{xtype:'textfield',fieldLabel:_('gallery.directory'),description:MODx.expandHelp?'':_('gallery.batch_upload_intro'),name:'directory',id:this.ident+'-directory',anchor:'100%',value:MODx.config['gallery.default_batch_upload_path']||'{assets_path}images/'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-directory',text:_('gallery.batch_upload_intro'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.batch_upload_tags'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.batch_upload_tags'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]});GAL.window.BatchUpload.superclass.constructor.call(this,config);};Ext.extend(GAL.window.BatchUpload,MODx.Window);Ext.reg('gal-window-batch-upload',GAL.window.BatchUpload);GAL.window.ZipUpload=function(config){config=config||{};this.ident=config.ident||'gupbu'+Ext.id();Ext.applyIf(config,{title:_('gallery.zip_upload'),id:this.ident,url:GAL.config.connector_url,action:'mgr/item/zipupload',fileUpload:true,fields:[{xtype:'hidden',name:'album'},{xtype:(MODx.config.connector_url)?'fileuploadfield':'textfield',inputType:(MODx.config.connector_url)?'text':'file',fieldLabel:_('gallery.zip_file'),description:MODx.expandHelp?'':_('gallery.zip_upload_intro'),name:'zip',id:this.ident+'-zip',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-zip',text:_('gallery.zip_upload_intro'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('gallery.tags'),description:MODx.expandHelp?'':_('gallery.batch_upload_tags'),name:'tags',id:this.ident+'-tags',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-tags',text:_('gallery.batch_upload_tags'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.item_active_desc'),name:'active',id:this.ident+'-active',hideLabel:true,checked:true,inputValue:1},{xtype:MODx.expandHelp?'label':'hidden',forId:this.ident+'-active',text:_('gallery.item_active_desc'),cls:'desc-under'}]});GAL.window.ZipUpload.superclass.constructor.call(this,config);};Ext.extend(GAL.window.ZipUpload,MODx.Window);Ext.reg('gal-window-zip-upload',GAL.window.ZipUpload);;var galTreeHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gal-tree-handler'});galTreeHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galTreeHandlerClass,Ext.Component,{tree:null,data:{},windows:{},getMenu:function(t,node,e){this.tree=t;this.data=node.attributes&&node.attributes.data?node.attributes.data:{};var m=[];switch(node.attributes.type){case'root':m=this.getRootMenu(node,e);break;case'gallery-album':m=this.getAlbumMenu(node,e);break;case'gallery-item':m=this.getItemMenu(node,e);break;}
return m;},getItemMenu:function(node,e){return[{text:_('gallery.item_update'),handler:this.updateItem,scope:this},'-',{text:_('gallery.item_remove'),handler:this.removeItem,scope:this}];},getAlbumMenu:function(node,e){return[{text:_('gallery.album_create'),handler:this.createAlbum,scope:this},'-',{text:_('gallery.album_update'),handler:this.updateAlbum,scope:this},{text:_('gallery.upload'),menu:{items:[{text:_('gallery.item_upload'),handler:this.uploadItem,scope:this},{text:_('gallery.multi_item_upload'),handler:this.uploadMultiItems,scope:this},{text:_('gallery.batch_upload'),handler:this.batchUpload,scope:this},{text:_('gallery.zip_upload'),handler:this.zipUpload,scope:this}]}},'-',{text:_('gallery.album_remove'),handler:this.removeAlbum,scope:this}];},getRootMenu:function(node,e){return[{text:_('gallery.album_create'),handler:this.createAlbum,scope:this}];},createAlbum:function(btn,e){var r;if(this.data.id){var n=this.tree.cm.activeNode.attributes.data;r={'parent':n.id,parent_name:n.name};}else{r={'parent':0,parent_name:_('none')};}
if(!this.windows.createAlbum){this.windows.createAlbum=MODx.load({xtype:'gal-window-album-create',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.createAlbum.fp.getForm().reset();this.windows.createAlbum.setValues(r);this.windows.createAlbum.show(e.target);},updateAlbum:function(btn,e){var id=this.data.id?this.data.id:0;location.href='?a='+MODx.action['gallery:index']+'&album='+id+'&action=album/update';},removeAlbum:function(btn,e){MODx.msg.confirm({text:_('gallery.album_remove_confirm'),url:GAL.config.connector_url,params:{action:'mgr/album/remove',id:this.tree.cm.activeNode.attributes.data.id},listeners:{'success':{fn:function(r){this.tree.refreshParentNode();},scope:this}}});},updateItem:function(btn,e){this.windows.updateItem=MODx.load({xtype:'gal-window-item-update',listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});this.windows.updateItem.setValues(this.data);this.windows.updateItem.show(e.target);},removeItem:function(btn,e){MODx.msg.confirm({text:_('gallery.item_delete_confirm'),url:GAL.config.connector_url,params:{action:'mgr/item/remove',id:this.data.id},listeners:{'success':{fn:function(r){this.tree.refreshParentNode();},scope:this}}});},uploadMultiItems:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.uploadMultiItems){this.windows.uploadMultiItems=MODx.load({xtype:'gal-window-multi-item-upload',album:this.data.id,record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.uploadMultiItems.fp.getForm().reset();this.windows.uploadMultiItems.setValues(r);this.windows.uploadMultiItems.show(e.target);},uploadItem:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.uploadItem){this.windows.uploadItem=MODx.load({xtype:'gal-window-item-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}
this.windows.uploadItem.fp.getForm().reset();this.windows.uploadItem.setValues(r);this.windows.uploadItem.show(e.target);},batchUpload:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.batchUpload){this.windows.batchUpload=MODx.load({xtype:'gal-window-batch-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}else{this.windows.batchUpload.fp.getForm().reset();}
this.windows.batchUpload.setValues(r);this.windows.batchUpload.show(e.target);},zipUpload:function(btn,e){var r={album:this.data.id,active:true};if(!this.windows.zipUpload){this.windows.zipUpload=MODx.load({xtype:'gal-window-zip-upload',record:r,listeners:{'success':{fn:function(){this.tree.refreshParentNode();},scope:this}}});}else{this.windows.zipUpload.fp.getForm().reset();}
this.windows.zipUpload.setValues(r);this.windows.zipUpload.show(e.target);},handleDrop:function(t,dropEvent){this.tree=t;var dropNode=dropEvent.dropNode;var target=dropEvent.target;if(!target.attributes.type)return false;if(target.attributes.type=='gallery-album'&&dropNode.attributes.type=='gallery-item'&&dropEvent.point!='append')return false;if(dropNode.attributes.type=='gallery-album'&&target.attributes.type=='gallery-item')return false;return true;}});Ext.reg('gal-tree-handler',galTreeHandlerClass);var galTreeHandler=new galTreeHandlerClass();var galItemDropHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gallery-item-drop-handler'});galItemDropHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galItemDropHandlerClass,Ext.Component,{handle:function(target,opt){var na=target.node.attributes;var cfg={ddTargetEl:opt.ddTargetEl,cfg:opt.cfg,iframe:opt.cfg.iframe,iframeEl:opt.cfg.iframeEl,onInsert:opt.cfg.onInsert,panel:opt.cfg.panel,classKey:'modSnippet',pk:GAL.snippetGalleryItem,name:'GalleryItem'};GAL.elProps={id:na.data.id};MODx.loadInsertElement(cfg);setTimeout("galTreeWorkaround(GAL.elProps);",600);return true;}});var galItemDropHandler=new galItemDropHandlerClass();var galAlbumDropHandlerClass=function(config){config=config||{};Ext.apply(config,{id:'gallery-album-drop-handler'});galAlbumDropHandlerClass.superclass.constructor.call(this,config);};Ext.extend(galAlbumDropHandlerClass,Ext.Component,{handle:function(target,opt){var na=target.node.attributes;var cfg={ddTargetEl:opt.ddTargetEl,cfg:opt.cfg,iframe:opt.cfg.iframe,iframeEl:opt.cfg.iframeEl,onInsert:opt.cfg.onInsert,panel:opt.cfg.panel,classKey:'modSnippet',pk:GAL.snippetGallery,name:'Gallery'};GAL.elProps={album:na.data.id};MODx.loadInsertElement(cfg);setTimeout("galTreeWorkaround(GAL.elProps);",600);return true;}});var galAlbumDropHandler=new galAlbumDropHandlerClass();function galTreeWorkaround(props){var w=Ext.getCmp('modx-window-insert-element');w.modps=[];if(w){for(var k in props){var fld=Ext.getCmp('modx-iprop-'+k);if(fld){fld.setValue(props[k]);w.changeProp(k);}}}};setTimeout('galleryFixLeafDrag();',1200);function galleryFixLeafDrag(){var t=Ext.getCmp('modx-file-tree');if(t){t.on('startdrag',function(t,n,e){if(n.attributes.type=='gallery-album'){n.attributes.leaf=true;}},this);}};MODx.DataView=function(config){config=config||{};this._loadStore(config);Ext.applyIf(config.listeners||{},{'loadexception':{fn:this.onLoadException,scope:this},'beforeselect':{fn:function(view){return view.store.getRange().length>0;}},'contextmenu':{fn:this._showContextMenu,scope:this}});Ext.applyIf(config,{store:this.store,singleSelect:true,overClass:'x-view-over',emptyText:'<div style="padding:10px;">'+_('file_err_filter')+'</div>',closeAction:'hide'});MODx.DataView.superclass.constructor.call(this,config);this.config=config;this.cm=new Ext.menu.Menu();};Ext.extend(MODx.DataView,Ext.DataView,{lookup:{},onLoadException:function(){this.getEl().update('<div style="padding:10px;">'+_('data_err_load')+'</div>');},_addContextMenuItem:function(items){var a=items,l=a.length;for(var i=0;i<l;i=i+1){var options=a[i];if(options==='-'){this.cm.add('-');continue;}
var h=Ext.emptyFn;if(options.handler){h=eval(options.handler);}else{h=function(itm,e){var o=itm.options;var id=this.cm.activeNode.id.split('_');id=id[1];var w=Ext.get('modx_content');if(o.confirm){Ext.Msg.confirm('',o.confirm,function(e){if(e==='yes'){var a=Ext.urlEncode(o.params||{action:o.action});var s='?id='+id+'&'+a;if(w===null){location.href=s;}else{w.dom.src=s;}}},this);}else{var a=Ext.urlEncode(o.params);var s='?id='+id+'&'+a;if(w===null){location.href=s;}else{w.dom.src=s;}}};}
this.cm.add({id:options.id,text:options.text,scope:this,options:options,handler:h});}},_loadStore:function(config){this.store=new Ext.data.JsonStore({url:config.url,baseParams:config.baseParams||{action:'browser/directory/getList',wctx:config.wctx||MODx.ctx,dir:config.openTo||'',source:config.source||0},root:config.root||'results',fields:config.fields,totalProperty:'total',listeners:{'load':{fn:function(){this.select(0);},scope:this,single:true}}});this.store.load();},_showContextMenu:function(v,i,n,e){e.preventDefault();var data=this.lookup[n.id];var m=this.cm;m.removeAll();if(data.menu){this._addContextMenuItem(data.menu);m.show(n,'tl-c?');}
m.activeNode=n;}});Ext.reg('modx-dataview',MODx.DataView);Ext.namespace('MODx.browser');MODx.Browser=function(config){if(MODx.browserOpen&&!config.multiple)return false;if(!config.multiple)MODx.browserOpen=true;config=config||{};Ext.applyIf(config,{onSelect:function(data){},scope:this,source:config.source||1,cls:'modx-browser',closeAction:'hide'});MODx.Browser.superclass.constructor.call(this,config);this.config=config;this.win=new MODx.browser.Window(config);this.win.reset();};Ext.extend(MODx.Browser,Ext.Component,{show:function(el){if(this.win){this.win.show(el);}},hide:function(){if(this.win){this.win.hide();}},setSource:function(source){this.config.source=source;this.win.tree.config.baseParams.source=source;this.win.view.config.baseParams.source=source;}});Ext.reg('modx-browser',MODx.Browser);MODx.browser.Window=function(config){config=config||{};this.ident=Ext.id();this.view=MODx.load({xtype:'modx-browser-view',onSelect:{fn:this.onSelect,scope:this},source:config.source||MODx.config.default_media_source,allowedFileTypes:config.allowedFileTypes||'',wctx:config.wctx||'web',openTo:config.openTo||'',ident:this.ident,id:this.ident+'-view'});this.tree=MODx.load({xtype:'modx-tree-directory',onUpload:function(){this.view.run();},scope:this,source:config.source||MODx.config.default_media_source,hideFiles:config.hideFiles||false,openTo:config.openTo||'',ident:this.ident,rootId:config.rootId||'/',rootName:_('files'),rootVisible:config.rootVisible==undefined||!Ext.isEmpty(config.rootId),id:this.ident+'-tree',hideSourceCombo:config.hideSourceCombo||false,useDefaultToolbar:false,listeners:{'afterUpload':{fn:function(){this.view.run();},scope:this},'changeSource':{fn:function(s){this.config.source=s;this.view.config.source=s;this.view.baseParams.source=s;this.view.dir='/';this.view.run();},scope:this},'nodeclick':{fn:function(n,e){n.select();e.preventDefault();e.stopPropagation();return false;},scope:this},afterrender:{fn:function(tree){tree.root.expand();},scope:this}}});this.tree.on('click',function(node,e){this.load(node.id);},this);Ext.applyIf(config,{title:_('modx_browser')+' ('+(MODx.ctx?MODx.ctx:'web')+')',cls:'modx-browser-win',layout:'border',minWidth:500,minHeight:300,width:'90%',height:Ext.getBody().getViewSize().height*0.9,modal:false,closeAction:'hide',border:false,items:[{id:this.ident+'-browser-tree',cls:'modx-browser-tree',region:'west',width:250,height:'100%',items:this.tree,autoScroll:true,split:true,border:false},{id:this.ident+'-browser-view',cls:'modx-browser-view-ct',region:'center',autoScroll:true,border:false,items:this.view,tbar:this.getToolbar()},{id:this.ident+'-img-detail-panel',cls:'modx-browser-details-ct',region:'east',split:true,border:false,width:250}],buttons:[{id:this.ident+'-cancel-btn',text:_('cancel'),handler:this.close,scope:this},{id:this.ident+'-ok-btn',text:_('ok'),cls:'primary-button',handler:this.onSelect,scope:this}],keys:{key:27,handler:this.hide,scope:this}});MODx.browser.Window.superclass.constructor.call(this,config);this.config=config;this.addEvents({'select':true});};Ext.extend(MODx.browser.Window,Ext.Window,{returnEl:null,filter:function(){var filter=Ext.getCmp(this.ident+'filter');this.view.store.filter('name',filter.getValue(),true);this.view.select(0);},setReturn:function(el){this.returnEl=el;},load:function(dir){dir=dir||(Ext.isEmpty(this.config.openTo)?'':this.config.openTo);this.view.run({dir:dir,source:this.config.source,allowedFileTypes:this.config.allowedFileTypes||'',wctx:this.config.wctx||'web'});this.sortStore();},sortStore:function(){var v=Ext.getCmp(this.ident+'sortSelect').getValue();this.view.store.sort(v,v=='name'?'ASC':'DESC');this.view.select(0);},changeViewmode:function(){var v=Ext.getCmp(this.ident+'viewSelect').getValue();this.view.setTemplate(v);this.view.select(0);},reset:function(){if(this.rendered){Ext.getCmp(this.ident+'filter').reset();this.view.getEl().dom.scrollTop=0;}
this.view.store.clearFilter();this.view.select(0);},getToolbar:function(){return[{text:_('filter')+':',xtype:'label'},{xtype:'textfield',id:this.ident+'filter',selectOnFocus:true,width:200,listeners:{'render':{fn:function(){Ext.getCmp(this.ident+'filter').getEl().on('keyup',function(){this.filter();},this,{buffer:500});},scope:this}}},{text:_('sort_by')+':',xtype:'label'},{id:this.ident+'sortSelect',xtype:'combo',typeAhead:true,triggerAction:'all',width:100,editable:false,mode:'local',displayField:'desc',valueField:'name',lazyInit:false,value:MODx.config.modx_browser_default_sort||'name',store:new Ext.data.SimpleStore({fields:['name','desc'],data:[['name',_('name')],['size',_('file_size')],['lastmod',_('last_modified')]]}),listeners:{'select':{fn:this.sortStore,scope:this}}},'-',{text:_('files_viewmode')+':',xtype:'label'},'-',{id:this.ident+'viewSelect',xtype:'combo',typeAhead:false,triggerAction:'all',width:100,editable:false,mode:'local',displayField:'desc',valueField:'type',lazyInit:false,value:MODx.config.modx_browser_default_viewmode||'grid',store:new Ext.data.SimpleStore({fields:['type','desc'],data:[['grid',_('files_viewmode_grid')],['list',_('files_viewmode_list')]]}),listeners:{'select':{fn:this.changeViewmode,scope:this}}}];},onSelect:function(data){var selNode=this.view.getSelectedNodes()[0];var callback=this.config.onSelect||this.onSelectHandler;var lookup=this.view.lookup;var scope=this.config.scope;this.hide(this.config.animEl||null,function(){if(selNode&&callback){var data=lookup[selNode.id];Ext.callback(callback,scope||this,[data]);this.fireEvent('select',data);}},scope);},onSelectHandler:function(data){Ext.get(this.returnEl).dom.value=unescape(data.url);}});Ext.reg('modx-browser-window',MODx.browser.Window);MODx.browser.View=function(config){config=config||{};this.ident=config.ident+'-view'||'modx-browser-'+Ext.id()+'-view';this._initTemplates();Ext.applyIf(config,{url:MODx.config.connector_url,id:this.ident,fields:[{name:'name',sortType:Ext.data.SortTypes.asUCString},'cls','url','relativeUrl','fullRelativeUrl','image','image_width','image_height','thumb','thumb_width','thumb_height','pathname','ext','disabled','preview',{name:'size',type:'float'},{name:'lastmod',type:'date',dateFormat:'timestamp'},'menu'],baseParams:{action:'browser/directory/getfiles',prependPath:config.prependPath||null,prependUrl:config.prependUrl||null,source:config.source||1,allowedFileTypes:config.allowedFileTypes||'',wctx:config.wctx||'web',dir:config.openTo||''},tpl:MODx.config.modx_browser_default_viewmode==='list'?this.templates.list:this.templates.thumb,itemSelector:MODx.config.modx_browser_default_viewmode==='list'?'div.modx-browser-list-item':'div.modx-browser-thumb-wrap',listeners:{'selectionchange':{fn:this.showDetails,scope:this,buffer:100},'dblclick':config.onSelect||{fn:Ext.emptyFn,scope:this},'render':{fn:this.sortStore,scope:this}},prepareData:this.formatData.createDelegate(this)});MODx.browser.View.superclass.constructor.call(this,config);};Ext.extend(MODx.browser.View,MODx.DataView,{templates:{},removeFile:function(item,e){var node=this.cm.activeNode;var data=this.lookup[node.id];var d='';if(typeof(this.dir)!='object'&&typeof(this.dir)!='undefined'){d=this.dir;}
MODx.msg.confirm({text:_('file_remove_confirm'),url:MODx.config.connector_url,params:{action:'browser/file/remove',file:d+'/'+node.id,source:this.config.source,wctx:this.config.wctx||'web'},listeners:{'success':{fn:function(r){this.run();},scope:this}}});},run:function(p){p=p||{};if(p.dir){this.dir=p.dir;}
Ext.applyIf(p,{action:'browser/directory/getFiles',dir:this.dir,source:this.config.source||MODx.config.default_media_source});this.store.load({params:p,callback:function(){this.refresh();this.select(0);},scope:this});},setTemplate:function(tpl){if(tpl==='list'){this.tpl=this.templates.list;this.itemSelector='div.modx-browser-list-item';}else{this.tpl=this.templates.thumb;this.itemSelector='div.modx-browser-thumb-wrap';}
this.refresh();this.select(0);},sortStore:function(){var v=MODx.config.modx_browser_default_sort||'name'
this.store.sort(v,v=='name'?'ASC':'DESC');this.select(0);},showDetails:function(){var selNode=this.getSelectedNodes();var detailEl=Ext.getCmp(this.config.ident+'-img-detail-panel').body;var okBtn=Ext.getCmp(this.ident+'-ok-btn');if(selNode&&selNode.length>0){selNode=selNode[0];if(okBtn){okBtn.enable();}
var data=this.lookup[selNode.id];detailEl.hide();this.templates.details.overwrite(detailEl,data);detailEl.slideIn('l',{stopFx:true,duration:'.2'});}else{if(okBtn){okBtn.disable();}
detailEl.update('');}},formatData:function(data){var formatSize=function(size){if(size<1024){return size+" bytes";}else{return(Math.round(((size*10)/1024))/10)+" KB";}};data.shortName=Ext.util.Format.ellipsis(data.name,18);data.sizeString=data.size!=0?formatSize(data.size):0;data.imageSizeString=data.preview!=0?data.image_width+"x"+data.image_height+"px":0;data.dateString=!Ext.isEmpty(data.lastmod)?new Date(data.lastmod).format(MODx.config.manager_date_format+" "+MODx.config.manager_time_format):0;this.lookup[data.name]=data;return data;},_initTemplates:function(){this.templates.thumb=new Ext.XTemplate('<tpl for=".">','<div class="modx-browser-thumb-wrap" id="{name}" title="{name}">','  <div class="modx-browser-thumb">','      <img src="{thumb}" title="{name}" />','  </div>','  <span>{shortName}</span>','</div>','</tpl>');this.templates.thumb.compile();this.templates.list=new Ext.XTemplate('<tpl for=".">','<div class="modx-browser-list-item" id="{name}">','  <span class="icon icon-file {cls}">','      <span class="file-name">{name}</span>','      <tpl if="sizeString !== 0">','      <span class="file-size">{sizeString}</span>','      </tpl>','      <tpl if="imageSizeString !== 0">','      <span class="image-size">{imageSizeString}</span>','      </tpl>','  </span>','</div>','</tpl>');this.templates.list.compile();this.templates.details=new Ext.XTemplate('<div class="details">','  <tpl for=".">','  <div class="modx-browser-detail-thumb">','      <img src="{image}" alt="" onclick="Ext.getCmp(\''+this.ident+'\').showFullView(\'{name}\',\''+this.ident+'\'); return false;" />','  </div>','  <div class="modx-browser-details-info">','      <b>'+_('file_name')+':</b>','      <span>{name}</span>','  <tpl if="sizeString !== 0">','      <b>'+_('file_size')+':</b>','      <span>{sizeString}</span>','  </tpl>','  <tpl if="imageSizeString !== 0">','      <b>'+_('image_size')+':</b>','      <span>{imageSizeString}</span>','  </tpl>','  <tpl if="dateString !== 0">','      <b>'+_('last_modified')+':</b>','      <span>{dateString}</span>','  </tpl>','  </div>','  </tpl>','</div>');this.templates.details.compile();},showFullView:function(name,ident){var data=this.lookup[name];if(!data)return;if(!this.fvWin){this.fvWin=new Ext.Window({layout:'fit',width:600,height:450,closeAction:'hide',plain:true,items:[{id:this.ident+'modx-view-item-full',cls:'modx-browser-fullview',html:''}],buttons:[{text:_('close'),handler:function(){this.fvWin.hide();},scope:this}]});}
this.fvWin.show();var w=data.image_width<250?250:(data.image_width>800?800:data.image_width);var h=data.image_height<200?200:(data.image_height>600?600:data.image_width);this.fvWin.setSize(w,h);this.fvWin.center();this.fvWin.setTitle(data.name);Ext.get(this.ident+'modx-view-item-full').update('<img src="'+data.image+'" alt="" class="modx-browser-fullview-img" onclick="Ext.getCmp(\''+ident+'\').fvWin.hide();" />');}});Ext.reg('modx-browser-view',MODx.browser.View);;MODx.DataView.dropZone=function(view,config){config=config||{};this.view=view;var ddGroup=config.ddGroup||'dataviewdd';var dd;if(Ext.isArray(ddGroup)){dd=ddGroup.shift();}else{dd=ddGroup;ddGroup=null;}
MODx.DataView.dropZone.superclass.constructor.call(this,view.getEl(),{containerScroll:true});};Ext.extend(MODx.DataView.dropZone,Ext.dd.DropZone,{getTargetFromEvent:function(e){return e.getTarget('.modx-pb-thumb-wrap');},onNodeEnter:function(target,dd,e,data){Ext.fly(target).addClass('x-view-selected');},onNodeOut:function(target,dd,e,data){Ext.fly(target).removeClass('x-view-selected');},onNodeOver:function(target,dd,e,data){return Ext.dd.DropZone.prototype.dropAllowed&&(target!=data.nodes[0]);},onNodeDrop:function(target,dd,e,data){var targetNode=this.view.getRecord(target);var sourceNode=this.view.getRecord(data.nodes[0]);if(sourceNode==targetNode){return false;}
var targetElement=Ext.get(target);var sourceElement=Ext.get(data.nodes[0]);sourceElement.insertBefore(targetElement);this.view.fireEvent('sort',{target:targetNode,source:sourceNode,event:e,dd:dd});return true;}});MODx.DataView.dragZone=function(view,config){config=config||{};this.view=view;MODx.DataView.dragZone.superclass.constructor.call(this,view.getEl());};Ext.extend(MODx.DataView.dragZone,Ext.dd.DragZone,{getDragData:function(e){var target=e.getTarget('.modx-pb-thumb-wrap');if(target){var view=this.view;if(!view.isSelected(target)){view.onClick(e);}
var selNodes=view.getSelectedNodes();var dragData={nodes:selNodes};if(selNodes.length==1){dragData.ddel=target;dragData.single=true;}else{var div=document.createElement('div');div.className='multi-proxy';for(var i=0,len=selNodes.length;i<len;i++){div.appendChild(selNodes[i].firstChild.firstChild.cloneNode(true));if((i+1)%3==0){div.appendChild(document.createElement('br'));}}
var count=document.createElement('div');count.innerHTML=_('gallery.images_selected',{count:i});div.appendChild(count);dragData.ddel=div;dragData.multi=true;}
return dragData;}
return false;},afterRepair:function(){for(var i=0,len=this.dragData.nodes.length;i<len;i++){Ext.fly(this.dragData.nodes[i]).frame('#8db2e3',1);}
this.dragging=false;},getRepairXY:function(e){if(!this.dragData.multi){var xy=Ext.Element.fly(this.dragData.ddel).getXY();xy[0]+=3;xy[1]+=3;return xy;}
return false;}});function clearSuccess(){elements=Ext.select('.qq-upload-success');elements.remove();}
function clearFailure(){elements=Ext.select('.qq-upload-fail');elements.remove();}
var qq=qq||{};qq.extend=function(first,second){for(var prop in second){first[prop]=second[prop];}};qq.indexOf=function(arr,elt,from){if(arr.indexOf)return arr.indexOf(elt,from);from=from||0;var len=arr.length;if(from<0)from+=len;for(;from<len;from++){if(from in arr&&arr[from]===elt){return from;}}
return-1;};qq.getUniqueId=(function(){var id=0;return function(){return id++;};})();qq.attach=function(element,type,fn){if(element.addEventListener){element.addEventListener(type,fn,false);}else if(element.attachEvent){element.attachEvent('on'+type,fn);}};qq.detach=function(element,type,fn){if(element.removeEventListener){element.removeEventListener(type,fn,false);}else if(element.attachEvent){element.detachEvent('on'+type,fn);}};qq.preventDefault=function(e){if(e.preventDefault){e.preventDefault();}else{e.returnValue=false;}};qq.insertBefore=function(a,b){b.parentNode.insertBefore(a,b);};qq.remove=function(element){element.parentNode.removeChild(element);};qq.contains=function(parent,descendant){if(parent==descendant)return true;if(parent.contains){return parent.contains(descendant);}else{return!!(descendant.compareDocumentPosition(parent)&8);}};qq.toElement=(function(){var div=document.createElement('div');return function(html){div.innerHTML=html;var element=div.firstChild;div.removeChild(element);return element;};})();qq.css=function(element,styles){if(styles.opacity!=null){if(typeof element.style.opacity!='string'&&typeof(element.filters)!='undefined'){styles.filter='alpha(opacity='+Math.round(100*styles.opacity)+')';}}
qq.extend(element.style,styles);};qq.hasClass=function(element,name){var re=new RegExp('(^| )'+name+'( |$)');return re.test(element.className);};qq.addClass=function(element,name){if(!qq.hasClass(element,name)){element.className+=' '+name;}};qq.removeClass=function(element,name){var re=new RegExp('(^| )'+name+'( |$)');element.className=element.className.replace(re,' ').replace(/^\s+|\s+$/g,"");};qq.setText=function(element,text){element.innerText=text;element.textContent=text;};qq.children=function(element){var children=[],child=element.firstChild;while(child){if(child.nodeType==1){children.push(child);}
child=child.nextSibling;}
return children;};qq.getByClass=function(element,className){if(element.querySelectorAll){return element.querySelectorAll('.'+className);}
var result=[];var candidates=element.getElementsByTagName("*");var len=candidates.length;for(var i=0;i<len;i++){if(qq.hasClass(candidates[i],className)){result.push(candidates[i]);}}
return result;};qq.obj2url=function(obj,temp,prefixDone){var uristrings=[],prefix='&',add=function(nextObj,i){var nextTemp=temp?(/\[\]$/.test(temp))?temp:temp+'['+i+']':i;if((nextTemp!='undefined')&&(i!='undefined')){uristrings.push((typeof nextObj==='object')?qq.obj2url(nextObj,nextTemp,true):(Object.prototype.toString.call(nextObj)==='[object Function]')?encodeURIComponent(nextTemp)+'='+encodeURIComponent(nextObj()):encodeURIComponent(nextTemp)+'='+encodeURIComponent(nextObj));}};if(!prefixDone&&temp){prefix=(/\?/.test(temp))?(/\?$/.test(temp))?'':'&':'?';uristrings.push(temp);uristrings.push(qq.obj2url(obj));}else if((Object.prototype.toString.call(obj)==='[object Array]')&&(typeof obj!='undefined')){for(var i=0,len=obj.length;i<len;++i){add(obj[i],i);}}else if((typeof obj!='undefined')&&(obj!==null)&&(typeof obj==="object")){for(var i in obj){add(obj[i],i);}}else{uristrings.push(encodeURIComponent(temp)+'='+encodeURIComponent(obj));}
return uristrings.join(prefix).replace(/^&/,'').replace(/%20/g,'+');};var qq=qq||{};qq.FileUploaderBasic=function(o){this._options={debug:false,action:'/server/upload',params:{},button:null,multiple:true,maxConnections:3,allowedExtensions:[],sizeLimit:0,minSizeLimit:0,onSubmit:function(id,fileName){},onProgress:function(id,fileName,loaded,total){},onComplete:function(id,fileName,responseJSON){},onCancel:function(id,fileName){},messages:{typeError:"{file} has invalid extension. Only {extensions} are allowed.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",minSizeError:"{file} is too small, minimum file size is {minSizeLimit}.",emptyError:"{file} is empty, please select files again without it.",onLeave:"The files are being uploaded, if you leave now the upload will be cancelled."},showMessage:function(message){alert(message);}};qq.extend(this._options,o);this._filesInProgress=0;this._handler=this._createUploadHandler();if(this._options.button){this._button=this._createUploadButton(this._options.button);}
this._preventLeaveInProgress();};qq.FileUploaderBasic.prototype={setParams:function(params){this._options.params=params;},getInProgress:function(){return this._filesInProgress;},_createUploadButton:function(element){var self=this;return new qq.UploadButton({element:element,multiple:this._options.multiple&&qq.UploadHandlerXhr.isSupported(),onChange:function(input){self._onInputChange(input);}});},_createUploadHandler:function(){var self=this,handlerClass;if(qq.UploadHandlerXhr.isSupported()){handlerClass='UploadHandlerXhr';}else{handlerClass='UploadHandlerForm';}
var handler=new qq[handlerClass]({debug:this._options.debug,action:this._options.action,maxConnections:this._options.maxConnections,onProgress:function(id,fileName,loaded,total){self._onProgress(id,fileName,loaded,total);self._options.onProgress(id,fileName,loaded,total);},onComplete:function(id,fileName,result){self._onComplete(id,fileName,result);self._options.onComplete(id,fileName,result);},onCancel:function(id,fileName){self._onCancel(id,fileName);self._options.onCancel(id,fileName);}});return handler;},_preventLeaveInProgress:function(){var self=this;qq.attach(window,'beforeunload',function(e){if(!self._filesInProgress){return;}
var e=e||window.event;e.returnValue=self._options.messages.onLeave;return self._options.messages.onLeave;});},_onSubmit:function(id,fileName){this._filesInProgress++;},_onProgress:function(id,fileName,loaded,total){},_onComplete:function(id,fileName,result){this._filesInProgress--;if(result.error){this._options.showMessage(result.error);}},_onCancel:function(id,fileName){this._filesInProgress--;},_onInputChange:function(input){if(this._handler instanceof qq.UploadHandlerXhr){this._uploadFileList(input.files);}else{if(this._validateFile(input)){this._uploadFile(input);}}
this._button.reset();},_uploadFileList:function(files){for(var i=0;i<files.length;i++){if(!this._validateFile(files[i])){return;}}
for(var i=0;i<files.length;i++){this._uploadFile(files[i]);}},_uploadFile:function(fileContainer){var id=this._handler.add(fileContainer);var fileName=this._handler.getName(id);if(this._options.onSubmit(id,fileName)!==false){this._onSubmit(id,fileName);this._handler.upload(id,this._options.params);}},_validateFile:function(file){var name,size;if(file.value){name=file.value.replace(/.*(\/|\\)/,"");}else{name=file.fileName!=null?file.fileName:file.name;size=file.fileSize!=null?file.fileSize:file.size;}
if(!this._isAllowedExtension(name)){this._error('typeError',name);return false;}else if(size===0){this._error('emptyError',name);return false;}else if(size&&this._options.sizeLimit&&size>this._options.sizeLimit){this._error('sizeError',name);return false;}else if(size&&size<this._options.minSizeLimit){this._error('minSizeError',name);return false;}
return true;},_error:function(code,fileName){var message=this._options.messages[code];function r(name,replacement){message=message.replace(name,replacement);}
r('{file}',this._formatFileName(fileName));r('{extensions}',this._options.allowedExtensions.join(', '));r('{sizeLimit}',this._formatSize(this._options.sizeLimit));r('{minSizeLimit}',this._formatSize(this._options.minSizeLimit));this._options.showMessage(message);},_formatFileName:function(name){if(name.length>33){name=name.slice(0,19)+'...'+name.slice(-13);}
return name;},_isAllowedExtension:function(fileName){var ext=(-1!==fileName.indexOf('.'))?fileName.replace(/.*[.]/,'').toLowerCase():'';var allowed=this._options.allowedExtensions;if(!allowed.length){return true;}
for(var i=0;i<allowed.length;i++){if(allowed[i].toLowerCase()==ext){return true;}}
return false;},_formatSize:function(bytes){var i=-1;do{bytes=bytes/1024;i++;}while(bytes>99);return Math.max(bytes,0.1).toFixed(1)+['kB','MB','GB','TB','PB','EB'][i];}};qq.FileUploader=function(o){qq.FileUploaderBasic.apply(this,arguments);qq.extend(this._options,{element:null,listElement:null,template:'<div class="qq-uploader">'+'<div class="qq-upload-drop-area"><span>'+_('gallery.dropfileshere')+'</span></div>'+'<div class="qq-upload-button '+(MODx.config.connector_url?'x-btn primary-button':'')+'">'+_('file_upload')+'</div>'+'<p><a href="#" onclick="clearSuccess(); return false;">'+_('gallery.clearsuccessful')+'</a> | '+'<a href="#" onclick="clearFailure(); return false;">'+_('gallery.clearfailure')+'</a></p>'+'<ul class="qq-upload-list"></ul>'+'</div>',fileTemplate:'<li>'+'<span class="qq-upload-spinner"></span>'+'<a class="qq-upload-cancel" href="#">'+_('cancel')+'</a>'+'<span class="qq-upload-size"></span>'+'<span class="qq-upload-file"></span>'+'<span class="qq-upload-failed-text">'+_('failure')+'</span>'+'</li>',classes:{button:'qq-upload-button',drop:'qq-upload-drop-area',dropActive:'qq-upload-drop-area-active',list:'qq-upload-list',file:'qq-upload-file',spinner:'qq-upload-spinner',size:'qq-upload-size',cancel:'qq-upload-cancel',success:'qq-upload-success',fail:'qq-upload-fail'}});qq.extend(this._options,o);this._element=this._options.element;this._element.innerHTML=this._options.template;this._listElement=this._options.listElement||this._find(this._element,'list');this._classes=this._options.classes;this._button=this._createUploadButton(this._find(this._element,'button'));this._bindCancelEvent();this._setupDragDrop();};qq.extend(qq.FileUploader.prototype,qq.FileUploaderBasic.prototype);qq.extend(qq.FileUploader.prototype,{_find:function(parent,type){var element=qq.getByClass(parent,this._options.classes[type])[0];if(!element){throw new Error('element not found '+type);}
return element;},_setupDragDrop:function(){var self=this,dropArea=this._find(this._element,'drop');var dz=new qq.UploadDropZone({element:dropArea,onEnter:function(e){qq.addClass(dropArea,self._classes.dropActive);e.stopPropagation();},onLeave:function(e){e.stopPropagation();},onLeaveNotDescendants:function(e){qq.removeClass(dropArea,self._classes.dropActive);},onDrop:function(e){dropArea.style.display='none';qq.removeClass(dropArea,self._classes.dropActive);self._uploadFileList(e.dataTransfer.files);}});dropArea.style.display='none';qq.attach(document,'dragenter',function(e){if(!dz._isValidFileDrag(e))return;dropArea.style.display='block';});qq.attach(document,'dragleave',function(e){if(!dz._isValidFileDrag(e))return;var relatedTarget=document.elementFromPoint(e.clientX,e.clientY);if(!relatedTarget||relatedTarget.nodeName=="HTML"){dropArea.style.display='none';}});},_onSubmit:function(id,fileName){qq.FileUploaderBasic.prototype._onSubmit.apply(this,arguments);this._addToList(id,fileName);},_onProgress:function(id,fileName,loaded,total){qq.FileUploaderBasic.prototype._onProgress.apply(this,arguments);var item=this._getItemByFileId(id);var size=this._find(item,'size');size.style.display='inline';var text;if(loaded!=total){text=Math.round(loaded/total*100)+'% from '+this._formatSize(total);}else{text=this._formatSize(total);}
qq.setText(size,text);},_onComplete:function(id,fileName,result){qq.FileUploaderBasic.prototype._onComplete.apply(this,arguments);var item=this._getItemByFileId(id);qq.remove(this._find(item,'cancel'));qq.remove(this._find(item,'spinner'));if(result.success){qq.addClass(item,this._classes.success);}else{qq.addClass(item,this._classes.fail);}},_addToList:function(id,fileName){var item=qq.toElement(this._options.fileTemplate);item.qqFileId=id;var fileElement=this._find(item,'file');qq.setText(fileElement,this._formatFileName(fileName));this._find(item,'size').style.display='none';this._listElement.appendChild(item);},_getItemByFileId:function(id){var item=this._listElement.firstChild;while(item){if(item.qqFileId==id)return item;item=item.nextSibling;}},_bindCancelEvent:function(){var self=this,list=this._listElement;qq.attach(list,'click',function(e){e=e||window.event;var target=e.target||e.srcElement;if(qq.hasClass(target,self._classes.cancel)){qq.preventDefault(e);var item=target.parentNode;self._handler.cancel(item.qqFileId);qq.remove(item);}});}});qq.UploadDropZone=function(o){this._options={element:null,onEnter:function(e){},onLeave:function(e){},onLeaveNotDescendants:function(e){},onDrop:function(e){}};qq.extend(this._options,o);this._element=this._options.element;this._disableDropOutside();this._attachEvents();};qq.UploadDropZone.prototype={_disableDropOutside:function(e){if(!qq.UploadDropZone.dropOutsideDisabled){qq.attach(document,'dragover',function(e){if(e.dataTransfer){e.dataTransfer.dropEffect='none';e.preventDefault();}});qq.UploadDropZone.dropOutsideDisabled=true;}},_attachEvents:function(){var self=this;qq.attach(self._element,'dragover',function(e){if(!self._isValidFileDrag(e))return;var effect=e.dataTransfer.effectAllowed;if(effect=='move'||effect=='linkMove'){e.dataTransfer.dropEffect='move';}else{e.dataTransfer.dropEffect='copy';}
e.stopPropagation();e.preventDefault();});qq.attach(self._element,'dragenter',function(e){if(!self._isValidFileDrag(e))return;self._options.onEnter(e);});qq.attach(self._element,'dragleave',function(e){if(!self._isValidFileDrag(e))return;self._options.onLeave(e);var relatedTarget=document.elementFromPoint(e.clientX,e.clientY);if(qq.contains(this,relatedTarget))return;self._options.onLeaveNotDescendants(e);});qq.attach(self._element,'drop',function(e){if(!self._isValidFileDrag(e))return;e.preventDefault();self._options.onDrop(e);});},_isValidFileDrag:function(e){var dt=e.dataTransfer,isWebkit=navigator.userAgent.indexOf("AppleWebKit")>-1;return dt&&dt.effectAllowed!='none'&&(dt.files||(!isWebkit&&dt.types.contains&&dt.types.contains('Files')));}};qq.UploadButton=function(o){this._options={element:null,multiple:false,name:'file',onChange:function(input){},hoverClass:'qq-upload-button-hover',focusClass:'qq-upload-button-focus'};qq.extend(this._options,o);this._element=this._options.element;qq.css(this._element,{position:'relative',overflow:'hidden',direction:'ltr'});this._input=this._createInput();};qq.UploadButton.prototype={getInput:function(){return this._input;},reset:function(){if(this._input.parentNode){qq.remove(this._input);}
qq.removeClass(this._element,this._options.focusClass);this._input=this._createInput();},_createInput:function(){var input=document.createElement("input");if(this._options.multiple){input.setAttribute("multiple","multiple");}
input.setAttribute("type","file");input.setAttribute("name",this._options.name);qq.css(input,{position:'absolute',right:0,top:0,fontFamily:'Arial',fontSize:'118px',margin:0,padding:0,cursor:'pointer',opacity:0});this._element.appendChild(input);var self=this;qq.attach(input,'change',function(){self._options.onChange(input);});qq.attach(input,'mouseover',function(){qq.addClass(self._element,self._options.hoverClass);});qq.attach(input,'mouseout',function(){qq.removeClass(self._element,self._options.hoverClass);});qq.attach(input,'focus',function(){qq.addClass(self._element,self._options.focusClass);});qq.attach(input,'blur',function(){qq.removeClass(self._element,self._options.focusClass);});if(window.attachEvent){input.setAttribute('tabIndex',"-1");}
return input;}};qq.UploadHandlerAbstract=function(o){this._options={debug:false,action:'/upload.php',maxConnections:999,onProgress:function(id,fileName,loaded,total){},onComplete:function(id,fileName,response){},onCancel:function(id,fileName){}};qq.extend(this._options,o);this._queue=[];this._params=[];};qq.UploadHandlerAbstract.prototype={log:function(str){if(this._options.debug&&window.console)console.log('[uploader] '+str);},add:function(file){},upload:function(id,params){var len=this._queue.push(id);var copy={};qq.extend(copy,params);this._params[id]=copy;if(len<=this._options.maxConnections){this._upload(id,this._params[id]);}},cancel:function(id){this._cancel(id);this._dequeue(id);},cancelAll:function(){for(var i=0;i<this._queue.length;i++){this._cancel(this._queue[i]);}
this._queue=[];},getName:function(id){},getSize:function(id){},getQueue:function(){return this._queue;},_upload:function(id){},_cancel:function(id){},_dequeue:function(id){var i=qq.indexOf(this._queue,id);this._queue.splice(i,1);var max=this._options.maxConnections;if(this._queue.length>=max&&i<max){var nextId=this._queue[max-1];this._upload(nextId,this._params[nextId]);}}};qq.UploadHandlerForm=function(o){qq.UploadHandlerAbstract.apply(this,arguments);this._inputs={};};qq.extend(qq.UploadHandlerForm.prototype,qq.UploadHandlerAbstract.prototype);qq.extend(qq.UploadHandlerForm.prototype,{add:function(fileInput){fileInput.setAttribute('name','qqfile');var id='qq-upload-handler-iframe'+qq.getUniqueId();this._inputs[id]=fileInput;if(fileInput.parentNode){qq.remove(fileInput);}
return id;},getName:function(id){return this._inputs[id].value.replace(/.*(\/|\\)/,"");},_cancel:function(id){this._options.onCancel(id,this.getName(id));delete this._inputs[id];var iframe=document.getElementById(id);if(iframe){iframe.setAttribute('src','javascript:false;');qq.remove(iframe);}},_upload:function(id,params){var input=this._inputs[id];if(!input){throw new Error('file with passed id was not added, or already uploaded or cancelled');}
var fileName=this.getName(id);var iframe=this._createIframe(id);var form=this._createForm(iframe,params);form.appendChild(input);var self=this;this._attachLoadEvent(iframe,function(){self.log('iframe loaded');var response=self._getIframeContentJSON(iframe);self._options.onComplete(id,fileName,response);self._dequeue(id);delete self._inputs[id];setTimeout(function(){qq.remove(iframe);},1);});form.submit();qq.remove(form);return id;},_attachLoadEvent:function(iframe,callback){qq.attach(iframe,'load',function(){if(!iframe.parentNode){return;}
if(iframe.contentDocument&&iframe.contentDocument.body&&iframe.contentDocument.body.innerHTML=="false"){return;}
callback();});},_getIframeContentJSON:function(iframe){var doc=iframe.contentDocument?iframe.contentDocument:iframe.contentWindow.document,response;this.log("converting iframe's innerHTML to JSON");this.log("innerHTML = "+doc.body.innerHTML);try{response=eval("("+doc.body.innerHTML+")");}catch(err){response={};}
return response;},_createIframe:function(id){var iframe=qq.toElement('<iframe src="javascript:false;" name="'+id+'" />');iframe.setAttribute('id',id);iframe.style.display='none';document.body.appendChild(iframe);return iframe;},_createForm:function(iframe,params){var form=qq.toElement('<form method="post" enctype="multipart/form-data"></form>');var queryString=qq.obj2url(params,this._options.action);form.setAttribute('action',queryString);form.setAttribute('target',iframe.name);form.style.display='none';document.body.appendChild(form);return form;}});qq.UploadHandlerXhr=function(o){qq.UploadHandlerAbstract.apply(this,arguments);this._files=[];this._xhrs=[];this._loaded=[];};qq.UploadHandlerXhr.isSupported=function(){var input=document.createElement('input');input.type='file';return('multiple'in input&&typeof File!="undefined"&&typeof(new XMLHttpRequest()).upload!="undefined");};qq.extend(qq.UploadHandlerXhr.prototype,qq.UploadHandlerAbstract.prototype)
qq.extend(qq.UploadHandlerXhr.prototype,{add:function(file){if(!(file instanceof File)){throw new Error('Passed obj in not a File (in qq.UploadHandlerXhr)');}
return this._files.push(file)-1;},getName:function(id){var file=this._files[id];return file.fileName!=null?file.fileName:file.name;},getSize:function(id){var file=this._files[id];return file.fileSize!=null?file.fileSize:file.size;},getLoaded:function(id){return this._loaded[id]||0;},_upload:function(id,params){var file=this._files[id],name=this.getName(id),size=this.getSize(id);this._loaded[id]=0;var xhr=this._xhrs[id]=new XMLHttpRequest();var self=this;xhr.upload.onprogress=function(e){if(e.lengthComputable){self._loaded[id]=e.loaded;self._options.onProgress(id,name,e.loaded,e.total);}};xhr.onreadystatechange=function(){if(xhr.readyState==4){self._onComplete(id,xhr);}};params=params||{};params['qqfile']=name;var queryString=qq.obj2url(params,this._options.action);xhr.open("POST",queryString,true);xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.setRequestHeader("X-File-Name",encodeURIComponent(name));xhr.setRequestHeader("Content-Type","application/octet-stream");xhr.send(file);},_onComplete:function(id,xhr){if(!this._files[id])return;var name=this.getName(id);var size=this.getSize(id);this._options.onProgress(id,name,size,size);if(xhr.status==200){this.log("xhr - server response received");this.log("responseText = "+xhr.responseText);var response;try{response=eval("("+xhr.responseText+")");}catch(err){response={};}
this._options.onComplete(id,name,response);}else{this._options.onComplete(id,name,{});}
this._files[id]=null;this._xhrs[id]=null;this._dequeue(id);},_cancel:function(id){this._options.onCancel(id,this.getName(id));this._files[id]=null;if(this._xhrs[id]){this._xhrs[id].abort();this._xhrs[id]=null;}}});;GAL.view.AlbumItems=function(config){config=config||{};this._initTemplates();Ext.applyIf(config,{url:GAL.config.connector_url,fields:['id','album','name','description','mediatype','url','createdon','createdby','filename','filesize','thumbnail','image','image_width','image_height','tags','active','rank','absoluteImage','relativeImage','menu'],ident:'galbit',id:'gal-album-items-view',baseParams:{action:'mgr/item/getList',album:config.album},loadingText:_('loading'),tpl:this.templates.thumb,enableDD:true,multiSelect:true,itemSelector:'div.modx-browser-thumb-wrap',listeners:{'selectionchange':{fn:this.showDetails,scope:this,buffer:100},'dblclick':config.onSelect||{fn:Ext.emptyFn,scope:this}},prepareData:this.formatData.createDelegate(this)});GAL.view.AlbumItems.superclass.constructor.call(this,config);this.on('selectionchange',this.showDetails,this,{buffer:100});this.addEvents('sort','select');this.on('sort',this.onSort,this);this.on('dblclick',this.onDblClick,this);};Ext.extend(GAL.view.AlbumItems,MODx.DataView,{templates:{},windows:{},onSort:function(o){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/item/sort',album:this.config.album,source:o.source.id,target:o.target.id}});},onDblClick:function(d,idx,n){var node=this.getSelectedNodes()[0];if(!node)return false;if(this.config.inPanel){this.cm.activeNode=node;this.updateItem(node,n);}else{var data=this.lookup[node.id];this.fireEvent('select',data);}},updateItem:function(btn,e){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;this.windows.updateItem=MODx.load({xtype:'gal-window-item-update',listeners:{'success':{fn:function(){this.store.reload();},scope:this}}});this.windows.updateItem.setValues(data);this.windows.updateItem.show(e.target);},setAsCover:function(btn,e){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/album/setCoverItem',id:data.id,albumid:data.album},listeners:{'success':{fn:function(r){var panel=Ext.getCmp('gal-panel-album');panel.getForm().setValues(r.object);},scope:this}}});},deleteItem:function(btn,e){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;MODx.msg.confirm({text:_('gallery.item_delete_confirm'),url:this.config.url,params:{action:'mgr/item/remove',id:data.id},listeners:{'success':{fn:function(r){this.store.reload();},scope:this}}});},deleteMultiple:function(btn,e){var recs=this.getSelectedRecords();if(!recs)return false;var ids='';for(var i=0;i<recs.length;i++){ids+=','+recs[i].id;}
MODx.msg.confirm({text:_('gallery.item_delete_multiple_confirm'),url:this.config.url,params:{action:'mgr/item/removeMultiple',ids:ids.substr(1)},listeners:{'success':{fn:function(r){this.store.reload();},scope:this}}});return true;},run:function(p){p=p||{};var v={};Ext.apply(v,this.store.baseParams);Ext.apply(v,p);this.pagingBar.changePage(1);this.store.baseParams=v;this.store.load();},sortBy:function(sel){this.store.baseParams.sorter=sel.getValue();this.store.reload();return true;},sortDir:function(sel){this.store.baseParams.dir=sel.getValue();this.store.reload();},showDetails:function(){var selNode=this.getSelectedNodes();var detailEl=Ext.getCmp('gal-album-items-detail').body;if(selNode&&selNode.length>0){selNode=selNode[0];var data=this.lookup[selNode.id];if(data){detailEl.hide();this.templates.details.overwrite(detailEl,data);detailEl.slideIn('l',{stopFx:true,duration:'.2'});}}else{detailEl.update('');}},formatData:function(data){var formatSize=function(data){if(data.size<1024){return data.size+' '+_('gallery.bytes');}else{return(Math.round(((data.size*10)/1024))/10)+" KB";}};data.shortName=Ext.util.Format.ellipsis(data.name,16);data.sizeString=formatSize(data);data.releasedon=new Date(data.releasedon).format("m/d/Y g:i a");this.lookup['gal-item-'+data.id]=data;return data;},_initTemplates:function(){this.templates.thumb=new Ext.XTemplate('<tpl for=".">','<div class="modx-browser-thumb-wrap modx-pb-thumb-wrap <tpl if="!active">gal-item-inactive</tpl>" id="gal-item-{id}">','<div class="modx-browser-thumb gal-item-thumb">','<img src="{thumbnail}" title="{name}" />','</div>','<span>{shortName}</span>','</div>','</tpl>');this.templates.thumb.compile();this.templates.details=new Ext.XTemplate('<div class="details">','<tpl for=".">','<div class="modx-browser-detail-thumb modx-pb-detail-thumb"><img src="{image}" alt="{shortName}" onclick="Ext.getCmp(\'gal-album-items-view\').showScreenshot(\'{id}\'); return false;" /></div>','<div class="modx-browser-details-info modx-pb-details-info">','<span class="gal-detail-active">','<tpl if="active"><span class="green">'+_('gallery.active')+'</span></tpl>','<tpl if="!active"><span class="red">'+_('gallery.inactive')+'</span></tpl>','</span>','<h4>{shortName}</h4><br />','<tpl if="description"><p>{description}</p><br /></tpl>','<b>'+_('id')+':</b><span>{id}</span>','<b>'+_('gallery.file_name')+':</b><span>{filename}</span>','<b>'+_('gallery.file_size')+':</b><span>{filesize}</span>','<tpl if="tags"><b>'+_('gallery.tags')+':</b><span>{tags}</span></tpl>','<tpl if="url"><b>'+_('gallery.item_url')+':</b><span>{url}</span></tpl>','</div>','</tpl>','</div>');this.templates.details.compile();},showScreenshot:function(id){var data=this.lookup['gal-item-'+id];if(!data)return false;if(!this.ssWin){this.ssWin=new Ext.Window({layout:'fit',width:600,height:450,closeAction:'hide',plain:true,items:[{id:'gal-item-ss',html:''}],buttons:[{text:_('close'),handler:function(){this.ssWin.hide();},scope:this}]});}
this.ssWin.show();this.ssWin.setSize(data.image_width,data.image_height);this.ssWin.center();this.ssWin.setTitle(data.name);Ext.get('gal-item-ss').update('<img src="'+data.image+'" alt="" onclick="Ext.getCmp(\'gal-album-items-view\').ssWin.hide();" />');},_showContextMenu:function(v,i,n,e){e.preventDefault();var data=this.lookup[n.id];var m=this.cm;m.removeAll();var ct=this.getSelectionCount();if(ct==1){m.add({text:_('gallery.item_update'),handler:this.updateItem,scope:this});m.add({text:_('gallery.set_as_cover'),handler:this.setAsCover,scope:this});m.add('-');m.add({text:_('gallery.item_delete'),handler:this.deleteItem,scope:this});m.show(n,'tl-c?');}else if(ct>1){m.add({text:_('gallery.item_delete_multiple'),handler:this.deleteMultiple,scope:this});m.show(n,'tl-c?');}
m.activeNode=n;}});Ext.reg('gal-view-album-items',GAL.view.AlbumItems);;GAL.panel.Album=function(config){config=config||{};Ext.apply(config,{id:'gal-panel-album',url:GAL.config.connector_url,baseParams:{},border:false,baseCls:'modx-formpanel',cls:'container form-with-labels',items:[{html:'<h2>'+_('gallery.album')+'</h2>',border:false,id:'gal-album-header',cls:'modx-page-header'},{xtype:'modx-tabs',defaults:{border:false,autoHeight:true},border:true,activeItem:0,hideMode:'offsets',items:[{title:_('general_information'),border:false,items:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,cls:'main-wrapper',labelSeparator:''},items:[{columnWidth:.6,items:[{xtype:'hidden',fieldLabel:_('id'),name:'id',submitValue:true},{xtype:'textfield',fieldLabel:_('name'),name:'name',anchor:'100%',allowBlank:false},{xtype:'textfield',fieldLabel:_('gallery.year'),name:'year',anchor:'100%',allowBlank:true},{xtype:'textarea',fieldLabel:_('description'),name:'description',anchor:'100%'},{layout:'column',border:false,fieldLabel:_('gallery.cover_filename'),items:[{xtype:'textfield',name:'cover_filename',id:'cover_filename',readOnly:true,allowBlank:true,columnWidth:.6},{xtype:'hidden',name:'cover_filename_url',id:'cover_filename_url'},{xtype:'button',text:_('gallery.upload_cover'),cls:'primary-button',handler:this.updateCover},{xtype:'button',text:_('gallery.delete_cover'),handler:function(){var panel=Ext.getCmp('gal-panel-album').getForm();panel.findField('cover_filename').setValue('');panel.findField('cover_filename_url').setValue('');}}]}]},{columnWidth:.4,items:[{xtype:'checkbox',boxLabel:_('gallery.active'),description:MODx.expandHelp?'':_('gallery.active_desc'),id:'gallery-album-active',name:'active',hideLabel:true,inputValue:true},{xtype:MODx.expandHelp?'label':'hidden',forId:'gallery-album-active',text:_('gallery.active_desc'),cls:'desc-under'},{xtype:'checkbox',boxLabel:_('gallery.prominent'),description:MODx.expandHelp?'':_('gallery.prominent_desc'),id:'gallery-album-prominent',name:'prominent',hideLabel:true,inputValue:true},{xtype:MODx.expandHelp?'label':'hidden',forId:'gallery-album-prominent',text:_('gallery.prominent_desc'),cls:'desc-under'}]}]},{html:'<hr />',border:false},{xtype:'gal-panel-album-items',cls:'modx-pb-view-ct main-wrapper',album:config.album,anchor:'100%'}]}]}],listeners:{'setup':{fn:this.setup,scope:this},'beforeSubmit':{fn:this.beforeSubmit,scope:this},'success':{fn:this.success,scope:this}}});GAL.panel.Album.superclass.constructor.call(this,config);};Ext.extend(GAL.panel.Album,MODx.FormPanel,{initialized:false,windows:{},setup:function(){if(!this.config.album||this.initialized)return;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/album/get',id:this.config.album},listeners:{'success':{fn:function(r){this.getForm().setValues(r.object);Ext.getCmp('gal-album-header').getEl().update('<h2>'+_('gallery.album')+': '+r.object.name+'</h2>');this.initialized=true;},scope:this}}});},beforeSubmit:function(o){Ext.apply(o.form.baseParams,{});},updateCover:function(btn,e){var form=this.findParentByType('gal-panel-album');var data=form.getForm().getValues();form.windows.updateCover=MODx.load({xtype:'gal-window-cover-update',listeners:{'success':function(o){if(o.a.result.object){var panel=Ext.getCmp('gal-panel-album');panel.getForm().setValues(o.a.result.object);}
this.close();}}});form.windows.updateCover.setValues(data);var previewDivName=form.windows.updateCover.ident+'-preview';var preview=form.windows.updateCover.find('id',previewDivName);if(preview.length>0){if(data.cover_filename_url!=''){var now=new Date();preview[0].html='<img src="'+data.cover_filename_url+'&time='+now.getTime()+'"/>';}else{preview[0].setVisible(false);}}
form.windows.updateCover.show(e.target);},success:function(o){Ext.getCmp('gal-btn-save').setDisabled(false);}});Ext.reg('gal-panel-album',GAL.panel.Album);GAL.panel.AlbumItems=function(config){config=config||{};this.view=MODx.load({id:'gal-album-items-view',xtype:'gal-view-album-items',onSelect:{fn:function(){},scope:this},containerScroll:true,ident:this.ident,cls:'gal-view-album-items',album:config.album,inPanel:true,style:'overflow: auto;'});this.view.pagingBar=new Ext.PagingToolbar({pageSize:config.pageSize||(parseInt(MODx.config.default_per_page)||24),store:this.view.store,displayInfo:true,autoLoad:true,items:['-',_('per_page')+':',{xtype:'textfield',value:config.pageSize||(parseInt(MODx.config.default_per_page)||20),width:40,listeners:{'change':{fn:function(tf,nv,ov){if(Ext.isEmpty(nv))return false;nv=parseInt(nv);this.view.pagingBar.pageSize=nv;this.view.store.load({params:{start:0,limit:nv}});},scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:function(){this.fireEvent('change',this.getValue());this.blur();return true;},scope:cmp});},scope:this}}},'-']});var dv=this.view;dv.on('render',function(){dv.dragZone=new MODx.DataView.dragZone(dv);dv.dropZone=new MODx.DataView.dropZone(dv);});Ext.applyIf(config,{id:'gal-panel-album-items',cls:'browser-win',layout:'column',minWidth:500,minHeight:350,autoHeight:true,modal:false,closeAction:'hide',border:false,autoScroll:true,items:[{id:'gal-album-items-ct',cls:'browser-view',region:'center',width:'75%',minHeight:450,autoScroll:true,border:false,items:[{xtype:'toolbar',items:[{xtype:'button',text:_('gallery.item_upload'),handler:this.uploadItem,scope:this},'-',{xtype:'button',text:_('gallery.multi_item_upload'),handler:this.uploadMultiItems,scope:this},'-',{xtype:'button',text:_('gallery.batch_upload'),handler:this.batchUpload,scope:this},'-',{xtype:'button',text:_('gallery.zip_upload'),handler:this.zipUpload,scope:this}]},this.view],bbar:[this.view.pagingBar]},{html:'',id:'gal-album-items-detail',region:'east',split:true,autoScroll:true,width:'25%',minWidth:150,height:450,border:false}]});GAL.panel.AlbumItems.superclass.constructor.call(this,config);};Ext.extend(GAL.panel.AlbumItems,MODx.Panel,{windows:{},uploadMultiItems:function(btn,e){var r={album:this.config.album,active:true};if(!this.windows.uploadMultiItems){this.windows.uploadMultiItems=MODx.load({xtype:'gal-window-multi-item-upload',album:this.config.album,listeners:{'success':{fn:function(){this.view.run();},scope:this}}});}
this.windows.uploadMultiItems.fp.getForm().reset();this.windows.uploadMultiItems.setValues(r);this.windows.uploadMultiItems.show(e.target);},uploadItem:function(btn,e){var r={album:this.config.album,active:true};if(!this.windows.uploadItem){this.windows.uploadItem=MODx.load({xtype:'gal-window-item-upload',listeners:{'success':{fn:function(){this.view.run();},scope:this}}});}
this.windows.uploadItem.fp.getForm().reset();this.windows.uploadItem.setValues(r);this.windows.uploadItem.show(e.target);},batchUpload:function(btn,e){var r={album:this.config.album,active:true};if(!this.windows.batchUpload){this.windows.batchUpload=MODx.load({xtype:'gal-window-batch-upload',listeners:{'success':{fn:function(){this.view.run();},scope:this}}});}else{this.windows.batchUpload.fp.getForm().reset();}
this.windows.batchUpload.setValues(r);this.windows.batchUpload.show(e.target);},zipUpload:function(btn,e){var r={album:this.config.album,active:true};if(!this.windows.zipUpload){this.windows.zipUpload=MODx.load({xtype:'gal-window-zip-upload',listeners:{'success':{fn:function(){this.view.run();},scope:this}}});}else{this.windows.zipUpload.fp.getForm().reset();}
this.windows.zipUpload.setValues(r);this.windows.zipUpload.show(e.target);}});Ext.reg('gal-panel-album-items',GAL.panel.AlbumItems);